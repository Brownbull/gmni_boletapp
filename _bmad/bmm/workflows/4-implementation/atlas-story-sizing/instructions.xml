<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and generate all documents in {document_output_language}</critical>

  <critical>üìè ATLAS STORY SIZING - Validate and Split Oversized Stories!</critical>
  <critical>This workflow analyzes existing stories for context window fit and splits oversized ones</critical>
  <critical>Lesson: Story 14c-refactor.22a taught us that oversized stories exhaust context windows mid-development</critical>

  <!-- AGENT PERSONA LOADING - CRITICAL FOR QUALITY -->
  <agent-loading>
    <critical>üóìÔ∏è LOAD SM (SCRUM MASTER) AGENT PERSONA FOR STORY SIZING EXPERTISE</critical>
    <action>Load and embody: {project-root}/_bmad/bmm/agents/sm.md</action>
    <action>Extract and apply:
      - persona.role: Scrum Master - story sizing and sprint planning expert
      - persona.identity: Deep understanding of story complexity, dev capacity, sprint velocity
      - persona.communication_style: Supportive but rigorous, data-driven
      - persona.principles: Stories must be sized to complete in one development cycle
      - memories: Project-specific sizing patterns, past split decisions
    </action>
    <action>Apply SM agent's sizing expertise - focus on practical development capacity</action>
  </agent-loading>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 0: Atlas Initialization                                            -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="0" goal="Initialize Atlas Integration">
    <action>Check if Atlas memory file exists at {atlas_memory}</action>

    <check if="Atlas memory file exists">
      <action>Load Atlas memory: {atlas_memory}</action>
      <action>Load sizing lessons from Section 6 (Lessons Learned) if available</action>
      <action>Set {{atlas_enabled}} = true</action>
      <output>üó∫Ô∏è **Atlas Integration Active**

        Atlas will capture sizing decisions and lessons for future reference.
        Previous sizing lessons loaded: {{sizing_lessons_count}}
      </output>
    </check>

    <check if="Atlas memory file does NOT exist">
      <action>Set {{atlas_enabled}} = false</action>
      <output>‚ÑπÔ∏è Atlas not installed - running standard story sizing workflow.

        To enable Atlas lesson capture, install Atlas agent at:
        `_bmad/agents/atlas/`
      </output>
    </check>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 1: Select Stories to Analyze                                       -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="1" goal="Select stories to analyze for sizing">
    <note>Stories can be analyzed individually or in batch from sprint status</note>

    <check if="{{story_path}} is provided by user">
      <action>Load single story from provided path</action>
      <action>Set {{analysis_mode}} = "single"</action>
      <action>GOTO step 2</action>
    </check>

    <action>Check if {{sprint_status}} file exists</action>
    <check if="sprint status file does NOT exist">
      <output>üö´ No sprint status file found and no story specified</output>
      <output>
        **Required Options:**
        1. Run `sprint-planning` to initialize sprint tracking
        2. Provide specific story path to analyze (e.g., "docs/sprint-artifacts/epic14c-refactor/stories/14c-refactor-22.md")
        3. Provide story key to analyze (e.g., "14c-refactor-22")
      </output>
      <ask>Choose option [1], [2], [3], or [X] to exit:</ask>

      <check if="user chooses X">
        <output>Workflow exited. No changes made.</output>
        <action>EXIT workflow gracefully</action>
      </check>

      <check if="user chooses 2 or 3">
        <ask>Please provide the story path or key:</ask>
        <action>Parse input and locate story file</action>
        <action>Set {{analysis_mode}} = "single"</action>
        <action>GOTO step 2</action>
      </check>
    </check>

    <!-- Load sprint status for batch analysis -->
    <critical>MUST read COMPLETE {sprint_status} file from start to end</critical>
    <action>Load the FULL file: {{sprint_status}}</action>
    <action>Find ALL stories with status = "ready-for-dev" OR "drafted"</action>
    <action>Set {{candidate_stories}} = list of story keys</action>
    <action>Set {{candidate_count}} = count of stories found</action>

    <check if="{{candidate_count}} == 0">
      <output>No stories found with status "ready-for-dev" or "drafted".

        All stories are either in backlog, in-progress, or done.
      </output>
      <ask>Would you like to analyze a specific story by path? [Y/N/X to exit]</ask>

      <check if="user chooses X or N">
        <output>Workflow exited. No changes made.</output>
        <action>EXIT workflow gracefully</action>
      </check>

      <check if="user chooses Y">
        <ask>Please provide the story path:</ask>
        <action>Parse input and locate story file</action>
        <action>Set {{analysis_mode}} = "single"</action>
        <action>GOTO step 2</action>
      </check>
    </check>

    <output>üìã **Found {{candidate_count}} stories to analyze:**

      {{candidate_stories_list}}
    </output>

    <ask>
      Select analysis mode:
      1. **Analyze all** - Check all {{candidate_count}} stories for sizing issues
      2. **Select specific** - Choose which stories to analyze
      3. **Single story** - Analyze one specific story by key
      X. **Exit** workflow

      Choose [1], [2], [3], or [X]:
    </ask>

    <check if="user chooses X">
      <output>Workflow exited. No changes made.</output>
      <action>EXIT workflow gracefully</action>
    </check>

    <check if="user chooses 1">
      <action>Set {{analysis_mode}} = "batch"</action>
      <action>Set {{stories_to_analyze}} = {{candidate_stories}}</action>
    </check>

    <check if="user chooses 2">
      <ask>Enter story keys to analyze (comma-separated):</ask>
      <action>Parse user input into {{stories_to_analyze}}</action>
      <action>Set {{analysis_mode}} = "batch"</action>
    </check>

    <check if="user chooses 3">
      <ask>Enter story key to analyze:</ask>
      <action>Set {{stories_to_analyze}} = [user_input]</action>
      <action>Set {{analysis_mode}} = "single"</action>
    </check>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 2: Load and Parse Story Content                                    -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="2" goal="Load and parse story content for analysis">
    <critical>üî¨ EXHAUSTIVE STORY ANALYSIS</critical>

    <action>For each story in {{stories_to_analyze}}:</action>
    <action>  1. Locate story file using story key pattern</action>
    <action>  2. Load complete story file content</action>
    <action>  3. Parse sections: Tasks/Subtasks, Dev Notes, Acceptance Criteria</action>
    <action>  4. Extract metrics:</action>
    <action>     - task_count: Number of top-level tasks (lines starting with "- [ ] Task")</action>
    <action>     - subtask_count: Total subtasks across all tasks (nested "- [ ]" items)</action>
    <action>     - file_count: Estimated files from Dev Notes or task descriptions</action>
    <action>     - complexity_indicators: Test requirements, architectural changes, dependencies</action>

    <action>Set {{story_metrics}} = collected metrics for all stories</action>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 3: Apply Sizing Analysis                                           -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="3" goal="Apply sizing heuristics and classify stories">
    <critical>üìè CONTEXT WINDOW SIZING - Same logic as atlas-create-story Step 5b</critical>
    <critical>Lesson from Story 14c-refactor.22a: Stories with >3 complex tasks exhaust context windows</critical>

    <note>
      **Sizing Guidelines:**
      - **SMALL (1 pt):** 1-2 tasks, ‚â§5 subtasks total, ‚â§2 files
      - **MEDIUM (2-3 pts):** 2-3 tasks, ‚â§10 subtasks total, ‚â§4 files
      - **LARGE (5 pts):** 3-4 tasks, ‚â§15 subtasks total, ‚â§8 files
      - **TOO LARGE (needs split):** >4 tasks OR >15 subtasks OR >8 files
    </note>

    <action>For each story in {{story_metrics}}:</action>
    <action>  Apply sizing classification based on metrics</action>
    <action>  Set {{story_size}} = SMALL | MEDIUM | LARGE | TOO_LARGE</action>

    <action>Categorize results:</action>
    <action>  {{ok_stories}} = stories classified as SMALL or MEDIUM</action>
    <action>  {{warning_stories}} = stories classified as LARGE</action>
    <action>  {{critical_stories}} = stories classified as TOO_LARGE</action>

    <output>
      üìä **Sizing Analysis Complete**

      **Summary:**
      - ‚úÖ OK (SMALL/MEDIUM): {{ok_count}} stories
      - ‚ö†Ô∏è WARNING (LARGE): {{warning_count}} stories
      - ‚ùå CRITICAL (TOO_LARGE): {{critical_count}} stories

      {{sizing_results_table}}
    </output>

    <check if="{{critical_count}} == 0 AND {{warning_count}} == 0">
      <output>‚úÖ **All stories are properly sized!**

        No stories require splitting. All are within context window capacity.
      </output>
      <action>GOTO step 6</action>
    </check>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 4: Present Split Recommendations                                   -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="4" goal="Present split recommendations for oversized stories">
    <critical>üîÑ SPLIT RECOMMENDATION ENGINE</critical>

    <check if="{{critical_count}} > 0">
      <output>
        ‚ùå **CRITICAL: {{critical_count}} stories REQUIRE splitting before development**

        These stories will exhaust the dev agent's context window mid-implementation:

        {{critical_stories_details}}
      </output>
    </check>

    <check if="{{warning_count}} > 0">
      <output>
        ‚ö†Ô∏è **WARNING: {{warning_count}} stories are at capacity**

        These stories are at the upper limit and may benefit from splitting:

        {{warning_stories_details}}
      </output>
    </check>

    <action>For each oversized story, generate split recommendations:</action>
    <action>  1. Analyze task groupings for natural split points</action>
    <action>  2. Suggest split strategy (by_layer, by_feature, by_phase, by_file)</action>
    <action>  3. Calculate metrics for proposed sub-stories</action>

    <output>
      **Recommended Splits:**

      {{split_recommendations}}
    </output>

    <ask>
      How would you like to proceed?
      1. **Auto-split all** - Apply recommended splits to all oversized stories
      2. **Review each** - Interactively review and approve each split
      3. **Skip warnings** - Only split CRITICAL stories, ignore warnings
      4. **Manual mode** - I'll specify my own split strategy
      X. **Exit** - Don't split anything

      Choose [1], [2], [3], [4], or [X]:
    </ask>

    <check if="user chooses X">
      <output>Workflow exited. No stories were split.</output>
      <action>GOTO step 6</action>
    </check>

    <check if="user chooses 1">
      <action>Set {{split_mode}} = "auto_all"</action>
      <action>Set {{stories_to_split}} = {{critical_stories}} + {{warning_stories}}</action>
    </check>

    <check if="user chooses 2">
      <action>Set {{split_mode}} = "interactive"</action>
      <action>GOTO step 4b</action>
    </check>

    <check if="user chooses 3">
      <action>Set {{split_mode}} = "auto_critical"</action>
      <action>Set {{stories_to_split}} = {{critical_stories}}</action>
    </check>

    <check if="user chooses 4">
      <action>Set {{split_mode}} = "manual"</action>
      <action>GOTO step 4c</action>
    </check>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 4b: Interactive Split Review                                       -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="4b" goal="Interactive review of each split recommendation">
    <action>For each story in ({{critical_stories}} + {{warning_stories}}):</action>

    <output>
      **Story: {{current_story_key}}**

      **Current Metrics:**
      | Metric | Value | Guideline | Status |
      |--------|-------|-----------|--------|
      | Tasks | {{task_count}} | ‚â§4 | {{task_status}} |
      | Subtasks | {{subtask_count}} | ‚â§15 | {{subtask_status}} |
      | Files | {{file_count}} | ‚â§8 | {{file_status}} |

      **Recommended Split Strategy: {{recommended_strategy}}**

      {{split_preview}}
    </output>

    <ask>
      Action for {{current_story_key}}:
      1. **Accept** - Apply this split
      2. **Modify** - Adjust the split strategy
      3. **Skip** - Don't split this story
      4. **Custom** - Define my own split
      X. **Exit** - Stop reviewing, proceed with accepted splits

      Choose [1], [2], [3], [4], or [X]:
    </ask>

    <check if="user chooses 1">
      <action>Add story to {{approved_splits}} with recommended strategy</action>
      <action>Continue to next story</action>
    </check>

    <check if="user chooses 2">
      <ask>Which split strategy? [by_layer/by_feature/by_phase/by_file]</ask>
      <action>Regenerate split preview with selected strategy</action>
      <action>Redisplay for approval</action>
    </check>

    <check if="user chooses 3">
      <action>Skip this story, continue to next</action>
    </check>

    <check if="user chooses 4">
      <ask>Describe your split approach (which tasks go in which sub-story):</ask>
      <action>Parse custom split definition</action>
      <action>Add to {{approved_splits}} with custom strategy</action>
    </check>

    <check if="user chooses X">
      <action>Set {{stories_to_split}} = {{approved_splits}}</action>
      <action>GOTO step 5</action>
    </check>

    <action>After all stories reviewed, set {{stories_to_split}} = {{approved_splits}}</action>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 4c: Manual Split Mode                                              -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="4c" goal="Manual split specification">
    <output>
      **Manual Split Mode**

      Oversized stories to consider:
      {{oversized_stories_list}}
    </output>

    <ask>Which story would you like to split? (enter story key or [done] when finished)</ask>

    <check if="user says done">
      <action>GOTO step 5</action>
    </check>

    <action>Load selected story details</action>
    <output>
      **Story: {{selected_story_key}}**

      **Tasks:**
      {{task_list_numbered}}
    </output>

    <ask>How many sub-stories to create? [2-5]</ask>
    <action>For each sub-story, ask:</action>
    <ask>Sub-story {{n}} name and which tasks (by number):</ask>

    <action>Build custom split definition from user input</action>
    <action>Add to {{stories_to_split}}</action>
    <action>Ask if user wants to split another story</action>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 5: Execute Splits and Create New Stories                           -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="5" goal="Execute splits and create new story files">
    <critical>üìù CREATING SPLIT STORY FILES</critical>

    <check if="{{stories_to_split}} is empty">
      <output>No stories selected for splitting.</output>
      <action>GOTO step 6</action>
    </check>

    <action>For each story in {{stories_to_split}}:</action>
    <action>  1. Generate sub-story keys using letter suffix (e.g., 22 ‚Üí 22a, 22b, 22c)</action>
    <action>  2. Create new story files from template</action>
    <action>  3. Distribute tasks according to split strategy</action>
    <action>  4. Copy relevant Dev Notes and Acceptance Criteria</action>
    <action>  5. Add dependency note: "Part of split from {{original_story_key}}"</action>
    <action>  6. Add cross-references between split stories</action>
    <action>  7. Mark original story as "split" or archive it</action>

    <output>
      ‚úÖ **Split Complete: {{original_story_key}}**

      **Created {{sub_story_count}} sub-stories:**
      {{created_stories_list}}

      **Original story archived/marked as split**
    </output>

    <action>After all splits complete:</action>
    <action>Set {{total_created}} = count of new stories</action>
    <action>Set {{total_archived}} = count of original stories archived</action>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 6: Update Sprint Status                                            -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="6" goal="Update sprint status with split results">
    <check if="sprint status file exists AND splits were made">
      <critical>MUST update {sprint_status} with new stories</critical>
      <action>Load the FULL file: {{sprint_status}}</action>

      <action>For each split story:</action>
      <action>  1. Update original story status to "split" or remove entry</action>
      <action>  2. Add entries for each new sub-story with status "ready-for-dev"</action>
      <action>  3. Preserve story ordering within epic</action>

      <action>Save file, preserving ALL comments and structure</action>

      <output>
        üìã **Sprint Status Updated**

        - Archived/marked as split: {{total_archived}} stories
        - Added new entries: {{total_created}} stories
      </output>
    </check>

    <check if="no splits were made">
      <output>No changes to sprint status required.</output>
    </check>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 7: Feed Atlas Memory with Lessons                                  -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="7" goal="Feed lessons learned to Atlas memory">
    <check if="{{atlas_enabled}} == true AND splits were made">
      <output>
        **üó∫Ô∏è Atlas Lesson Capture**

        Atlas can learn from this sizing analysis to improve future story creation.

        **Lesson to add to Section 6 (Lessons Learned):**
        ```
        ### Story Sizing - {{date}}

        **Stories Analyzed:** {{total_analyzed}}
        **Stories Split:** {{total_archived}}
        **New Stories Created:** {{total_created}}

        **Patterns Observed:**
        {{sizing_patterns_observed}}

        **Split Strategies Used:**
        {{strategies_used_list}}

        **Recommendation:** Stories exceeding 4 tasks / 15 subtasks / 8 files
        should be split DURING creation, not after.
        ```
      </output>

      <ask>Update Atlas memory with sizing lessons? [Y/N/X to skip]</ask>

      <check if="user chooses X or N">
        <output>Atlas memory not updated.</output>
      </check>

      <check if="user says Y">
        <action>Append lesson to Atlas memory Section 6</action>
        <action>Update Atlas Sync History table</action>
        <output>‚úÖ Atlas memory updated with sizing lessons</output>
      </check>
    </check>

    <!-- Final output -->
    <output>**üìè ATLAS STORY SIZING COMPLETE, {user_name}!**

      **Analysis Summary:**
      - Stories Analyzed: {{total_analyzed}}
      - OK (no action needed): {{ok_count}}
      - Split: {{total_archived}} ‚Üí {{total_created}} new stories
      {{atlas_status_line}}

      **Files Modified:**
      {{modified_files_list}}

      **Next Steps:**
      1. Review the split stories in their respective files
      2. Run `atlas-story-ready` to mark split stories ready for dev
      3. Prioritize sub-stories in sprint planning

      **Sizing Tip:** Consider running `atlas-create-story` instead of
      `create-story` for future stories - it includes built-in sizing checks.
    </output>
    <note>atlas_status_line: If atlas_enabled and lessons captured, show "- Atlas Lessons: ‚úÖ Captured"</note>
  </step>

</workflow>
