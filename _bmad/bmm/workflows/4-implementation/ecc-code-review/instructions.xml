<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <critical>üé≠ ECC PARALLEL CODE REVIEW - Atlas Puppeteer spawns 4 agents simultaneously!</critical>
  <critical>This workflow spawns code-reviewer, security-reviewer, architect, and tdd-guide IN PARALLEL</critical>
  <critical>CRITICAL: Use a SINGLE message with MULTIPLE Task calls for true parallelism</critical>

  <!-- ATLAS PUPPETEER PROTOCOL -->
  <puppeteer-protocol>
    <principle>Atlas is the Puppeteer - spawns 4 specialized ECC agents in parallel</principle>
    <principle>SINGLE message, MULTIPLE Task calls = true parallel execution</principle>
    <principle>Collect all outputs, then synthesize with workflow chain analysis</principle>
    <principle>Resolve conflicts between agent recommendations</principle>
    <principle>Feed learnings back to Atlas memory</principle>

    <parallel-team>
      | Agent | subagent_type | Focus Area |
      |-------|---------------|------------|
      | Code Reviewer | everything-claude-code:code-reviewer | Quality, maintainability |
      | Security Reviewer | everything-claude-code:security-reviewer | OWASP, vulnerabilities |
      | Architect | everything-claude-code:architect | Patterns, design |
      | TDD Guide | everything-claude-code:tdd-guide | Test coverage, TDD |
    </parallel-team>
  </puppeteer-protocol>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 0: Atlas Initialization                                            -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="0" goal="Initialize Atlas and load context for ECC agents">
    <check if="{atlas_index} exists">
      <action>Load {atlas_index} to identify relevant fragments</action>
      <action>Load {atlas_knowledge}/04-architecture.md for patterns</action>
      <action>Load {atlas_knowledge}/05-testing.md for test standards</action>
      <action>Store as {{atlas_context}} for ECC agents</action>

      <output>üó∫Ô∏è **Atlas Puppeteer Initialized for Parallel Review**

        Context loaded for 4 parallel ECC agents:
        - Architecture patterns: {{architecture_summary}}
        - Testing standards: {{testing_summary}}

        Ready to spawn parallel review team.
      </output>
    </check>

    <check if="{atlas_index} does NOT exist">
      <action>Set {{atlas_context}} = "No Atlas context"</action>
      <output>‚ÑπÔ∏è Atlas not configured - ECC agents will use default patterns</output>
    </check>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 1: Load Story and Discover Changes                                 -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="1" goal="Load story and discover files to review">
    <action>Use provided {{story_path}} or ask user which story to review</action>
    <action>Read COMPLETE story file</action>
    <action>Extract {{story_key}} from filename</action>
    <action>Parse sections: Acceptance Criteria, Tasks, File List</action>

    <!-- ARCHITECTURE ENFORCEMENT: Extract architectural ACs -->
    <critical>üèóÔ∏è ARCHITECTURE ENFORCEMENT: Extract architectural ACs for validation</critical>
    <action>Parse "Architectural Acceptance Criteria" section from story</action>
    <action>Extract {{architectural_acs}} - all architectural ACs</action>
    <action>Extract {{file_specification_table}} from "File Specification" section</action>
    <action>Identify {{feature_name}} from story context</action>

    <action>Extract {{architecture_reference}} - source of architectural patterns</action>

    <check if="architectural ACs found">
      <output>üèóÔ∏è **Architectural ACs Loaded for Review**

        **Architecture Source:** {{architecture_reference}}

        - File Location ACs: {{file_location_ac_count}}
        - Pattern ACs: {{pattern_ac_count}}
        - Anti-Pattern ACs: {{antipattern_ac_count}}

        Architecture agent will validate against documented patterns.
      </output>
    </check>

    <check if="NO architectural ACs found">
      <action>Set {{architectural_acs}} = "No architectural ACs specified in story"</action>
      <output>‚ö†Ô∏è **Warning: No Architectural ACs in Story**

        This story lacks architectural acceptance criteria from documented architecture.
        Architecture review will flag any obvious pattern violations but cannot
        validate against specific documented patterns.

        **Recommendation:** Re-create story using `ecc-create-story` to generate
        ACs from architecture documentation.
      </output>
    </check>

    <!-- Git discovery -->
    <check if="git repository exists">
      <action>Run `git status --porcelain` to find uncommitted changes</action>
      <action>Run `git diff --name-only` to see modified files</action>
      <action>Compile {{files_to_review}} from git + story File List</action>
    </check>

    <output>üìã **Review Target Identified**

      Story: {{story_key}}
      Files to review: {{file_count}}
      Functional ACs to validate: {{functional_ac_count}}
      Architectural ACs to validate: {{arch_ac_count}}
    </output>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 2: PARALLEL ECC REVIEW - 4 Agents Simultaneously                   -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="2" goal="Spawn 4 ECC agents in parallel for comprehensive review">
    <critical>üé≠ ATLAS PUPPETEER: Spawning 4 ECC agents IN PARALLEL</critical>
    <critical>CRITICAL: Send ALL 4 Task calls in a SINGLE message for true parallelism!</critical>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- EXPLICIT PARALLEL EXECUTION DIRECTIVE                                   -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <parallel-execution-rule>
      üö® HOW TO ACHIEVE TRUE PARALLELISM:

      You MUST issue ALL 4 Task tool invocations in your NEXT SINGLE RESPONSE.

      ‚ùå WRONG (Sequential - slow):
         Response 1: Task(code-reviewer) ‚Üí wait ‚Üí result
         Response 2: Task(security-reviewer) ‚Üí wait ‚Üí result
         Response 3: Task(architect) ‚Üí wait ‚Üí result
         Response 4: Task(tdd-guide) ‚Üí wait ‚Üí result

      ‚úÖ CORRECT (Parallel - fast):
         Response 1: Task(code-reviewer) + Task(security-reviewer) + Task(architect) + Task(tdd-guide)
         ‚Üí All 4 run simultaneously ‚Üí All 4 results returned together

      IN YOUR NEXT MESSAGE, you must include FOUR separate Task tool calls.
      Do NOT wait for one to finish before calling the next.
      Issue all four in the same response block.
    </parallel-execution-rule>

    <output>üé≠ **Spawning Parallel Review Team...**

      Agents launching simultaneously:
      1. üîç Code Reviewer - Quality and maintainability
      2. üîí Security Reviewer - OWASP and vulnerabilities
      3. üèóÔ∏è Architect - Patterns and design compliance
      4. üß™ TDD Guide - Test coverage and quality

      Waiting for all agents to complete...
    </output>

    <!-- PARALLEL SPAWN - ALL IN ONE MESSAGE -->
    <ecc-parallel-spawn>
      <!-- Task 1: Code Reviewer -->
      <task-call id="code_review">
        subagent_type: "everything-claude-code:code-reviewer"
        description: "Code quality review for {{story_key}}"
        prompt: |
          ## Code Review Task

          **Story:** {{story_key}}

          **Files to Review:**
          {{files_to_review}}

          **Acceptance Criteria:**
          {{acceptance_criteria}}

          **Atlas Context:**
          {{atlas_context}}

          **Review Checklist:**
          1. Code quality and readability
          2. Error handling completeness
          3. Performance considerations
          4. Naming conventions
          5. DRY principle compliance
          6. Complexity analysis
          7. Documentation quality

          **Output Format:**
          ```
          ## Code Review Findings

          ### HIGH Severity
          - [Finding]: [Description] [file:line]

          ### MEDIUM Severity
          - [Finding]: [Description] [file:line]

          ### LOW Severity
          - [Finding]: [Description] [file:line]

          ### Summary
          - Total issues: X
          - Recommendation: APPROVE / CHANGES REQUESTED
          ```
      </task-call>

      <!-- Task 2: Security Reviewer -->
      <task-call id="security_review">
        subagent_type: "everything-claude-code:security-reviewer"
        description: "Security review for {{story_key}}"
        prompt: |
          ## Security Review Task

          **Story:** {{story_key}}

          **Files to Review:**
          {{files_to_review}}

          **Security Checklist (OWASP Top 10):**
          1. Injection vulnerabilities (SQL, command, XSS)
          2. Broken authentication
          3. Sensitive data exposure
          4. XML external entities (XXE)
          5. Broken access control
          6. Security misconfiguration
          7. Cross-site scripting (XSS)
          8. Insecure deserialization
          9. Using components with known vulnerabilities
          10. Insufficient logging and monitoring

          **Additional Checks:**
          - Hardcoded secrets (API keys, passwords, tokens)
          - Input validation
          - Output encoding
          - CSRF protection
          - Rate limiting

          **Output Format:**
          ```
          ## Security Review Findings

          ### CRITICAL
          - [Vulnerability]: [Description] [file:line] [REMEDIATION]

          ### HIGH
          - [Vulnerability]: [Description] [file:line] [REMEDIATION]

          ### MEDIUM
          - [Vulnerability]: [Description] [file:line] [REMEDIATION]

          ### Summary
          - Vulnerabilities found: X
          - Secrets detected: Y/N
          - Recommendation: APPROVE / BLOCK / CHANGES REQUESTED
          ```
      </task-call>

      <!-- Task 3: Architect -->
      <task-call id="architecture_review">
        subagent_type: "everything-claude-code:architect"
        description: "Architecture review for {{story_key}}"
        prompt: |
          ## Architecture Review Task

          **Story:** {{story_key}}

          **Files to Review:**
          {{files_to_review}}

          **Atlas Architecture Patterns:**
          {{atlas_context}}

          **Architectural Acceptance Criteria (from story):**
          {{architectural_acs}}

          **Expected File Specification (from story):**
          {{file_specification_table}}

          ---

          ## üö® CRITICAL: Documented Architecture Compliance Check

          **Architecture Source:** {{architecture_reference}}

          **This review MUST validate compliance with DOCUMENTED architectural patterns.**
          Do not use hardcoded assumptions - validate against what's documented.

          ### 1. File Location Compliance (per documented patterns)

          **Documented File Location Requirements:**
          {{file_location_acs}}

          For EACH new/modified file, verify it matches the documented file structure.

          **Flag as HIGH severity if:**
          - File location violates documented pattern
          - Files are scattered outside documented structure
          - File Specification in story was not followed

          ### 2. Pattern Compliance (per documented patterns)

          **Documented Pattern Requirements:**
          {{pattern_acs}}

          For each pattern requirement from documentation, verify compliance.

          **Flag as HIGH severity if:**
          - Implementation deviates from documented patterns
          - Patterns not specified in architecture docs were introduced

          ### 3. Anti-Pattern Compliance (per documented anti-patterns)

          **Documented Anti-Patterns (must NOT occur):**
          {{antipattern_acs}}

          **Flag as HIGH severity if:**
          - Any documented anti-pattern is detected in the implementation

          ### 4. Architectural AC Validation (from story)

          **Architectural ACs from Story:**
          {{architectural_acs}}

          For EACH architectural AC, verify:
          - AC is satisfied by the implementation
          - File paths match specification
          - Patterns followed correctly

          **Flag as CRITICAL if:**
          - Architectural AC explicitly violated
          - File at completely wrong location vs specification
          - Implementation creates technical debt vs documented architecture

          ---

          **Standard Review Checklist:**
          1. Pattern compliance with documented architecture
          2. Separation of concerns
          3. Dependency management
          4. Layer violations
          5. API design consistency
          6. Data flow correctness
          7. Scalability considerations
          8. Coupling and cohesion

          **Output Format:**
          ```
          ## Architecture Review Findings

          **Architecture Source:** {{architecture_reference}}

          ### üèóÔ∏è File Location Compliance (per documented patterns)
          - Files in documented locations: X/Y
          - Location violations: [list with references to violated ACs]

          ### üìã Pattern Compliance (per documented patterns)
          - Pattern requirements met: X/Y
          - Pattern violations: [list]

          ### üö´ Anti-Pattern Compliance (per documented anti-patterns)
          - Anti-patterns detected: [list with AC references]
          - Clean: [count of checks passed]

          ### üìã Architectural AC Validation
          | AC ID | Description | Status | Notes |
          |-------|-------------|--------|-------|
          | AC-ARCH-LOC-1 | ... | ‚úÖ/‚ùå | ... |
          | AC-ARCH-PATTERN-1 | ... | ‚úÖ/‚ùå | ... |
          | AC-ARCH-NO-1 | ... | ‚úÖ/‚ùå | ... |

          ### Pattern Violations (HIGH Severity)
          - [Pattern from docs]: Expected [X], Found [Y] [file:line]

          ### Design Issues
          - [Issue]: [Description] [RECOMMENDATION]

          ### Drift from Documented Architecture
          - [Drift]: [Description] [IMPACT] [Source: architecture_reference]

          ### Summary
          - File location compliance: X%
          - Pattern compliance: X%
          - Anti-pattern compliance: X%
          - Architectural ACs: X/Y passed
          - Architecture alignment: ALIGNED WITH DOCS / DRIFT DETECTED
          - Recommendation: APPROVE / CHANGES REQUESTED / BLOCKED
          ```
      </task-call>

      <!-- Task 4: TDD Guide -->
      <task-call id="test_review">
        subagent_type: "everything-claude-code:tdd-guide"
        description: "Test review for {{story_key}}"
        prompt: |
          ## Test Coverage Review Task

          **Story:** {{story_key}}

          **Files to Review:**
          {{files_to_review}}

          **Acceptance Criteria:**
          {{acceptance_criteria}}

          **Atlas Testing Patterns:**
          {{atlas_testing_patterns}}

          **Review Checklist:**
          1. Test coverage percentage
          2. AC coverage - each AC has corresponding test
          3. Edge case coverage
          4. Error scenario coverage
          5. Test quality (real assertions vs placeholders)
          6. TDD compliance (tests written first?)
          7. Test naming conventions
          8. Mock/stub appropriateness

          **Output Format:**
          ```
          ## Test Review Findings

          ### Coverage Gaps
          - [AC/Feature]: Missing test for [scenario] [file]

          ### Test Quality Issues
          - [Test]: [Issue] [file:line]

          ### Metrics
          - Estimated coverage: X%
          - ACs tested: Y/Z
          - Edge cases: covered/missing

          ### Summary
          - Test quality: GOOD / NEEDS IMPROVEMENT
          - TDD compliance: COMPLIANT / NON-COMPLIANT
          - Recommendation: APPROVE / CHANGES REQUESTED
          ```
      </task-call>
    </ecc-parallel-spawn>

    <action>Wait for all 4 agents to complete</action>
    <action>Collect outputs: {{code_review_output}}, {{security_review_output}}, {{architecture_review_output}}, {{test_review_output}}</action>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 3: Atlas Synthesis - Merge and Analyze                             -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="3" goal="Atlas synthesis of parallel review outputs">
    <critical>üó∫Ô∏è ATLAS SYNTHESIS - Merge findings, resolve conflicts, add workflow analysis</critical>
    <critical>üèóÔ∏è ARCHITECTURE GATE: Architectural violations are BLOCKING</critical>

    <action>Merge findings from all 4 agents by severity:
      - CRITICAL: Security vulnerabilities requiring immediate fix
      - HIGH: Must fix before approval (includes architectural violations)
      - MEDIUM: Should fix, can be action items
      - LOW: Nice to have improvements
    </action>

    <action>Identify conflicts between agent recommendations</action>
    <action>Add Atlas workflow chain impact analysis</action>
    <action>Calculate overall review score</action>

    <!-- ARCHITECTURE ENFORCEMENT: Highlight architectural findings -->
    <action>Extract architectural findings from architect review:
      - FSD compliance status
      - Zustand compliance status
      - Architectural AC validation results
    </action>

    <output>## üó∫Ô∏è ECC Parallel Review Synthesis

      **Story:** {{story_key}}
      **Review Date:** {date}
      **ECC Agents Used:** code-reviewer, security-reviewer, architect, tdd-guide

      ---

      ### üîç Code Quality (Code Reviewer)
      {{code_review_summary}}

      ---

      ### üîí Security (Security Reviewer)
      {{security_review_summary}}

      ---

      ### üèóÔ∏è Architecture (Architect)
      {{architecture_review_summary}}

      #### üìê Documented Architecture Compliance (MANDATORY)

      **Architecture Source:** {{architecture_reference}}

      | Check | Status | Details |
      |-------|--------|---------|
      | File Location Compliance | {{file_location_status}} | {{file_location_details}} |
      | Pattern Compliance | {{pattern_status}} | {{pattern_details}} |
      | Anti-Pattern Compliance | {{antipattern_status}} | {{antipattern_details}} |
      | Architectural ACs Passed | {{arch_ac_status}} | {{arch_ac_passed}}/{{arch_ac_total}} |

      {{#if architectural_violations}}
      ‚ö†Ô∏è **ARCHITECTURAL VIOLATIONS DETECTED (vs documented architecture):**
      {{architectural_violations}}

      **Source:** {{architecture_reference}}
      **These violations create technical debt and must be fixed before approval.**
      {{/if}}

      ---

      ### üß™ Testing (TDD Guide)
      {{test_review_summary}}

      ---

      ### üó∫Ô∏è Atlas Cross-Cutting Analysis

      **Workflow Chain Impacts:**
      {{workflow_impacts}}

      **Conflicts Resolved:**
      {{conflict_resolutions}}

      **Pattern Observations:**
      {{pattern_observations}}

      ---

      ### üìä Overall Assessment

      | Category | Status | Score |
      |----------|--------|-------|
      | Code Quality | {{code_status}} | {{code_score}}/10 |
      | Security | {{security_status}} | {{security_score}}/10 |
      | Architecture | {{arch_status}} | {{arch_score}}/10 |
      | **‚îú‚îÄ File Location (per docs)** | {{file_location_status}} | - |
      | **‚îú‚îÄ Patterns (per docs)** | {{pattern_status}} | - |
      | **‚îú‚îÄ Anti-Patterns (per docs)** | {{antipattern_status}} | - |
      | **‚îî‚îÄ Architectural ACs** | {{arch_ac_pass_rate}} | - |
      | Testing | {{test_status}} | {{test_score}}/10 |
      | **OVERALL** | **{{overall_status}}** | **{{overall_score}}/10** |

      **Architecture Reference:** {{architecture_reference}}

      ---

      ### üìã Consolidated Action Items

      **CRITICAL (Block deployment):**
      {{critical_items}}

      **HIGH (Must fix - includes architectural violations):**
      {{high_items}}
      {{#if architectural_violations}}
      üèóÔ∏è **Architectural Violations (HIGH):**
      {{architectural_violations_list}}
      {{/if}}

      **MEDIUM (Should fix):**
      {{medium_items}}

      **LOW (Nice to have):**
      {{low_items}}

      ---

      **Recommendation:** {{final_recommendation}}

      {{#if architectural_violations}}
      ‚ö†Ô∏è **Note:** Story cannot be approved until all architectural violations are resolved.
      {{/if}}
    </output>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 4: Handle Review Findings                                          -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="4" goal="Handle review findings and fix issues">
    <ask>What would you like to do with these findings?

      1. **[F]ix automatically** - Fix all HIGH and CRITICAL issues now
      2. **[A]ction items** - Add findings to story as tasks
      3. **[D]etails** - Show detailed findings from specific agent
      4. **[T]ech debt stories** - Create TD stories for deferred items
      5. **[S]kip** - Mark review complete without changes

      Choose [F], [A], [D], [T], or [S]:</ask>

    <check if="user chooses F">
      <action>Fix all CRITICAL and HIGH severity issues</action>
      <action>Re-run tests after fixes</action>
      <action>Update File List in story</action>
      <action>Set {{fixed_count}} = number of issues fixed</action>
    </check>

    <check if="user chooses A">
      <action>Add "Review Follow-ups (ECC)" section to story Tasks</action>
      <action>For each finding: `- [ ] [ECC-Review][Severity][Agent] Description`</action>
      <action>Set {{action_count}} = number of items added</action>
    </check>

    <check if="user chooses D">
      <ask>Which agent's details? [C]ode, [S]ecurity, [A]rchitect, [T]est</ask>
      <action>Show full output from selected agent</action>
      <action>Return to handling decision</action>
    </check>

    <check if="user chooses T">
      <action>Proceed to Step 4.5: Tech Debt Story Creation</action>
    </check>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 4.5: Tech Debt Story Creation (Optional)                           -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="4.5" goal="Create tech debt stories for deferred items">
    <critical>üóÇÔ∏è TECH DEBT TRACKING - Convert deferred items to tracked stories</critical>
    <critical>Items marked "deferred" without stories become orphans - always create TD stories!</critical>

    <!-- Identify deferred items -->
    <action>Collect all items from synthesis marked as:
      - "Deferred"
      - "Accepted risk"
      - "Consider for future"
      - "Technical debt"
    </action>

    <action>Group deferred items by category:
      - {{code_debt_items}} - File size, complexity, refactoring needs
      - {{security_debt_items}} - Security enhancements, hardening
      - {{arch_debt_items}} - Pattern compliance, structural improvements
      - {{test_debt_items}} - Test coverage, quality improvements
    </action>

    <!-- Tradeoff Analysis Template -->
    <output>## üóÇÔ∏è Tech Debt Analysis

      **Story:** {{story_key}}
      **Deferred Items Found:** {{total_deferred_count}}

      ---

      ### Tradeoff Analysis for Each Item

      For each deferred item, consider:

      | Factor | Do Now | Defer to TD Story |
      |--------|--------|-------------------|
      | **Merge conflict risk** | High if other stories touch same files | Low - isolated work |
      | **Context window fit** | May bloat current story | Clean separation |
      | **Sprint capacity** | Uses current sprint time | Scheduled for later |
      | **Accumulation risk** | Resolved immediately | May compound with future stories |
      | **Dependency risk** | Blocks nothing | May block future work |

      ---

      ### Items to Convert to Tech Debt Stories

      {{#each deferred_items}}
      #### {{index}}. {{title}}

      **Source:** {{agent}} review
      **Severity:** {{severity}}
      **Category:** {{category}}

      **Tradeoff Analysis:**
      - **Do Now?** {{do_now_rationale}}
      - **Defer?** {{defer_rationale}}
      - **Files affected:** {{affected_files}}
      - **Future stories touching these files:** {{future_story_risk}}

      **Recommendation:** {{recommendation}}
      {{/each}}

      ---
    </output>

    <!-- Ask user which items to create stories for -->
    <ask>Which items should become Tech Debt stories?

      Enter item numbers (e.g., "1,3,4") or:
      - **[A]ll** - Create TD stories for all deferred items
      - **[N]one** - Skip TD story creation
      - **[R]eview** - Show tradeoff details for specific item

      Choose items or [A], [N], [R]:</ask>

    <check if="user chooses items OR All">
      <!-- Tech Debt Story Template -->
      <action>For each selected item, create TD story using template:

        ```markdown
        # Tech Debt Story TD-{{epic_id}}-{{td_number}}: {{title}}

        Status: ready-for-dev

        > **Source:** ECC Code Review #{{review_number}} ({{date}}) on story {{story_key}}
        > **Priority:** {{priority}} ({{priority_rationale}})
        > **Estimated Effort:** {{effort_estimate}}
        > **Risk:** {{risk_level}} ({{risk_rationale}})

        ## Story

        As a **developer**,
        I want **{{what}}**,
        So that **{{why}}**.

        ## Problem Statement

        {{problem_description}}

        ## Acceptance Criteria

        {{acceptance_criteria}}

        ## Tasks / Subtasks

        {{tasks}}

        ## Dev Notes

        ### Tradeoff Analysis

        | Factor | Do Now | Defer |
        |--------|--------|-------|
        {{tradeoff_table}}

        **Recommendation:** {{recommendation}}

        ### Dependencies

        {{dependencies}}

        ### References

        - [{{story_key}}](./{{story_filename}}) - Source of this tech debt item
        ```
      </action>

      <action>Write story files to: {sprint_artifacts}/stories/TD-{{epic_id}}-{{td_number}}-{{slug}}.md</action>

      <action>Update story {{story_key}} with links to created TD stories:
        ```markdown
        ### Tech Debt Stories Created

        | TD Story | Description | Priority |
        |----------|-------------|----------|
        {{#each created_td_stories}}
        | [{{id}}](./{{filename}}) | {{description}} | {{priority}} |
        {{/each}}
        ```
      </action>

      <output>‚úÖ **Tech Debt Stories Created**

        Created {{td_story_count}} tech debt stories:

        {{#each created_td_stories}}
        - **{{id}}**: {{title}} ({{priority}})
          - File: `{{filepath}}`
          - Estimated: {{effort}}
        {{/each}}

        **Next steps:**
        - Review stories in sprint planning
        - Prioritize based on upcoming work
        - Consider merge conflict windows
      </output>
    </check>

    <check if="user chooses None">
      <output>‚ö†Ô∏è **Warning: Deferred items not tracked**

        The following items were marked "deferred" but no TD stories were created:
        {{deferred_items_list}}

        These items may become orphaned. Consider creating TD stories in the future.
      </output>
    </check>

    <check if="user chooses Review">
      <ask>Which item number to review in detail?</ask>
      <action>Show full tradeoff analysis for selected item</action>
      <action>Return to item selection</action>
    </check>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 5: Update Story Status                                             -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="5" goal="Update story status based on review outcome">
    <check if="no CRITICAL or HIGH issues OR all fixed">
      <action>Update story Status to "done"</action>
      <action>Set {{new_status}} = "done"</action>
    </check>

    <check if="CRITICAL or HIGH issues remain">
      <action>Update story Status to "in-progress"</action>
      <action>Set {{new_status}} = "in-progress"</action>
    </check>

    <check if="{{sprint_status}} file exists">
      <action>Update sprint-status.yaml: {{story_key}} ‚Üí {{new_status}}</action>
    </check>

    <action>Add "Senior Developer Review (ECC)" section to story with:
      - Review date
      - ECC agents used
      - Outcome
      - Action items count
    </action>
  </step>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STEP 6: Atlas Memory Feeding                                            -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <step n="6" goal="Feed review learnings to Atlas memory">
    <check if="{{atlas_enabled}} == true">
      <output>üó∫Ô∏è **Atlas Memory Update**

        Feed ECC review insights to Atlas knowledge base:

        **Story:** {{story_key}}
        **Pattern Observations:** {{pattern_observations}}
        **Security Patterns:** {{security_patterns}}
        **Architecture Decisions:** {{arch_decisions}}
        **Testing Patterns:** {{test_patterns}}

        Update Atlas memory?
      </output>

      <ask>Update Atlas memory? [Y/N]</ask>

      <check if="user confirms">
        <action>Update {atlas_knowledge}/04-architecture.md with pattern observations</action>
        <action>Update {atlas_knowledge}/05-testing.md with test patterns</action>
        <action>Update {atlas_knowledge}/06-lessons.md with review learnings</action>
        <output>‚úÖ Atlas memory updated with ECC review insights</output>
      </check>
    </check>

    <output>**‚úÖ ECC Code Review Complete!**

      **Story:** {{story_key}}
      **Status:** {{new_status}}
      **Issues Fixed:** {{fixed_count}}
      **Action Items:** {{action_count}}

      **ECC Agents Used:**
      - Code Reviewer ‚úì
      - Security Reviewer ‚úì
      - Architect ‚úì
      - TDD Guide ‚úì

      **Next Steps:**
      {{#if new_status == "done"}}
      - Run `deploy-story` to deploy
      {{else}}
      - Address action items
      - Re-run `ecc-code-review` after fixes
      {{/if}}
    </output>
  </step>

</workflow>
