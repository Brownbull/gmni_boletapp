# Story 14e-37: Create useInsightStore

## Story Info

| Field | Value |
|-------|-------|
| Epic | 14e - Feature Architecture |
| Story ID | 14e-37 |
| Story Name | Create useInsightStore |
| Priority | Medium |
| Points | 3 |
| Status | done |
| Created | 2026-01-29 |
| Updated | 2026-01-29 (Implementation complete) |
| Source | Pre-dev epic review - state consolidation |

---

## Atlas Workflow Analysis

> This section was generated by Atlas workflow chain analysis

### Affected Workflows

| Workflow | Impact Level | Description |
|----------|--------------|-------------|
| **#7 - Insight Generation Flow** | DIRECT | `currentInsight`, `showInsightCard` display insights |
| **#3 - Batch Processing Flow** | DIRECT | `showBatchSummary` triggered after batch completion |
| **#9 - Scan Request Lifecycle** | INDIRECT | Session completion feedback post-scan |

### Downstream Effects to Consider

1. **InsightCard component** - receives `currentInsight` and `showInsightCard` as props
2. **SessionCompleteOverlay** - uses `showSessionComplete` and `sessionContext`
3. **BatchSummaryCard** - triggers on `showBatchSummary`

### Testing Implications

- **Existing tests to verify:** InsightCard tests, SessionComplete tests, BatchSummary tests
- **New scenarios to add:** Store action → component render integration

### Workflow Chain Visualization

```
InsightEngine → showInsight() → [THIS STORE] → InsightCard/SessionComplete/BatchSummary
```

---

## Background

### Problem Statement

5 insight/session useState calls in App.tsx manage related overlay state. These should be consolidated.

**Current state (App.tsx lines 536-540):**
```typescript
const [currentInsight, setCurrentInsight] = useState<Insight | null>(null);
const [showInsightCard, setShowInsightCard] = useState(false);
const [showSessionComplete, setShowSessionComplete] = useState(false);
const [sessionContext, setSessionContext] = useState<SessionContext | null>(null);
const [showBatchSummary, setShowBatchSummary] = useState(false);
```

### Impact

- State scattered in App.tsx
- No central control for insight overlays
- ~50 lines of App.tsx could be removed

---

## Acceptance Criteria

### AC1: Store Structure

**Given** insight/session state needs
**When** creating the store
**Then:**
- [x] All 5 state variables consolidated
- [x] Follows existing Zustand patterns
- [x] DevTools integration

### AC2: Actions

**Given** the store
**When** managing insight state
**Then:**
- [x] `showInsight(insight)` shows insight card
- [x] `hideInsight()` hides and clears insight
- [x] `showSessionCompleteOverlay(context)` shows completion UI
- [x] `hideSessionCompleteOverlay()` hides completion UI
- [x] `showBatchSummaryOverlay()` / `hideBatchSummaryOverlay()`
- [x] `reset()` clears all

> **Note:** Action names use "Overlay" suffix to match DevTools labels and differentiate from state flags (e.g., `showSessionComplete` state vs `showSessionCompleteOverlay()` action).

### AC3: Typed Selectors

**Given** the store
**When** components need state
**Then:**
- [x] `useCurrentInsight()` selector
- [x] `useShowInsightCard()` selector
- [x] `useShowSessionComplete()` selector
- [x] `useSessionContext()` selector
- [x] `useShowBatchSummary()` selector
- [x] `useInsightActions()` combined actions hook
- [x] `useInsightCardState()` combined selector (insight + visibility)
- [x] `useSessionCompleteState()` combined selector (context + visibility)

### AC4: App.tsx Migration

**Given** the store exists
**When** App.tsx uses insight state
**Then:**
- [x] useState calls removed (5 useState → 0)
- [x] Uses store selectors via `useInsightActions()`
- [x] Net neutral: wrapper functions added (~30 lines) for backward compatibility with existing handlers

> **Note:** Initial estimate of ~50 lines reduced was inaccurate. Wrapper functions (`setCurrentInsight`, `setShowInsightCard`, etc.) bridge old setter patterns to store actions for compatibility with `useScanHandlers` and `useTransactionHandlers`.

### AC5: Tests Pass

**Given** the migration
**When** running tests
**Then:**
- [x] Store has unit tests
- [x] All existing tests pass

### AC6: InsightCard Component Migration (Atlas)

**Given** InsightCard receives insight state as props
**When** migrating to store
**Then:**
- [x] InsightCard uses `useCurrentInsight()` selector
- [x] InsightCard uses `useShowInsightCard()` selector
- [x] InsightCard uses `useInsightActions()` for dismiss
- [x] Props removed from App.tsx render

### AC7: SessionCompleteOverlay Migration (Atlas)

**Given** SessionCompleteOverlay receives session state as props
**When** migrating to store
**Then:**
- [x] Uses `useShowSessionComplete()` selector
- [x] Uses `useSessionContext()` selector (add if needed)
- [x] Uses actions for hide
- [x] Props removed from App.tsx render

### AC8: BatchSummary Integration (Atlas)

**Given** BatchSummary triggered by showBatchSummary
**When** migrating to store
**Then:**
- [x] Component uses `useShowBatchSummary()` selector
- [x] Uses action for dismiss
- [x] Props removed from App.tsx render

---

## Tasks

### Task 1: Create Store (AC: 1, 2)

- [x] **1.1** Create `src/shared/stores/useInsightStore.ts`
- [x] **1.2** Define state interface
- [x] **1.3** Implement actions
- [x] **1.4** Add devtools middleware

### Task 2: Create Selectors (AC: 3)

- [x] **2.1** Individual selectors for each state
- [x] **2.2** Combined actions hook
- [x] **2.3** Direct access helpers

### Task 3: Write Tests (AC: 5)

- [x] **3.1** Test initial state
- [x] **3.2** Test each action
- [x] **3.3** Test reset behavior

### Task 4: Migrate App.tsx (AC: 4)

- [x] **4.1** Replace useState with selectors
- [x] **4.2** Replace setters with actions (via wrapper functions for backward compatibility)
- [x] **4.3** Update overlay components

### Task 5: Migrate InsightCard Component (AC: 6)

- [x] **5.1** Update InsightCard to use store selectors (optional props with fallback)
- [x] **5.2** Props now optional (backward compatible)
- [x] **5.3** InsightCard tests pass (18 tests)

### Task 6: Migrate SessionCompleteOverlay (AC: 7)

- [x] **6.1** Update SessionCompleteOverlay to use store selectors (optional props with fallback)
- [x] **6.2** useSessionContext selector implemented in store
- [x] **6.3** Props now optional (backward compatible)

### Task 7: Migrate BatchSummary (AC: 8)

- [x] **7.1** Update BatchSummary component to use store
- [x] **7.2** onDismiss prop now optional (uses store action as fallback)

### Task 8: Verification (AC: 5, 6, 7, 8)

- [x] **8.1** Run full test suite - 6,987 tests pass
- [x] **8.2** Manual test: insight card display ✅ User verified 2026-01-29
- [x] **8.3** Manual test: session complete overlay ✅ User verified 2026-01-29
- [x] **8.4** Manual test: batch summary after batch complete ✅ User verified 2026-01-29

### Review Follow-ups (AI)

#### HIGH Priority

- [x] [AI-Review][HIGH] Fix story file paths - AC7 says `src/components/overlays/SessionCompleteOverlay.tsx` but actual is `src/components/session/SessionComplete.tsx`; AC8 says `src/components/batch/BatchSummaryCard.tsx` but actual is `src/components/insights/BatchSummary.tsx` [story:248-249]
- [x] [AI-Review][HIGH] Document action naming: AC2 specifies `showSessionComplete()` but implementation uses `showSessionCompleteOverlay()`. Same for batch summary actions. Update either AC2 or implementation for consistency [useInsightStore.ts:48-57]
- [x] [AI-Review][HIGH] Complete manual tests 8.2, 8.3, 8.4 before marking story done → User verified 2026-01-29

#### MEDIUM Priority

- [x] [AI-Review][MEDIUM] Update AC4 claim "~50 lines reduced" - wrapper functions in App.tsx add ~30 lines for backward compatibility, actual reduction is minimal [App.tsx:581-611]
- [x] [AI-Review][MEDIUM] Fix React act() warnings in SessionComplete and InsightCard tests - updates not wrapped properly [tests/unit/components/session/SessionComplete.test.tsx] → Tests refactored with `renderSessionComplete()` helper; remaining warnings are from Zustand subscription init (acceptable - all 36 tests pass)
- [x] [AI-Review][MEDIUM] Add JSDoc to insightActions object explaining when to use direct access vs hooks [useInsightStore.ts:220-233]

#### LOW Priority

- [x] [AI-Review][LOW] Document combined selectors `useInsightCardState()` and `useSessionCompleteState()` in AC3 spec [useInsightStore.ts:160-182]
- [x] [AI-Review][LOW] Verify architecture reference file exists: `docs/sprint-artifacts/epic14e-feature-architecture/architecture-decision.md (ADR-018)` [useInsightStore.ts:18]

---

## Technical Notes

### Store Design

```typescript
// src/shared/stores/useInsightStore.ts
interface InsightState {
  currentInsight: Insight | null;
  showInsightCard: boolean;
  showSessionComplete: boolean;
  showBatchSummary: boolean;
  sessionContext: SessionContext | null;
}

interface InsightActions {
  showInsight: (insight: Insight) => void;
  hideInsight: () => void;
  showSessionCompleteOverlay: (context: SessionContext) => void;
  hideSessionCompleteOverlay: () => void;
  showBatchSummaryOverlay: () => void;
  hideBatchSummaryOverlay: () => void;
  reset: () => void;
}
```

### Files to Create

| File | Purpose |
|------|---------|
| `src/shared/stores/useInsightStore.ts` | Store implementation |
| `tests/unit/shared/stores/useInsightStore.test.ts` | Tests |

### Files to Modify

| File | Change |
|------|--------|
| `src/shared/stores/index.ts` | Export new store |
| `src/App.tsx` | Remove useState, add wrapper functions for compatibility |
| `src/components/insights/InsightCard.tsx` | Use store selectors (AC6) |
| `src/components/session/SessionComplete.tsx` | Use store selectors (AC7) |
| `src/components/insights/BatchSummary.tsx` | Use store selectors (AC8) |

---

## Definition of Done

- [x] AC1: Store structure complete
- [x] AC2: All actions implemented
- [x] AC3: Typed selectors working
- [x] AC4: App.tsx migration complete
- [x] AC5: All tests pass
- [x] AC6: InsightCard uses store (Atlas)
- [x] AC7: SessionCompleteOverlay uses store (Atlas)
- [x] AC8: BatchSummary uses store (Atlas)
- [x] Code reviewed and approved (all 8 review items resolved)

---

## Senior Developer Review (AI)

**Reviewer:** Claude Code (Adversarial Review)
**Date:** 2026-01-29
**Outcome:** ✅ APPROVED

### Summary

Implementation is **complete and verified**. All 68 store tests pass with real assertions. Component tests (InsightCard: 18, SessionComplete: 36, BatchSummary: 17) all pass. All 8 previous review items have been addressed.

### Final Review (2026-01-29)

| Severity | Count | Status |
|----------|-------|--------|
| CRITICAL | 0 | N/A |
| HIGH | 1 | ✅ Fixed (files staged) |
| MEDIUM | 0 | Previous items resolved |
| LOW | 1 | ✅ Fixed (architecture reference format) |

### Verification Results

- ✅ Store implementation follows Zustand patterns
- ✅ DevTools integration working
- ✅ All 5 individual selectors exported and functional
- ✅ 2 combined selectors use `useShallow` correctly
- ✅ Direct access helpers provided for non-React code
- ✅ Components migrated with optional props pattern
- ✅ AppOverlays properly uses `showInsightCard` for conditional rendering
- ✅ Wrapper functions documented for backward compatibility
- ✅ Manual tests verified by user (2026-01-29)
- ✅ Files staged for commit

### Fixes Applied This Review

1. **HIGH** - Staged `useInsightStore.ts` and test file (were untracked)
2. **LOW** - Fixed architecture reference format (`(ADR-018)` → `#ADR-018`)

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2026-01-29 | Dev Agent | Implementation complete - store, tests, component migrations |
| 2026-01-29 | Claude Code | Code review - 8 action items created, status remains in-progress |
| 2026-01-29 | Dev Agent | Addressed code review findings - 7/8 items resolved (1 HIGH pending: manual tests require user verification) |
| 2026-01-29 | Gabe | Manual tests verified - all 3 overlays working correctly |
| 2026-01-29 | Dev Agent | All review items complete - story ready for final review |
| 2026-01-29 | Claude Code | Final review APPROVED - staged files, fixed architecture ref format |
