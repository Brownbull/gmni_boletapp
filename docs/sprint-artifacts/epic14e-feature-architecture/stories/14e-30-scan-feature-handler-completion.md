# Story 14e.30: ScanFeature Handler Completion

Status: done

**Epic:** 14e - Feature-Based Architecture (Follow-up)
**Points:** 2
**Created:** 2026-01-28
**Updated:** 2026-01-28 (Atlas-enhanced)
**Author:** Archie (React Opinionated Architect) + Atlas Workflow
**Depends:** 14e-28 (Transaction Editor Handlers), 14e-29d (Batch Review Cleanup)

---

## Story

As a **developer**,
I want **ScanFeature to own the remaining scan-related handlers from App.tsx**,
So that **scan initiation and file handling logic is fully encapsulated in the feature**.

---

## Context

### Problem Statement

App.tsx still contains **3 scan-related handlers** that should live in ScanFeature:

| Handler | App.tsx Lines | LOC | Purpose |
|---------|---------------|-----|---------|
| `handleNewTransaction` | 1056-1101 | ~45 | Start new scan/transaction flow |
| `handleFileSelect` | 1252-1315 | ~63 | File input handling, batch detection |
| `handleRescan` | 1519-1605 | ~87 | Rescan existing transaction |

**Total: ~195 lines to extract**

### Why These Remain

These handlers weren't extracted in the original ScanFeature work because:

1. **handleNewTransaction** - Orchestrates multiple concerns (batch detection, pending scan restoration, file picker triggering)
2. **handleFileSelect** - Complex async flow with batch mode detection and auto-processing
3. **handleRescan** - Coordinates with transaction editor state and credit system

With 14e-28 and 14e-29 complete, these handlers can move to ScanFeature since the editor and batch concerns are now self-contained.

### Architecture Decision Reference

From `architecture-decision.md`:
> "Refactor App.tsx to thin orchestrator"
> "Target: 500-800 lines"

This story removes ~200 lines of handler logic from App.tsx.

---

## Atlas Workflow Chain Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis (2026-01-28)

### Affected Workflows

| Workflow | Impact | Handler(s) Affected | Risk |
|----------|--------|---------------------|------|
| **Scan Receipt Flow (#1)** | üî¥ HIGH | `handleNewTransaction`, `handleFileSelect`, `handleRescan` | CORE entry points |
| **Batch Processing Flow (#3)** | üî¥ HIGH | `handleFileSelect` batch detection, `handleNewTransaction` batch restore | Multi-receipt flows |
| **Scan Request Lifecycle (#9)** | üî¥ HIGH | `handleNewTransaction` state machine coordination | Entry point |
| **Quick Save Flow (#2)** | üü° MEDIUM | Downstream from `handleNewTransaction` | Trusted auto-save path |
| **Learning Flow (#5)** | üü¢ LOW | Downstream only | Mappings applied after scan |

### Push Alert: ‚ö†Ô∏è Critical Entry Points

These 3 handlers are the **ONLY entry points** to the scan workflow chain:
- `handleNewTransaction` ‚Üí FAB button, camera button
- `handleFileSelect` ‚Üí File picker callback
- `handleRescan` ‚Üí Rescan existing transaction

**Any breaking change blocks 100% of scan functionality.**

### Downstream Effects to Consider

1. **File Input Ref Migration** - The `fileInputRef` is currently in App.tsx; must move to feature
2. **processScan Wrapper** - `handleFileSelect` calls `processScan` with images to avoid stale closure
3. **Batch Mode Detection** - `handleFileSelect` detects single vs multi-image and routes accordingly
4. **State Machine Coordination** - `handleNewTransaction` checks for pending scans and batch receipts

### Testing Implications

- **Critical manual test**: FAB ‚Üí camera ‚Üí capture ‚Üí process ‚Üí save (MUST work)
- **Batch path**: Multi-file select ‚Üí batch preview ‚Üí process ‚Üí review
- **Rescan path**: Edit existing ‚Üí rescan ‚Üí process ‚Üí save
- **Conflict handling**: Start new scan while existing scan in progress

---

## Acceptance Criteria

### AC1: Create useScanInitiation Hook

**Given** the handler extraction pattern established in 14e-28/29
**When** implementing the feature's initiation handlers
**Then:**
- [x] Create `src/features/scan/hooks/useScanInitiation.ts`
- [x] Hook returns all scan initiation handlers
- [x] Hook accesses scan store, navigation store directly
- [x] Hook receives minimal props for external dependencies

### AC2: Extract Scan Handlers

**Given** handlers currently in App.tsx
**When** extraction is complete
**Then:**
- [x] `handleNewTransaction` moved to hook (batch detection, pending scan restoration)
- [x] `handleFileSelect` moved to hook (file reading, batch detection, auto-process)
- [x] `handleRescan` moved to hook (credit deduction, API call, error handling)

### AC3: App.tsx Handler Removal

**Given** handlers moved to feature
**When** reviewing App.tsx
**Then:**
- [x] `handleNewTransaction` DELETED from App.tsx
- [x] `handleFileSelect` DELETED from App.tsx
- [x] `handleRescan` DELETED from App.tsx
- [x] `fileInputRef` management moved to ScanFeature
- [x] `triggerScan` replaced with feature handler
- [x] App.tsx reduced by ~200 lines

### AC4: Update ScanFeature

**Given** the new hook exists
**When** the feature is updated
**Then:**
- [x] ScanFeature owns file input element and ref
- [x] ScanFeature imports and uses `useScanInitiation` hook
- [x] FAB button/camera button uses feature handler (via props or exposed action)

### AC5: All Tests Pass

**Given** the refactored architecture
**When** running the test suite
**Then:**
- [x] Build succeeds: `npm run build`
- [x] All tests pass: `npm run test`
- [x] TypeScript clean: `tsc --noEmit`
- [x] No console errors in browser (manual verification)

### AC6: Scan Workflows Function (Atlas-Required)

**Given** the refactored feature
**When** testing all scan entry points
**Then:**
- [x] FAB tap (+ button): Opens transaction editor in new mode
- [x] FAB camera: Opens file picker ‚Üí capture ‚Üí auto-process (single image)
- [x] Multi-file select: Multiple images ‚Üí batch preview modal
- [x] Batch detection: MAX_BATCH_IMAGES limit enforced with toast
- [x] Pending restore: Existing pending scan ‚Üí navigates to editor with existing data
- [x] Conflict handling: Active scan ‚Üí navigates to current scan view (not dialog)
- [x] Rescan flow: Existing transaction ‚Üí rescan ‚Üí process ‚Üí update transaction

### AC7: Credit Flow Verification (Atlas-Required)

**Given** `handleRescan` uses credits
**When** testing rescan flow
**Then:**
- [x] Credit deducted BEFORE API call
- [x] Credit refunded on API error
- [x] No credit check for `handleNewTransaction` (credit checked in processScan)
- [x] Toast shown when no credits remaining

### AC8: Batch-Single Mode Coordination (Atlas-Required)

**Given** `handleFileSelect` detects single vs batch
**When** selecting multiple images
**Then:**
- [x] In single mode with multiple files: Only first image used, toast shown
- [x] In batch mode with multiple files: Batch preview shown
- [x] Mode preserved across file selections
- [x] File input cleared after each selection

---

## Tasks / Subtasks

### Task 1: Create Initiation Hook (AC: 1)

- [x] **1.1** Create `src/features/scan/hooks/useScanInitiation.ts` following 14e-29 pattern
- [x] **1.2** Define `ScanInitiationHandlersProps` interface for external dependencies
- [x] **1.3** Define `ScanInitiationHandlers` return interface
- [x] **1.4** Set up store imports (useScanStore, useNavigationStore)

### Task 2: Extract handleNewTransaction (AC: 2)

- [x] **2.1** Move logic to hook with proper dependencies
- [x] **2.2** Handle batch receipts detection (check `hasBatchReceipts` via store)
- [x] **2.3** Handle pending scan restoration (check phase, images, results)
- [x] **2.4** Handle file picker auto-open with `setTimeout` pattern
- [x] **2.5** Test: FAB ‚Üí transaction editor flow

### Task 3: Extract handleFileSelect (AC: 2, 8)

- [x] **3.1** Move logic to hook
- [x] **3.2** Move file input ref to ScanFeature component
- [x] **3.3** Handle single vs batch detection (mode check)
- [x] **3.4** Handle single mode multi-file warning toast
- [x] **3.5** Handle batch mode batch preview trigger
- [x] **3.6** Handle auto-process after single file selection
- [x] **3.7** Test: Single file ‚Üí auto-process flow
- [x] **3.8** Test: Multi file ‚Üí batch preview flow

### Task 4: Extract handleRescan (AC: 2, 7)

- [x] **4.1** Move logic to hook
- [x] **4.2** Handle credit check and deduction
- [x] **4.3** Handle API call with `isRescan: true`
- [x] **4.4** Handle result processing (date, items, totals)
- [x] **4.5** Handle credit refund on error
- [x] **4.6** Test: Rescan existing transaction flow

### Task 5: Update ScanFeature (AC: 4)

- [x] **5.1** Add file input element to ScanFeature (hidden)
- [x] **5.2** Create `fileInputRef` in feature
- [x] **5.3** Import and use `useScanInitiation` hook
- [x] **5.4** Expose initiation handlers via props or actions
- [x] **5.5** Update barrel exports in `@features/scan`

### Task 6: Clean Up App.tsx (AC: 3)

- [x] **6.1** Delete `handleNewTransaction` function
- [x] **6.2** Delete `handleFileSelect` function
- [x] **6.3** Delete `handleRescan` function
- [x] **6.4** Delete `triggerScan` (replaced by feature handler)
- [x] **6.5** Remove `fileInputRef` from App.tsx
- [x] **6.6** Update file input element to be in ScanFeature
- [x] **6.7** Clean up unused imports
- [x] **6.8** Verify line count reduction (~200 lines)

### Task 7: Update Tests (AC: 5)

- [x] **7.1** Create `tests/unit/features/scan/hooks/useScanInitiation.test.ts`
- [x] **7.2** Test `handleNewTransaction` all paths (normal, pending, batch)
- [x] **7.3** Test `handleFileSelect` all paths (single, multi, batch mode)
- [x] **7.4** Test `handleRescan` all paths (success, error, no credits)
- [x] **7.5** Update ScanFeature tests for file input ownership
- [x] **7.6** Run full test suite

### Task 8: Final Verification (AC: 5, 6, 7, 8)

- [x] **8.1** Manual smoke test: FAB ‚Üí camera ‚Üí process ‚Üí save
- [x] **8.2** Manual smoke test: Multi-file ‚Üí batch preview ‚Üí process
- [x] **8.3** Manual smoke test: Edit ‚Üí rescan ‚Üí save
- [x] **8.4** Verify App.tsx line count
- [x] **8.5** Verify all scan entry points work

---

## Dev Notes

### Handler Dependencies Analysis

#### handleNewTransaction Dependencies

```typescript
// Store Access
- scanState.phase, batchEditingIndex, images, results, activeDialog
- setBatchEditingIndexContext(), dismissScanDialog(), setScanImages()
- setView(), navigateToView()

// Props/Services (need injection)
- userPreferences.defaultCurrency
- createDefaultTransaction()
- fileInputRef
- hasBatchReceipts (derived from batch-review store)

// Actions
- setTransactionEditorMode()
- setCurrentTransaction()
```

#### handleFileSelect Dependencies

```typescript
// Store Access
- scanState.mode (single vs batch)
- setScanImages()
- setView(), setTransactionEditorMode()

// Props/Services (need injection)
- batchImages, setBatchImages
- fileInputRef
- setShowBatchPreview()
- setToastMessage()
- t (translations)
- processScan callback

// Calls
- processScan() with images parameter
```

#### handleRescan Dependencies

```typescript
// Props/Services (need injection)
- currentTransaction (with id and imageUrls)
- userCredits.remaining
- deductUserCredits(), addUserCredits()
- analyzeReceipt() service
- t (translations)
- lang

// Actions
- setCreditUsedInSession()
- setIsRescanning()
- setCurrentTransaction()
- setToastMessage()
```

### Complexity: handleFileSelect

`handleFileSelect` is ~63 lines and handles:
- File reading via FileReader (async Promise.all)
- Single scan mode detection with multi-file warning
- Batch mode detection with MAX_BATCH_IMAGES limit
- Navigation after file selection
- Auto-triggering processScan for single files

This may need to be broken into smaller functions:
- `readFilesToBase64(files: File[]): Promise<string[]>`
- `handleSingleModeFiles(images: string[]): void`
- `handleBatchModeFiles(images: string[]): void`

### Directory Structure After

```
src/features/scan/
‚îú‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ ScanFeature.tsx                    # Updated: owns file input
‚îú‚îÄ‚îÄ store/
‚îÇ   ‚îî‚îÄ‚îÄ useScanStore.ts
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                       # Updated: exports useScanInitiation
‚îÇ   ‚îî‚îÄ‚îÄ useScanInitiation.ts           # NEW
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îî‚îÄ‚îÄ processScan/
‚îî‚îÄ‚îÄ components/
```

### File Input Migration

Current (App.tsx):
```tsx
<input
    type="file"
    ref={fileInputRef}
    className="hidden"
    multiple
    accept="image/*"
    onChange={handleFileSelect}
/>
```

After (ScanFeature.tsx):
```tsx
// Inside ScanFeature, likely at the end
<input
    type="file"
    ref={fileInputRef}
    className="hidden"
    multiple
    accept="image/*"
    onChange={handleFileSelect}
/>
```

The `fileInputRef.current?.click()` call from `handleNewTransaction` will work since it's in the same feature.

---

## Story Sizing

| Metric | Value | Guideline | Status |
|--------|-------|-----------|--------|
| Tasks | 8 | ‚â§4 | üü° MEDIUM (mechanical extraction) |
| Subtasks | 35 | ‚â§15 | üî¥ LARGE (but well-scoped) |
| Files Changed | ~6 | ‚â§8 | ‚úÖ OK |
| Handlers Extracted | 3 | - | Moderate count, high importance |
| Lines Extracted | ~200 | - | Moderate |
| Entry Point Risk | CRITICAL | - | All scan entry points |

**Assessment:** Large story but focused scope. Subtasks are high because handlers have many code paths to test. Consider completing in focused sessions by handler.

---

## References

- [14e-28 Story](./14e-28-transaction-editor-handler-extraction.md) - Prerequisite (editor handlers)
- [14e-29b Story](./14e-29b-processing-navigation-handlers.md) - Pattern reference (batch handlers)
- [ScanFeature](../../../../src/features/scan/) - Current feature structure
- [App.tsx:1056-1101](../../../../src/App.tsx#L1056-L1101) - handleNewTransaction
- [App.tsx:1252-1315](../../../../src/App.tsx#L1252-L1315) - handleFileSelect
- [App.tsx:1519-1605](../../../../src/App.tsx#L1519-L1605) - handleRescan
- [08-workflow-chains.md](../../../../_bmad/agents/atlas/atlas-sidecar/knowledge/08-workflow-chains.md) - Workflow chain analysis

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**Created:**
- `src/features/scan/hooks/useScanInitiation.ts` - Hook with handleNewTransaction, handleFileSelect, handleRescan, triggerScan (536 lines)
- `src/features/scan/hooks/index.ts` - Barrel exports for hook and types
- `tests/unit/features/scan/hooks/useScanInitiation.test.ts` - 13 tests covering all handlers

**Modified:**
- `src/features/scan/ScanFeature.tsx` - Added file input element (lines 580-587), fileInputRef (line 440), onFileInputReady callback
- `src/features/scan/index.ts` - Added `export * from './hooks'` for hook exports
- `src/App.tsx` - Removed handlers, added useScanInitiation hook integration (lines 1491-1560), receives fileInputRef via callback

### Debug Log References

- Build: `npm run build` ‚úÖ (9.01s)
- Tests: 391/391 scan feature tests pass
- useScanInitiation tests: 13/13 pass

### Completion Notes List

- Handlers extracted following useBatchReviewHandlers pattern (14e-29)
- File input ownership moved to ScanFeature with callback pattern
- App.tsx receives ref via `onFileInputReady` callback, stores in state
- All scan workflow entry points preserved and functional
- Code review completed 2026-01-29
