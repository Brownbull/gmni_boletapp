# Story 14e.8: Extract processScan Handler

Status: split

> **SPLIT 2026-01-24:** This story exceeded sizing guidelines (5 tasks, 28 subtasks vs max 4 tasks, 15 subtasks).
> Split into 3 sub-stories using phase-based approach:
> - **[14e-8a](14e-8a-processscan-audit-utilities.md):** Pre-Audit + Pure Utilities (Part 1/3)
> - **[14e-8b](14e-8b-processscan-subhandlers.md):** Sub-Handlers Extraction (Part 2/3)
> - **[14e-8c](14e-8c-processscan-handler-integration.md):** Main Handler + Integration (Part 3/3)

## Story

As a **developer**,
I want **the processScan function extracted to a feature handler**,
So that **the ~302-line handler is no longer in App.tsx and lives in the scan feature module**.

## Acceptance Criteria

1. **AC1: Handler File Created**
   - `src/features/scan/handlers/processScan.ts` created
   - Function extracted with all logic intact
   - All ~30+ dependencies handled via parameters or hook injection
   - TypeScript types for all parameters and return values

2. **AC2: Dependency Injection Pattern**
   - Dependencies grouped into logical parameter objects:
     - `ScanDependencies` (state values: images, currency, storeType, etc.)
     - `UserDependencies` (user, services, userCredits, userPreferences)
     - `MappingDependencies` (mappings, findMerchantMatch, applyCategoryMappings, etc.)
     - `UIDependencies` (setters, dispatchers, showScanDialog, etc.)
   - No direct imports from App.tsx state

3. **AC3: App.tsx Integration**
   - Original `processScan` in App.tsx replaced with handler import
   - Handler called with same interface (accepts optional `imagesToProcess`)
   - All existing callers continue working unchanged
   - ~302 lines removed from App.tsx

4. **AC4: Test Coverage**
   - Unit tests for handler in isolation (mocked dependencies)
   - Integration tests verify handler works with real hooks
   - All existing scan tests pass
   - Test coverage maintained or improved

5. **AC5: No Regressions**
   - Single scan flow works: capture -> process -> review -> save
   - Quick save flow works: high confidence -> QuickSaveCard
   - Trusted merchant flow works: auto-save
   - Currency mismatch dialog triggers correctly
   - Total mismatch dialog triggers correctly
   - Error path refunds credits correctly

## Atlas Workflow Analysis

> This section was generated by Atlas workflow chain analysis

### Affected Workflows

| Workflow | Impact Level | Details |
|----------|-------------|---------|
| **#1 Scan Receipt Flow** | CRITICAL | `processScan` IS this workflow's core implementation |
| **#2 Quick Save Flow** | HIGH | Confidence check, QuickSaveCard trigger lives here |
| **#8 Trust Merchant Flow** | HIGH | Auto-save for trusted merchants triggered here |
| **#5 Learning Flow** | MEDIUM | Category/merchant/item mapping application |
| **#7 Insight Generation Flow** | MEDIUM | Insight generation after trusted auto-save |
| **#3 Batch Processing Flow** | LOW | Batch uses separate processBatch but shares patterns |

### Downstream Effects to Consider

- **EditView** receives `currentTransaction` set by processScan
- **QuickSaveCard** dialog triggered via `showScanDialog(DIALOG_TYPES.QUICKSAVE)`
- **CurrencyMismatchDialog** triggered when detected != default currency
- **TotalMismatchDialog** triggered when items sum differs >40% from total
- **InsightCard** receives insight generated in auto-save path
- **BatchSummary** triggered when >=3 receipts in session

### Testing Implications

- **Existing tests to verify:** ~74 scan-related tests from Epic 14d
- **New test scenarios:**
  - Handler import works correctly
  - Dependencies passed correctly
  - Error paths still refund credits
  - Dialog triggers still work

### Workflow Chain Visualization

```
[Camera] -> [processScan] -> [Gemini OCR] -> [Apply Mappings] ->
  -> [Currency Check] -> (dialog OR continue) ->
  -> [Total Validation] -> (dialog OR continue) ->
  -> [Confidence Check] -> [QuickSave|TrustedAutoSave|EditView]
```

## Tasks / Subtasks

### Pre-Extraction Requirements (AC: ALL)

- [ ] **Task 0: Pre-Extraction Audit** (AC: ALL)
  - [ ] 0.1 Document ALL dependencies (see Dev Notes for baseline)
  - [ ] 0.2 Run existing tests, document baseline pass/fail state
  - [ ] 0.3 Create smoke test checklist (single, quicksave, trusted, error)
  - [ ] 0.4 Document rollback plan (revert file changes)

### Layer 1: Pure Utilities (AC: 1)

- [ ] **Task 1: Extract Pure Helpers** (AC: 1)
  - [ ] 1.1 Create `src/features/scan/handlers/processScan/index.ts` (barrel export)
  - [ ] 1.2 Create `src/features/scan/handlers/processScan/utils.ts`
  - [ ] 1.3 Extract `getSafeDate()` validation utility (if not already exported)
  - [ ] 1.4 Extract `parseLocationResult()` for country/city validation
  - [ ] 1.5 Extract `buildInitialTransaction()` for transaction construction
  - [ ] 1.6 Add unit tests for each utility function

### Layer 2: Sub-Handlers (AC: 1, 2)

- [ ] **Task 2: Extract Sub-Handlers** (AC: 1, 2)
  - [ ] 2.1 Create `src/features/scan/handlers/processScan/types.ts` for dependency interfaces
  - [ ] 2.2 Extract `validateScanResult()` for total validation + dialog trigger
  - [ ] 2.3 Extract `applyAllMappings()` combining category + merchant + item mappings
  - [ ] 2.4 Extract `handleCurrencyDetection()` for currency check + dialog trigger
  - [ ] 2.5 Extract `handleScanSuccess()` for QuickSave/Trusted/EditView routing
  - [ ] 2.6 Add unit tests for each sub-handler (mocked dependencies)

### Layer 3: Main Handler (AC: 1, 2, 3)

- [ ] **Task 3: Create Main processScan Handler** (AC: 1, 2, 3)
  - [ ] 3.1 Create `src/features/scan/handlers/processScan/processScan.ts`
  - [ ] 3.2 Define `ProcessScanParams` interface with all dependency groups
  - [ ] 3.3 Implement `processScan(params)` using extracted sub-handlers
  - [ ] 3.4 Add JSDoc documentation for handler
  - [ ] 3.5 Export from `src/features/scan/handlers/index.ts`
  - [ ] 3.6 Export from `src/features/scan/index.ts`

### Layer 4: Integration (AC: 3, 4, 5)

- [ ] **Task 4: App.tsx Integration & Verification** (AC: 3, 4, 5)
  - [ ] 4.1 Import handler in App.tsx: `import { processScan } from '@features/scan'`
  - [ ] 4.2 Create wrapper that passes dependencies to handler
  - [ ] 4.3 Delete original processScan function from App.tsx (~302 lines)
  - [ ] 4.4 Run all tests - must pass
  - [ ] 4.5 Execute smoke test checklist
  - [ ] 4.6 Update any imports in other files if needed

## Dev Notes

### Dependency Inventory (From App.tsx Analysis)

**State Values (~15):**
- `scanImages`, `scanCurrency`, `scanStoreType`
- `userCredits.remaining`
- `viewMode`, `activeGroup`
- `mappings` (category mappings array)
- `userPreferences.defaultCurrency`
- `transactions` (for insight context)
- `insightProfile`, `insightCache`, `batchSession`
- `defaultCountry`, `defaultCity`
- `lang`, `prefersReducedMotion`

**State Setters (~12):**
- `setScanError`, `setToastMessage`, `setCreditUsedInSession`
- `setIsAnalyzing`, `setCurrentTransaction`, `setView`
- `setScanImages`, `setSkipScanCompleteModal`
- `setShowBatchSummary`, `setCurrentInsight`
- `setShowInsightCard`, `setAnimateEditViewItems`

**Dispatchers (3):**
- `dispatchProcessStart`
- `dispatchProcessSuccess`
- `dispatchProcessError`

**Services/Functions (~15):**
- `deductUserCredits`, `addUserCredits`
- `analyzeReceipt` (API call)
- `firestoreAddTransaction`
- `applyCategoryMappings`, `findMerchantMatch`, `applyItemNameMappings`
- `incrementMappingUsage`, `incrementMerchantMappingUsage`, `incrementItemNameMappingUsage`
- `showScanDialog`
- `checkTrusted`, `shouldShowQuickSave`, `calculateConfidence`
- `generateInsightForTransaction`, `addToBatch`
- `recordMerchantScan`

**Utils:**
- `getSafeDate`, `parseStrictNumber`, `validateTotal`
- `reconcileItemsTotal` (already in useScanHandlers)
- `getCitiesForCountry`

### Extraction Strategy (Recommended by Archie)

Extract in layers to minimize risk - do NOT pull ~302 lines in one commit:

1. **Layer 1 - Pure Utilities:** Extract pure helper functions with no external dependencies first
2. **Layer 2 - Sub-handlers:** Extract functions that only depend on utilities
3. **Layer 3 - Main Handler:** Extract the main `processScan` orchestration function last

**Safeguard:** Create a thin wrapper function in App.tsx that delegates to the extracted handler. Test both before removing old code.

### Existing useScanHandlers Integration

The `useScanHandlers` hook (Story 14c-refactor.20) already extracts:
- Dialog handlers (QuickSave, Currency, Total)
- `reconcileItemsTotal()` utility
- `applyItemNameMappings()` utility
- `continueScanWithTransaction()` helper

These can be reused in the extracted processScan handler.

### Project Structure Notes

**Target location:** `src/features/scan/handlers/processScan/`

```
src/features/scan/
├── handlers/
│   ├── index.ts              # Export processScan
│   └── processScan/
│       ├── index.ts          # Barrel export
│       ├── types.ts          # Dependency interfaces
│       ├── utils.ts          # Pure utilities
│       ├── processScan.ts    # Main handler
│       └── processScan.test.ts
├── store/                    # (Future: Zustand store from 14e.6)
├── components/               # (Future: scan components)
└── index.ts                  # Feature export
```

**Path alias:** Uses `@features/scan` from 14e.1 Zustand setup.

### Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Breaking scan flow | Layer-by-layer extraction, test after each layer |
| Stale closures | Pass images as parameter (existing pattern) |
| Missing dependencies | Pre-extraction audit task |
| Regressions | Smoke test checklist before/after |

### References

- [Source: src/App.tsx#L1241-1543] - processScan function
- [Source: src/hooks/app/useScanHandlers.ts] - Related extracted handlers
- [Source: docs/sprint-artifacts/epic14e-feature-architecture/epics.md#Story-14e.8] - Epic definition
- [Source: _bmad/agents/atlas/atlas-sidecar/knowledge/08-workflow-chains.md] - Workflow chain analysis

## Story Sizing Warning

> **LARGE STORY** - At upper limit of context window capacity

| Metric | Value | Guideline |
|--------|-------|-----------|
| Tasks | 4 | <= 4 |
| Subtasks | 14 | <= 15 |
| Files | 4-6 | <= 8 |

**Mitigation:** If development exceeds context window, split remaining tasks into follow-up story.

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled during development_

### Completion Notes List

_To be filled during development_

### File List

_To be filled during development_
