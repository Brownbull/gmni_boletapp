# Story 14e.14a: Batch Handler Types & Navigation Handlers

Status: done

## Story

As a **developer**,
I want **the handler directory structure and navigation handlers extracted**,
So that **the foundation exists for remaining batch handler extractions**.

## Context

This is Part 1 of 4 for extracting batch review handlers (split from 14e-14 due to sizing).

**Part 1 (this story):** Handler directory, context types, navigation handlers
**Part 2 (14e-14b):** Edit and save handlers
**Part 3 (14e-14c):** Discard and credit check handlers
**Part 4 (14e-14d):** App.tsx integration and verification

### Current Implementation

Navigation handlers in `src/App.tsx`:
- `handleBatchPrevious` (~15 lines) - Navigate to previous receipt
- `handleBatchNext` (~15 lines) - Navigate to next receipt

## Atlas Workflow Analysis

> ðŸ—ºï¸ Generated by Atlas workflow chain analysis

### Affected Workflows

| Workflow | Impact |
|----------|--------|
| **#3: Batch Processing Flow** | DIRECT - Navigation within batch review |
| **#9: Scan Request Lifecycle** | INDIRECT - Batch is sub-phase of scan |

## Acceptance Criteria

### AC1: Handler Directory Structure

**Given** Story 14e-1 completed (directory structure exists)
**When** this story is completed
**Then:**
- `src/features/batch-review/handlers/` directory exists
- `src/features/batch-review/handlers/index.ts` barrel export exists

### AC2: Context Type Definitions

**Given** the need for type-safe handler dependencies
**When** reviewing `src/features/batch-review/handlers/types.ts`
**Then:**
- `BatchNavigationContext` interface defined with:
  - `scanState: ScanState`
  - `setBatchEditingIndexContext: (index: number | null) => void`
  - `currentTransaction: Transaction | null`
  - `setCurrentTransaction: (tx: Transaction | null) => void`
- All context interfaces exported

**Note:** Implementation uses `currentTransaction`/`setCurrentTransaction` (matching actual App.tsx code) rather than `pendingTransaction`/`setPendingTransaction` from template. The `navigateToView` is not needed because handlers are invoked when already in the transaction editor view.

### AC3: Navigation Handlers Extracted

**Given** `handleBatchPrevious` and `handleBatchNext` in App.tsx
**When** reviewing `src/features/batch-review/handlers/navigation.ts`
**Then:**
- `navigateToPreviousReceipt(context: BatchNavigationContext)` extracted
- `navigateToNextReceipt(context: BatchNavigationContext)` extracted
- Bounds checking included (previous at 0, next at length-1)
- Handlers exported from index.ts

### AC4: Unit Tests

**Given** navigation handlers extracted
**When** running tests
**Then:**
- Tests verify bounds checking (no-op at boundaries)
- Tests verify currentTransaction update during navigation
- Tests verify thumbnailUrl is added when receipt has imageUrl

## Tasks / Subtasks

- [x] **Task 1: Create handler directory and types** (AC: 1, 2)
  - [x] 1.1 Create `src/features/batch-review/handlers/` directory
  - [x] 1.2 Create `types.ts` with `BatchNavigationContext` interface
  - [x] 1.3 Create `index.ts` barrel export

- [x] **Task 2: Extract navigation handlers** (AC: 3, 4)
  - [x] 2.1 Create `navigation.ts` with `navigateToPreviousReceipt`
  - [x] 2.2 Add `navigateToNextReceipt` to `navigation.ts`
  - [x] 2.3 Add bounds checking (return early if at boundary)
  - [x] 2.4 Export from `index.ts`
  - [x] 2.5 Create `tests/unit/features/batch-review/handlers/navigation.test.ts`
  - [x] 2.6 Write tests for both handlers (happy path + boundaries)

## Dev Notes

### Navigation Handler Implementation

```typescript
// src/features/batch-review/handlers/navigation.ts
import type { BatchNavigationContext } from './types';

export function navigateToPreviousReceipt(context: BatchNavigationContext): void {
  const { scanState, setBatchEditingIndexContext, setCurrentTransaction } = context;

  const batchReceipts = scanState.batchReceipts;
  const currentIndex = scanState.batchEditingIndex;

  // Bounds check: return early if at start or no batch
  if (!batchReceipts || currentIndex === null || currentIndex <= 0) return;

  const prevIndex = currentIndex - 1;
  const prevReceipt = batchReceipts[prevIndex];

  if (prevReceipt) {
    setBatchEditingIndexContext(prevIndex);
    const transactionWithThumbnail = prevReceipt.imageUrl
      ? { ...prevReceipt.transaction, thumbnailUrl: prevReceipt.imageUrl }
      : prevReceipt.transaction;
    setCurrentTransaction(transactionWithThumbnail);
  }
}

export function navigateToNextReceipt(context: BatchNavigationContext): void {
  const { scanState, setBatchEditingIndexContext, setCurrentTransaction } = context;

  const batchReceipts = scanState.batchReceipts;
  const currentIndex = scanState.batchEditingIndex;

  // Bounds check: return early if at end or no batch
  if (!batchReceipts || currentIndex === null || currentIndex >= batchReceipts.length - 1) return;

  const nextIndex = currentIndex + 1;
  const nextReceipt = batchReceipts[nextIndex];

  if (nextReceipt) {
    setBatchEditingIndexContext(nextIndex);
    const transactionWithThumbnail = nextReceipt.imageUrl
      ? { ...nextReceipt.transaction, thumbnailUrl: nextReceipt.imageUrl }
      : nextReceipt.transaction;
    setCurrentTransaction(transactionWithThumbnail);
  }
}
```

### File Structure After This Story

```
src/features/batch-review/
  handlers/
    types.ts           # BatchNavigationContext + future context types
    navigation.ts      # navigateToPreviousReceipt, navigateToNextReceipt
    index.ts           # Barrel export
```

### Dependencies

- **Depends on:** Story 14e-1 (directory structure, Zustand)
- **Blocks:** Story 14e-14b (edit/save handlers), 14e-14d (App.tsx integration)

### References

- [Source: src/App.tsx:1637-1665 - handleBatchPrevious, handleBatchNext]
- [Source: docs/sprint-artifacts/epic14e-feature-architecture/stories/14e-14-extract-batch-review-handlers.md - Parent story]

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - implementation proceeded without issues.

### Completion Notes List

1. Created handler directory structure following scan feature pattern
2. Implemented `BatchNavigationContext` interface with actual App.tsx dependencies (using `currentTransaction`/`setCurrentTransaction` to match existing code)
3. Extracted `navigateToPreviousReceipt` and `navigateToNextReceipt` handlers
4. Comprehensive tests: 19 tests covering bounds checking, happy path navigation, thumbnail handling, and edge cases
5. Updated feature barrel export to include handlers
6. All 347 existing tests pass with no regressions

### Code Review Fixes (2026-01-26)

1. Added missing empty array edge case test for `navigateToPreviousReceipt` (test symmetry)
2. Extracted `buildTransactionWithThumbnail()` helper to eliminate code duplication
3. Test count: 18 â†’ 19 tests

### File List

**Created:**
- `src/features/batch-review/handlers/types.ts` - BatchNavigationContext interface
- `src/features/batch-review/handlers/navigation.ts` - Navigation handler functions
- `src/features/batch-review/handlers/index.ts` - Barrel export
- `tests/unit/features/batch-review/handlers/navigation.test.ts` - 19 unit tests

**Modified:**
- `src/features/batch-review/index.ts` - Added handler exports to feature barrel

## Change Log

| Date | Change |
|------|--------|
| 2026-01-26 | Story implemented by Claude Opus 4.5 - All ACs satisfied, 18 tests added |
| 2026-01-26 | Atlas code review fixes: Added empty array test (+1), extracted buildTransactionWithThumbnail helper |
