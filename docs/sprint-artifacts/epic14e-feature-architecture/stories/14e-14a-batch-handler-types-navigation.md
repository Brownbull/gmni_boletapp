# Story 14e.14a: Batch Handler Types & Navigation Handlers

Status: ready-for-dev

## Story

As a **developer**,
I want **the handler directory structure and navigation handlers extracted**,
So that **the foundation exists for remaining batch handler extractions**.

## Context

This is Part 1 of 4 for extracting batch review handlers (split from 14e-14 due to sizing).

**Part 1 (this story):** Handler directory, context types, navigation handlers
**Part 2 (14e-14b):** Edit and save handlers
**Part 3 (14e-14c):** Discard and credit check handlers
**Part 4 (14e-14d):** App.tsx integration and verification

### Current Implementation

Navigation handlers in `src/App.tsx`:
- `handleBatchPrevious` (~15 lines) - Navigate to previous receipt
- `handleBatchNext` (~15 lines) - Navigate to next receipt

## Atlas Workflow Analysis

> ðŸ—ºï¸ Generated by Atlas workflow chain analysis

### Affected Workflows

| Workflow | Impact |
|----------|--------|
| **#3: Batch Processing Flow** | DIRECT - Navigation within batch review |
| **#9: Scan Request Lifecycle** | INDIRECT - Batch is sub-phase of scan |

## Acceptance Criteria

### AC1: Handler Directory Structure

**Given** Story 14e-1 completed (directory structure exists)
**When** this story is completed
**Then:**
- `src/features/batch-review/handlers/` directory exists
- `src/features/batch-review/handlers/index.ts` barrel export exists

### AC2: Context Type Definitions

**Given** the need for type-safe handler dependencies
**When** reviewing `src/features/batch-review/handlers/types.ts`
**Then:**
- `BatchNavigationContext` interface defined with:
  - `scanState: ScanState`
  - `setBatchEditingIndexContext: (index: number | null) => void`
  - `pendingTransaction: Transaction | null`
  - `setPendingTransaction: (tx: Transaction | null) => void`
  - `navigateToView: (view: ViewType) => void`
- All context interfaces exported

### AC3: Navigation Handlers Extracted

**Given** `handleBatchPrevious` and `handleBatchNext` in App.tsx
**When** reviewing `src/features/batch-review/handlers/navigation.ts`
**Then:**
- `navigateToPreviousReceipt(context: BatchNavigationContext)` extracted
- `navigateToNextReceipt(context: BatchNavigationContext)` extracted
- Bounds checking included (previous at 0, next at length-1)
- Handlers exported from index.ts

### AC4: Unit Tests

**Given** navigation handlers extracted
**When** running tests
**Then:**
- Tests verify bounds checking (no-op at boundaries)
- Tests verify pendingTransaction update during navigation
- Tests verify navigateToView called with 'transaction-editor'

## Tasks / Subtasks

- [ ] **Task 1: Create handler directory and types** (AC: 1, 2)
  - [ ] 1.1 Create `src/features/batch-review/handlers/` directory
  - [ ] 1.2 Create `types.ts` with `BatchNavigationContext` interface
  - [ ] 1.3 Create `index.ts` barrel export

- [ ] **Task 2: Extract navigation handlers** (AC: 3, 4)
  - [ ] 2.1 Create `navigation.ts` with `navigateToPreviousReceipt`
  - [ ] 2.2 Add `navigateToNextReceipt` to `navigation.ts`
  - [ ] 2.3 Add bounds checking (return early if at boundary)
  - [ ] 2.4 Export from `index.ts`
  - [ ] 2.5 Create `tests/unit/features/batch-review/handlers/navigation.test.ts`
  - [ ] 2.6 Write tests for both handlers (happy path + boundaries)

## Dev Notes

### Navigation Handler Implementation

```typescript
// src/features/batch-review/handlers/navigation.ts
import type { BatchNavigationContext } from './types';

export function navigateToPreviousReceipt(context: BatchNavigationContext): void {
  const { scanState, setBatchEditingIndexContext, pendingTransaction, setPendingTransaction, navigateToView } = context;

  const batchReceipts = scanState.batchReceipts;
  const currentIndex = scanState.batchEditingIndex;

  // Bounds check: return early if at start or no batch
  if (!batchReceipts || currentIndex === null || currentIndex <= 0) return;

  const newIndex = currentIndex - 1;
  setBatchEditingIndexContext(newIndex);

  if (pendingTransaction) {
    const receipt = batchReceipts[newIndex];
    const transactionWithThumbnail = receipt.imageUrl
      ? { ...receipt.transaction, thumbnailUrl: receipt.imageUrl }
      : receipt.transaction;
    setPendingTransaction(transactionWithThumbnail);
    navigateToView('transaction-editor');
  }
}

export function navigateToNextReceipt(context: BatchNavigationContext): void {
  const { scanState, setBatchEditingIndexContext, pendingTransaction, setPendingTransaction, navigateToView } = context;

  const batchReceipts = scanState.batchReceipts;
  const currentIndex = scanState.batchEditingIndex;

  // Bounds check: return early if at end or no batch
  if (!batchReceipts || currentIndex === null || currentIndex >= batchReceipts.length - 1) return;

  const newIndex = currentIndex + 1;
  setBatchEditingIndexContext(newIndex);

  if (pendingTransaction) {
    const receipt = batchReceipts[newIndex];
    const transactionWithThumbnail = receipt.imageUrl
      ? { ...receipt.transaction, thumbnailUrl: receipt.imageUrl }
      : receipt.transaction;
    setPendingTransaction(transactionWithThumbnail);
    navigateToView('transaction-editor');
  }
}
```

### File Structure After This Story

```
src/features/batch-review/
  handlers/
    types.ts           # BatchNavigationContext + future context types
    navigation.ts      # navigateToPreviousReceipt, navigateToNextReceipt
    index.ts           # Barrel export
```

### Dependencies

- **Depends on:** Story 14e-1 (directory structure, Zustand)
- **Blocks:** Story 14e-14b (edit/save handlers), 14e-14d (App.tsx integration)

### References

- [Source: src/App.tsx:1717-1744 - handleBatchPrevious, handleBatchNext]
- [Source: docs/sprint-artifacts/epic14e-feature-architecture/stories/14e-14-extract-batch-review-handlers.md - Parent story]

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
