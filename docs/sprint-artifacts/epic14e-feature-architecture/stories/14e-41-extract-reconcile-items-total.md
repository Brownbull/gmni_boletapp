# Story 14e-41: Extract reconcileItemsTotal

## Story Info

| Field | Value |
|-------|-------|
| Epic | 14e - Feature Architecture |
| Story ID | 14e-41 |
| Story Name | Extract reconcileItemsTotal |
| Priority | Medium |
| Points | 3 |
| Status | done |
| Created | 2026-01-29 |
| Atlas Enhanced | 2026-01-29 |
| Source | Pre-dev epic review - business logic extraction |

---

## Background

### Problem Statement

`reconcileItemsTotal` is a pure utility function that reconciles item totals with receipt total. It currently exists in **TWO locations** (duplication):

1. **App.tsx lines 235-260** - Original implementation
2. **subhandlers.ts lines 488-526** - Already extracted duplicate

**Purpose:**
- Adds adjustment item (surplus/discount) when items sum doesn't match receipt total
- Handles floating point rounding to avoid precision issues
- Supports English and Spanish adjustment item names

### Impact

- Duplicate implementations risk divergence
- Utility function doesn't belong in App.tsx OR scan-specific handlers
- Should be in transaction entity utilities (domain-level concern)
- ~35 lines from App.tsx + ~40 lines from subhandlers.ts consolidated

---

## Atlas Workflow Analysis

> This section was generated by Atlas workflow chain analysis

### Affected Workflows

| Workflow | Impact | Details |
|----------|--------|---------|
| **#1 Scan Receipt Flow** | DIRECT | Called during every scan save to balance items vs total |
| **#2 Quick Save Flow** | DIRECT | Same reconciliation path before auto-save |
| **#3 Batch Processing Flow** | DIRECT | Each batch receipt goes through reconciliation |
| **#9 Scan Lifecycle** | DIRECT | Part of REVIEWING -> SAVING transition |

### Downstream Effects to Consider

- `processScan` handler uses it via dependencies parameter
- `useScanInitiation` hook uses it via props
- `useScanHandlers` hook exposes it to App.tsx
- `validateScanResult` subhandler imports locally

### Testing Implications

| Test File | Current Tests | Action |
|-----------|---------------|--------|
| `subhandlers.test.ts` | 10 tests | Move to entity test file |
| `useScanHandlers.test.ts` | 4 tests | Update to mock entity import |

### Workflow Chain Visualization

```
Camera -> Gemini OCR -> [THIS FUNCTION] -> EditView -> Save
                             ^
                             |
                      Ensures items + adjustments = receipt total
```

---

## Acceptance Criteria

### AC1: Utility Function Extracted

**Given** the reconciliation logic in App.tsx
**When** extracted to entity
**Then:**
- [x] Pure function in `src/entities/transaction/utils/reconciliation.ts`
- [x] Same behavior maintained (surplus/discount items)
- [x] Well-documented with JSDoc
- [x] Supports 'en' and 'es' language parameter

### AC2: Correct Location

**Given** the function
**When** determining placement
**Then:**
- [x] Located in `src/entities/transaction/utils/reconciliation.ts`
- [x] Exported from transaction entity index
- [x] Grouped with other transaction utilities

### AC3: All Callers Updated

**Given** the extracted function
**When** used
**Then:**
- [x] App.tsx imports from `@entities/transaction`
- [x] processScan imports from `@entities/transaction`
- [x] useScanHandlers imports from `@entities/transaction`
- [x] useScanInitiation type references updated (receives as prop - no import change needed)
- [x] No duplicate implementations remain

### AC4: Tests Consolidated

**Given** existing tests in multiple files
**When** consolidated
**Then:**
- [x] Unit tests in `tests/unit/entities/transaction/utils/reconciliation.test.ts`
- [x] 10 tests migrated from subhandlers.test.ts
- [x] Edge cases covered (no discrepancy, surplus, discount, empty, Spanish)
- [x] All existing tests pass

### AC5: Remove Duplicate Implementation (Atlas)

**Given** duplicate in subhandlers.ts
**When** extracted to entity
**Then:**
- [x] Delete `reconcileItemsTotal` from `src/features/scan/handlers/processScan/subhandlers.ts` (lines 470-526)
- [x] Import from `@entities/transaction` instead
- [x] Single source of truth verified

### AC6: Update All Import Paths (Atlas)

**Given** multiple files referencing the function
**When** consolidated
**Then:**
- [x] `subhandlers.ts` - TRANSLATIONS import removed (reconcileItemsTotal deleted)
- [x] `processScan.ts` - import from `@entities/transaction`
- [x] `useScanHandlers.ts` - import from `@entities/transaction` (as wrapper)
- [x] `useScanInitiation.ts` - no change needed (receives as prop)
- [x] `App.tsx` - import from `@entities/transaction`

### AC7: Update Test Imports (Atlas)

**Given** tests that import directly
**When** source moved
**Then:**
- [x] `subhandlers.test.ts` - remove reconcileItemsTotal tests (moved to entity)
- [x] `useScanHandlers.test.ts` - mock `@entities/transaction` import

---

## Tasks

### Task 1: Create Entity Utility (AC: 1, 2)

- [x] **1.1** Create `src/entities/transaction/utils/reconciliation.ts`
- [x] **1.2** Copy function from subhandlers.ts (cleaner version with TypeScript types)
- [x] **1.3** Add/enhance JSDoc documentation
- [x] **1.4** Export TRANSLATIONS constant or import from shared location

### Task 2: Create Entity Tests (AC: 4)

- [x] **2.1** Create `tests/unit/entities/transaction/utils/reconciliation.test.ts`
- [x] **2.2** Migrate 10 tests from `subhandlers.test.ts`:
  - No discrepancy (items match total)
  - Positive discrepancy (surplus item added)
  - Negative discrepancy (discount item added)
  - Spanish language names
  - Empty items array
  - Zero total
  - Floating point precision
  - Small discrepancy (<$1 ignored)
- [x] **2.3** Verify all tests pass

### Task 3: Update Entity Exports (AC: 2)

- [x] **3.1** Export from `src/entities/transaction/utils/index.ts`
- [x] **3.2** Re-export from `src/entities/transaction/index.ts`

### Task 4: Remove Duplicate from subhandlers.ts (AC: 5)

- [x] **4.1** Delete `reconcileItemsTotal` function (lines 470-526)
- [x] **4.2** Delete related TRANSLATIONS import if only used by this function
- [x] **4.3** Add import: `import { reconcileItemsTotal } from '@entities/transaction'`
- [x] **4.4** Verify subhandlers still work

### Task 5: Update All Import Paths (AC: 3, 6)

- [x] **5.1** Update `src/features/scan/handlers/processScan/processScan.ts`
- [x] **5.2** Update `src/hooks/app/useScanHandlers.ts`
- [x] **5.3** Update `src/features/scan/hooks/useScanInitiation.ts` (no changes needed - receives as prop)
- [x] **5.4** Update `src/App.tsx` - remove function definition, import from entity
- [x] **5.5** Verify no grep results for local definitions

### Task 6: Update Test Imports (AC: 7)

- [x] **6.1** Remove reconcileItemsTotal tests from `subhandlers.test.ts`
- [x] **6.2** Update `useScanHandlers.test.ts` to mock entity import
- [x] **6.3** Verify all tests still pass

### Task 7: Verification (AC: 4)

- [x] **7.1** Run full test suite: `npm test` - 7,037 tests pass
- [x] **7.2** Run build: `npm run build` - SUCCESS
- [x] **7.3** Manual test: scan receipt where items don't match total
- [x] **7.4** Verify surplus item appears with correct name
- [x] **7.5** Verify discount item appears with correct name (items > total) - "Descuento/Ajuste" at -$18.00 ✓

---

## Technical Notes

### Function Signature (from subhandlers.ts)

```typescript
// src/entities/transaction/utils/reconciliation.ts
import type { TransactionItem } from '@/types';

/**
 * Reconcile items total with receipt total.
 *
 * If there's a discrepancy between items sum and receipt total,
 * adds an adjustment item to make them match:
 * - Positive difference (receipt > items): "Unitemized charge" / "Cargo sin detallar"
 * - Negative difference (items > receipt): "Discount/Adjustment" / "Descuento/Ajuste"
 *
 * Small discrepancies (<$1) are ignored to handle floating point rounding.
 *
 * @param items - Original items from scan
 * @param receiptTotal - Total from receipt
 * @param lang - Language for adjustment item name ('en' | 'es')
 * @returns Reconciled items and discrepancy info
 */
export function reconcileItemsTotal(
  items: TransactionItem[],
  receiptTotal: number,
  lang: 'en' | 'es'
): { items: TransactionItem[]; hasDiscrepancy: boolean; discrepancyAmount: number };
```

### TRANSLATIONS Constant

```typescript
const TRANSLATIONS = {
  en: {
    surplusItem: 'Unitemized charge',
    discountItem: 'Discount/Adjustment',
  },
  es: {
    surplusItem: 'Cargo sin detallar',
    discountItem: 'Descuento/Ajuste',
  },
};
```

### Files to Create

| File | Purpose |
|------|---------|
| `src/entities/transaction/utils/reconciliation.ts` | Utility function |
| `tests/unit/entities/transaction/utils/reconciliation.test.ts` | Unit tests |

### Files to Modify

| File | Change |
|------|--------|
| `src/entities/transaction/utils/index.ts` | Add export |
| `src/entities/transaction/index.ts` | Add re-export |
| `src/App.tsx` | Remove function (~25 lines), add import |
| `src/features/scan/handlers/processScan/subhandlers.ts` | Remove duplicate (~60 lines), add import |
| `src/features/scan/handlers/processScan/processScan.ts` | Update import |
| `src/hooks/app/useScanHandlers.ts` | Update import |
| `src/features/scan/hooks/useScanInitiation.ts` | Update type reference |
| `tests/unit/features/scan/handlers/processScan/subhandlers.test.ts` | Remove 10 tests |
| `tests/unit/hooks/app/useScanHandlers.test.ts` | Update mock |

### Lines Removed

| File | Lines Removed |
|------|--------------|
| App.tsx | ~25 lines (function definition) |
| subhandlers.ts | ~60 lines (duplicate + TRANSLATIONS) |
| **Total** | **~85 lines consolidated** |

---

## Definition of Done

- [x] AC1: Utility function extracted to entity
- [x] AC2: Correct location in transaction entity
- [x] AC3: All callers updated to import from entity
- [x] AC4: Tests consolidated and passing
- [x] AC5: Duplicate removed from subhandlers.ts
- [x] AC6: All import paths updated
- [x] AC7: Test imports updated
- [x] All 7,037 tests pass
- [x] Build succeeds
- [ ] Code reviewed and approved

---

## Sizing Assessment

| Metric | Value | Guideline | Status |
|--------|-------|-----------|--------|
| Tasks | 7 | ≤4 | LARGE |
| Subtasks | ~22 | ≤15 | LARGE |
| Files | 9 | ≤8 | AT LIMIT |

**Story Size: LARGE (3 pts)**

> Note: Story increased from 2 pts to 3 pts due to Atlas-discovered duplicate removal and test consolidation. Tasks are mostly mechanical (copy/delete/update imports) with low complexity.

---

## Dev Agent Record

### Implementation Plan

Extracted `reconcileItemsTotal` from three duplicate locations (App.tsx, subhandlers.ts, useScanHandlers.ts) to a single source of truth in the transaction entity module.

### Completion Notes

**Date:** 2026-01-30

**Summary:**
- Created `src/entities/transaction/utils/reconciliation.ts` with the pure function
- Migrated 10 tests to `tests/unit/entities/transaction/utils/reconciliation.test.ts`
- Updated all callers to import from `@entities/transaction`
- Removed ~58 lines from subhandlers.ts (function + TRANSLATIONS import)
- Removed ~40 lines from App.tsx (function definition)
- useScanHandlers.ts now uses a wrapper that binds `lang` from context

**Discoveries:**
- Found THREE duplicate implementations (story mentioned two):
  1. App.tsx lines 236-268
  2. subhandlers.ts lines 488-526
  3. useScanHandlers.ts lines 437-464 (useCallback wrapped)
- useScanInitiation.ts receives reconcileItemsTotal as a prop, so no import changes needed

**Test Results:**
- 7,037 tests pass (97 related tests verified)
- Build successful

---

## File List

### Created
- `src/entities/transaction/utils/reconciliation.ts`
- `tests/unit/entities/transaction/utils/reconciliation.test.ts`

### Modified
- `src/entities/transaction/utils/index.ts` - Added export
- `src/entities/transaction/index.ts` - Added re-export
- `src/App.tsx` - Removed function, added import
- `src/features/scan/handlers/processScan/subhandlers.ts` - Removed function + TRANSLATIONS import
- `src/features/scan/handlers/processScan/processScan.ts` - Updated import
- `src/hooks/app/useScanHandlers.ts` - Changed to wrapper around entity function
- `tests/unit/features/scan/handlers/processScan/subhandlers.test.ts` - Removed tests, updated import
- `tests/unit/hooks/app/useScanHandlers.test.ts` - Added entity mock
- `docs/sprint-artifacts/sprint-status.yaml` - Updated status

---

## Change Log

| Date | Change |
|------|--------|
| 2026-01-30 | Story implementation complete - all tasks done, 7,037 tests pass |
| 2026-01-30 | Manual verification complete - Descuento/Ajuste item appears correctly |
| 2026-01-30 | Code review fixes: Added test for non-number prices, runtime lang validation, updated JSDoc examples |
