# Story 14e.14: Extract Batch Review Handlers

Status: split

> **SPLIT 2026-01-25:** Story exceeded sizing limits (7 tasks, 30 subtasks).
> Split into 14e-14a, 14e-14b, 14e-14c, 14e-14d.
> See individual story files for implementation details.

## Story

As a **developer**,
I want **batch review handlers extracted to feature handlers**,
So that **batch logic is colocated with batch state and App.tsx is simplified**.

## Context

This story extracts ~9 batch review handlers from App.tsx (~300-400 lines) to `src/features/batch-review/handlers/`. These handlers currently orchestrate the batch review flow including navigation, editing, saving, and discard operations.

### Current Implementation

Batch handlers in `src/App.tsx` (lines ~1642-2014):
- `handleBatchConfirmWithCreditCheck` - Credit check before batch processing
- `handleBatchEditReceipt` - Edit a receipt during batch review
- `handleBatchPrevious` - Navigate to previous receipt
- `handleBatchNext` - Navigate to next receipt
- `handleBatchReviewBack` - Back navigation from batch review
- `handleBatchDiscardConfirm` - Confirm discard batch results
- `handleBatchDiscardCancel` - Cancel discard dialog
- `handleBatchSaveComplete` - Handle when save all completes
- `handleBatchSaveTransaction` - Save a single transaction during batch

### Dependency Chain

```
14e-1 (Zustand setup) â†’ 14e-12a/b (store) â†’ 14e-13 (selectors) â†’ 14e-14 (THIS) â†’ 14e-15 (components)
```

**Note:** This story can start in parallel with 14e-13 if store is complete, but handlers should use store actions where possible.

## Atlas Workflow Analysis

> ðŸ—ºï¸ Generated by Atlas workflow chain analysis

### Affected Workflows

| Workflow | Impact | Description |
|----------|--------|-------------|
| **#3: Batch Processing Flow** | DIRECT | Handlers orchestrate batch review phase |
| **#9: Scan Request Lifecycle** | INDIRECT | Batch review is sub-phase of scan |
| **#1: Scan Receipt Flow** | DOWNSTREAM | Batch mode feeds into review |

### Downstream Effects to Consider

1. **BatchReviewView** - Currently receives handlers via props from `useBatchReviewViewProps`
2. **useBatchReviewViewProps hook** - Already exists at `src/hooks/app/useBatchReviewViewProps.ts`
3. **App.tsx integration** - Handler definitions removed, imports added

### Testing Implications

- **Existing tests to verify:** `tests/unit/hooks/app/useBatchReviewViewProps.test.ts`
- **New scenarios to add:** Handler unit tests, store action integration tests

### Workflow Chain Visualization

```
BatchCapture â†’ [BATCH_COMPLETE] â†’ BatchReviewView â†’ [THIS STORY'S HANDLERS] â†’ Save/Discard â†’ Dashboard
```

## Acceptance Criteria

### AC1: Handler Directory Structure

**Given** Story 14e-1 completed (directory structure exists)
**When** this story is completed
**Then:**
- `src/features/batch-review/handlers/` directory exists
- Handler files follow naming convention: `{action}.ts`
- `src/features/batch-review/handlers/index.ts` exports all handlers

### AC2: Navigation Handlers Extracted

**Given** `handleBatchPrevious` and `handleBatchNext` in App.tsx
**When** reviewing `src/features/batch-review/handlers/navigation.ts`
**Then:**
- `navigateToPreviousReceipt(context: BatchNavigationContext)` extracted
- `navigateToNextReceipt(context: BatchNavigationContext)` extracted
- Context parameter includes: `scanState`, `setBatchEditingIndexContext`, `pendingTransaction`, `setPendingTransaction`, `navigateToView`
- Original functions in App.tsx replaced with handler imports

### AC3: Edit Handler Extracted

**Given** `handleBatchEditReceipt` in App.tsx
**When** reviewing `src/features/batch-review/handlers/editReceipt.ts`
**Then:**
- `editBatchReceipt(receipt: BatchReceipt, batchIndex: number, context: BatchEditContext)` extracted
- Context includes: `setBatchEditingIndexContext`, `setPendingTransaction`, `navigateToView`
- Handler sets thumbnail URL on transaction if present

### AC4: Save Handlers Extracted

**Given** `handleBatchSaveComplete` and `handleBatchSaveTransaction` in App.tsx
**When** reviewing `src/features/batch-review/handlers/save.ts`
**Then:**
- `saveBatchTransaction(transaction: Transaction, context: SaveContext)` extracted
- `handleSaveComplete(savedTransactions: Transaction[], context: SaveCompleteContext)` extracted
- Context includes: `services`, `user`, `batchProcessing`, `resetScanContext`, `setBatchImages`, `setShowBatchCompleteModal`, `setBatchSavedTransactions`, `navigateToView`
- Insight generation integrated for batch summary

### AC5: Discard Handlers Extracted

**Given** `handleBatchReviewBack`, `handleBatchDiscardConfirm`, `handleBatchDiscardCancel` in App.tsx
**When** reviewing `src/features/batch-review/handlers/discard.ts`
**Then:**
- `handleReviewBack(context: DiscardContext)` extracted - shows confirmation if results exist
- `confirmDiscard(context: DiscardContext)` extracted
- `cancelDiscard(context: DiscardContext)` extracted
- Context includes: `hasBatchReceipts`, `showScanDialog`, `dismissScanDialog`, `setBatchImages`, `batchProcessing`, `resetScanContext`, `setView`

### AC6: Credit Check Handler Extracted

**Given** `handleBatchConfirmWithCreditCheck` in App.tsx
**When** reviewing `src/features/batch-review/handlers/creditCheck.ts`
**Then:**
- `confirmWithCreditCheck(context: CreditCheckContext)` extracted
- Context includes: `userCredits`, `checkCreditSufficiency`, `setCreditCheckResult`, `setShowCreditWarning`
- Uses 1 super credit regardless of image count (batch pricing)

### AC7: App.tsx Integration

**Given** all handlers extracted
**When** reviewing App.tsx
**Then:**
- Original handler definitions removed
- Handlers imported from `@features/batch-review/handlers`
- Handler calls updated to use imported functions with context objects
- No changes to component interface/props
- ~300-400 lines removed from App.tsx

### AC8: Unit Tests

**Given** all handlers extracted
**When** running tests
**Then:**
- Unit tests exist for each handler file
- Tests verify:
  - Handler calls correct context methods
  - Navigation bounds checking (previous at 0, next at length-1)
  - Save transaction includes correct parameters
  - Discard flow shows confirmation when results exist
- All existing batch-related tests pass

## Tasks / Subtasks

- [ ] **Task 1: Create handler directory and types** (AC: 1)
  - [ ] 1.1 Create `src/features/batch-review/handlers/` directory
  - [ ] 1.2 Create `types.ts` with context interfaces (BatchNavigationContext, BatchEditContext, SaveContext, DiscardContext, CreditCheckContext)
  - [ ] 1.3 Create `index.ts` barrel export

- [ ] **Task 2: Extract navigation handlers** (AC: 2)
  - [ ] 2.1 Create `navigation.ts` with `navigateToPreviousReceipt` and `navigateToNextReceipt`
  - [ ] 2.2 Add bounds checking (previous at 0, next at length-1)
  - [ ] 2.3 Handle pendingTransaction update during navigation
  - [ ] 2.4 Write unit tests for navigation handlers

- [ ] **Task 3: Extract edit handler** (AC: 3)
  - [ ] 3.1 Create `editReceipt.ts` with `editBatchReceipt`
  - [ ] 3.2 Handle thumbnail URL injection into transaction
  - [ ] 3.3 Navigate to transaction-editor view
  - [ ] 3.4 Write unit tests for edit handler

- [ ] **Task 4: Extract save handlers** (AC: 4)
  - [ ] 4.1 Create `save.ts` with `saveBatchTransaction` and `handleSaveComplete`
  - [ ] 4.2 `saveBatchTransaction`: Auth check, Firestore save, return ID
  - [ ] 4.3 `handleSaveComplete`: Reset state, show batch complete modal, generate insights
  - [ ] 4.4 Write unit tests for save handlers

- [ ] **Task 5: Extract discard handlers** (AC: 5)
  - [ ] 5.1 Create `discard.ts` with `handleReviewBack`, `confirmDiscard`, `cancelDiscard`
  - [ ] 5.2 `handleReviewBack`: Check hasBatchReceipts, show confirmation dialog
  - [ ] 5.3 `confirmDiscard`: Dismiss dialog, reset state, navigate to dashboard
  - [ ] 5.4 `cancelDiscard`: Dismiss dialog only
  - [ ] 5.5 Write unit tests for discard handlers

- [ ] **Task 6: Extract credit check handler** (AC: 6)
  - [ ] 6.1 Create `creditCheck.ts` with `confirmWithCreditCheck`
  - [ ] 6.2 Use 1 super credit (batch pricing)
  - [ ] 6.3 Set credit check result and show warning
  - [ ] 6.4 Write unit tests for credit check handler

- [ ] **Task 7: App.tsx integration** (AC: 7, 8)
  - [ ] 7.1 Import handlers from `@features/batch-review/handlers`
  - [ ] 7.2 Create context objects for each handler call
  - [ ] 7.3 Replace handler calls with imported function calls
  - [ ] 7.4 Remove original handler definitions
  - [ ] 7.5 Verify all existing tests pass
  - [ ] 7.6 Run smoke test: batch capture â†’ review â†’ save flow

## Dev Notes

### Handler Extraction Pattern (from Epic 14c-refactor)

```typescript
// types.ts - Context interfaces
export interface BatchNavigationContext {
  scanState: ScanState;
  setBatchEditingIndexContext: (index: number | null) => void;
  pendingTransaction: Transaction | null;
  setPendingTransaction: (tx: Transaction | null) => void;
  navigateToView: (view: ViewType) => void;
}

// navigation.ts - Extracted handler
export function navigateToPreviousReceipt(context: BatchNavigationContext): void {
  const { scanState, setBatchEditingIndexContext, pendingTransaction, setPendingTransaction, navigateToView } = context;

  const batchReceipts = scanState.batchReceipts;
  const currentIndex = scanState.batchEditingIndex;

  if (!batchReceipts || currentIndex === null || currentIndex <= 0) return;

  const newIndex = currentIndex - 1;
  setBatchEditingIndexContext(newIndex);

  if (pendingTransaction) {
    const receipt = batchReceipts[newIndex];
    const transactionWithThumbnail = receipt.imageUrl
      ? { ...receipt.transaction, thumbnailUrl: receipt.imageUrl }
      : receipt.transaction;
    setPendingTransaction(transactionWithThumbnail);
    navigateToView('transaction-editor');
  }
}
```

### File Organization

```
src/features/batch-review/
  handlers/
    types.ts           # Context interfaces
    navigation.ts      # navigateToPreviousReceipt, navigateToNextReceipt
    editReceipt.ts     # editBatchReceipt
    save.ts            # saveBatchTransaction, handleSaveComplete
    discard.ts         # handleReviewBack, confirmDiscard, cancelDiscard
    creditCheck.ts     # confirmWithCreditCheck
    index.ts           # Barrel export
```

### Integration with useBatchReviewViewProps

The existing `useBatchReviewViewProps` hook (`src/hooks/app/useBatchReviewViewProps.ts`) composes props for BatchReviewView. After this story:

1. Hook imports handlers from `@features/batch-review/handlers`
2. Hook creates context objects from its dependencies
3. Hook wraps handlers with context injection

**Alternative:** If the hook is tightly coupled to App.tsx state, handlers may be called from App.tsx with context, and the hook just passes them through. Either approach is acceptable - choose based on least disruption.

### Dependencies

- **Depends on:** Story 14e-1 (directory structure), Story 14e-12a/b (store - optional, handlers can use existing patterns)
- **Blocks:** Story 14e-15 (batch review components), Story 14e-16 (orchestrator)

### Testing Strategy

1. **Unit tests** - Test each handler in isolation with mock context
2. **Integration** - Verify App.tsx handler calls work correctly
3. **Smoke test** - Manual test: batch capture â†’ review â†’ edit â†’ save flow

### Risk: Context Object Complexity

The handlers require many dependencies as context. This is expected and follows the pattern from Epic 14c-refactor (Story 14c-refactor.20). Accept this complexity for now - future stories will reduce it by migrating to Zustand store actions.

### References

- [Source: src/App.tsx:1642-2014 - Current batch handlers]
- [Source: src/hooks/app/useBatchReviewViewProps.ts - Existing composition hook]
- [Source: docs/sprint-artifacts/epic14c-refactor/stories/14c-refactor-20-app-handler-extraction.md - Handler extraction pattern]
- [Source: docs/sprint-artifacts/epic14e-feature-architecture/architecture-decision.md - Feature architecture]

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
