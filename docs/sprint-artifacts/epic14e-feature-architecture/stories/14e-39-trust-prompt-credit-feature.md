# Story 14e-39: Trust Prompt State to Credit Feature

Status: done

## Story Info

| Field | Value |
|-------|-------|
| Epic | 14e - Feature Architecture |
| Story ID | 14e-39 |
| Story Name | Trust Prompt State to Credit Feature |
| Priority | Medium |
| Points | 2 |
| Status | done |
| Created | 2026-01-29 |
| Updated | 2026-01-30 |
| Source | Pre-dev epic review - state consolidation |
| Atlas Enhanced | Yes |

---

## Story

As a **developer**,
I want **trust prompt state moved from App.tsx to the Credit feature**,
so that **credit-related UI state is centralized and App.tsx is simplified**.

---

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Workflow #8 (Trust Merchant Flow)** - DIRECT: Trust prompt is the entry point for this flow. State controls whether prompt is shown after scan save.
- **Workflow #1 (Scan Receipt Flow)** - INDIRECT: Trust prompt shown after scan save via processScan setting trustPromptData
- **Workflow #2 (Quick Save Flow)** - INDIRECT: shouldTriggerCreditCheck affects quick save path decision
- **Workflow #9 (Scan Lifecycle)** - INDIRECT: Credit check trigger is part of scan completion

### Downstream Effects to Consider

- `AppOverlays.tsx` currently receives trust props from App.tsx (lines 146-152, 209-212, 231-237) - needs update
- `useScanHandlers.ts` uses TrustPromptEligibility type - callbacks may need updates
- `processScan/types.ts` defines TrustPromptEligibility in handler context - verify compatibility

### Testing Implications

- **Existing tests to verify:** useTrustedMerchants tests, TrustMerchantPrompt tests, processScan integration tests
- **New scenarios to add:** Integration test for trust flow through CreditFeature, AppOverlays props interface tests

### Workflow Chain Visualization

```
processScan ‚Üí [trustPromptData] ‚Üí CreditFeature ‚Üí TrustMerchantPrompt ‚Üí Trust Decision ‚Üí merchantTrustService
```

---

## Background

### Problem Statement

Trust prompt state in App.tsx is related to credit/scan flows and should be managed by the Credit feature.

**Current state (App.tsx):**
```typescript
const [showTrustPrompt, setShowTrustPrompt] = useState(false);                              // line 544
const [trustPromptData, setTrustPromptData] = useState<TrustPromptEligibility | null>(null); // line 545
const [shouldTriggerCreditCheck, setShouldTriggerCreditCheck] = useState(false);             // line 547
```

### Impact

- Trust prompt logic scattered in App.tsx
- Credit feature should own all credit-related UI state
- ~30 lines of App.tsx could be removed

---

## Acceptance Criteria

### AC1: State Added to CreditFeature ~~useCreditState~~

> ‚ö†Ô∏è **Implementation Note (Code Review 2026-01-30):** State is managed as local useState in CreditFeature.tsx
> rather than in useCreditState hook. This is architecturally appropriate because trust prompt state is
> UI-local (dialog visibility) rather than shared credit data. Actions are exposed via context.

**Given** CreditFeature component exists
**When** trust prompt state needed
**Then:**
- [x] `showTrustPrompt` added (CreditFeature local state)
- [x] `trustPromptData` added (CreditFeature local state)
- [x] `shouldTriggerCreditCheck` added (CreditFeature local state, exposed via callback)

### AC2: Actions Implemented

**Given** the extended state
**When** managing trust prompts
**Then:**
- [x] `showTrustPromptAction(data)` action
- [x] `hideTrustPrompt()` action
- [x] `triggerCreditCheck()` / `clearCreditCheckTrigger()` (via onCreditActionsReady callback)

### AC3: CreditFeature Updated

**Given** state in CreditFeature
**When** CreditFeature renders
**Then:**
- [x] Manages TrustMerchantPrompt internally
- [x] Handles credit check trigger (via onCreditActionsReady callback pattern)
- [x] No props from App.tsx for trust state

### AC4: App.tsx Migration

**Given** state in credit feature
**When** App.tsx references trust state
**Then:**
- [x] useState calls removed (showTrustPrompt, trustPromptData, shouldTriggerCreditCheck)
- [x] Uses credit feature state via ref-based callback pattern
- [x] ~35 lines reduced (verified)

### AC5: Tests Pass

**Given** the migration
**When** running tests
**Then:**
- [x] Credit state tests updated (51 tests in CreditFeature.test.tsx)
- [x] All existing tests pass (88 tests in credit/batch-review modules)

### AC6: AppOverlays Integration (Atlas-suggested)

**Given** TrustMerchantPrompt currently rendered in AppOverlays
**When** trust state moved to CreditFeature
**Then:**
- [x] TrustMerchantPrompt moved to CreditFeature (Option A)
- [x] Trust props removed from AppOverlaysProps interface
- [x] No prop drilling for trust state

### AC7: Handler Callback Integration (Atlas-suggested)

**Given** processScan handlers set trust state
**When** handlers need to trigger trust prompt
**Then:**
- [x] Handlers use CreditFeature actions (via trustActionsRef/creditActionsRef)
- [x] processScan/types.ts verified - no changes needed (TrustPromptEligibility imported from @/types/trust)
- [x] useScanHandlers callbacks remain stable

---

## Tasks

### Task 1: Extend CreditFeature State ~~useCreditState~~ (AC: 1, 2)

- [x] **1.1** Add trust prompt state to CreditFeature (local useState)
- [x] **1.2** Add trust prompt actions (showTrustPromptAction, hideTrustPrompt)
- [x] **1.3** Add credit check trigger via onCreditActionsReady callback

### Task 2: Update CreditFeature (AC: 3)

- [x] **2.1** Render TrustMerchantPrompt internally
- [x] **2.2** Handle trust prompt callbacks (onAcceptTrust, onDeclineTrust)
- [x] **2.3** Remove trust props from interface (only callbacks remain)

### Task 3: Migrate App.tsx (AC: 4)

- [x] **3.1** Remove trust-related useState (showTrustPrompt, trustPromptData, shouldTriggerCreditCheck)
- [x] **3.2** Update handlers to use credit feature via ref callbacks
- [x] **3.3** Remove trust prop drilling

### Task 4: AppOverlays Integration (AC: 6)

- [x] **4.1** Decision: Move TrustMerchantPrompt to CreditFeature (Option A)
- [x] **4.2** Remove trust props from AppOverlaysProps interface
- [x] **4.3** Update App.tsx to not pass trust props to AppOverlays

### Task 5: Handler Callback Updates (AC: 7)

- [x] **5.1** Update handler context to use CreditFeature actions via refs
- [x] **5.2** Verify useScanHandlers/useBatchReviewHandlers callbacks work
- [x] **5.3** Verified processScan/types.ts - no changes needed

### Task 6: Update Tests (AC: 5)

- [x] **6.1** Trust state tests in CreditFeature.test.tsx (53 tests)
- [x] **6.2** CreditFeature tests updated for trust prompt rendering
- [x] **6.3** AppOverlays tests updated (removed trust props)
- [x] **6.4** Full test suite passing (88 tests in credit/batch modules)

### Review Follow-ups (AI)

> üîç Code review #1 performed 2026-01-30 by Claude Opus 4.5
> ‚úÖ All items resolved 2026-01-30 by Claude Opus 4.5

- [x] [AI-Review][HIGH] Remove duplicate `shouldTriggerCreditCheck` useState from App.tsx:628 - **RESOLVED**: useState removed, replaced with ref-based callback pattern (creditActionsRef)
- [x] [AI-Review][HIGH] Update AC1 to reflect actual implementation - **RESOLVED**: AC1 updated to document CreditFeature local state as architectural decision (UI-local state vs shared credit data)
- [x] [AI-Review][MEDIUM] Mark all task checkboxes (1.1-6.4) as complete - **RESOLVED**: All tasks marked complete
- [x] [AI-Review][MEDIUM] Fix misleading comment on App.tsx:627 - **RESOLVED**: Comment updated to explain useState removal and ref-based pattern
- [x] [AI-Review][MEDIUM] Verify processScan/types.ts per AC7 - **RESOLVED**: Verified - no changes needed (TrustPromptEligibility imported from @/types/trust, not defined in processScan/types.ts)
- [x] [AI-Review][LOW] Verify line reduction - **RESOLVED**: ~35 lines reduced confirmed (useState declarations + handler functions removed)

> üîç Code review #2 performed 2026-01-30 by Claude Opus 4.5
> ‚úÖ All items resolved 2026-01-30 by Claude Opus 4.5

- [x] [AI-Review][MEDIUM] `triggerCreditCheckAction` was dead code - set state but didn't trigger credit check - **RESOLVED**: Updated to call `handleBatchConfirmWithCreditCheck()` in addition to setting state (CreditFeature.tsx:382-388)
- [x] [AI-Review][MEDIUM] `shouldTriggerCreditCheck` flag not cleared when dialog closes - **RESOLVED**: Added `setShouldTriggerCreditCheck(false)` to both confirm (line 250) and cancel (line 280) handlers
- [x] [AI-Review][LOW] Test coverage gap for triggerCreditCheckAction - **RESOLVED**: Added tests verifying dialog opens and flag clears on confirm/cancel (CreditFeature.test.tsx - 2 new tests, now 53 total)
- [x] [AI-Review][LOW] Story file not tracked in git - **INFO**: Story file is untracked (??) - should be added before commit

---

## Technical Notes

### State Extension

```typescript
// src/features/credit/state/useCreditState.ts
interface CreditState {
  // Existing
  remaining: number;
  superRemaining: number;
  // New
  showTrustPrompt: boolean;
  trustPromptData: TrustPromptEligibility | null;
  shouldTriggerCreditCheck: boolean;
}

interface CreditActions {
  // Existing actions...
  // New
  showTrustPromptAction: (data: TrustPromptEligibility) => void;
  hideTrustPrompt: () => void;
  triggerCreditCheck: () => void;
  clearCreditCheckTrigger: () => void;
}
```

### Files to Modify

| File | Change |
|------|--------|
| `src/features/credit/state/useCreditState.ts` | Add trust state + actions |
| `src/features/credit/CreditFeature.tsx` | Manage TrustMerchantPrompt |
| `src/App.tsx` | Remove trust useState (~30 lines) |
| `src/components/App/AppOverlays.tsx` | Remove trust props from interface |
| `src/features/scan/handlers/processScan/types.ts` | Update context type if needed |
| `tests/unit/features/credit/` | Add trust state tests |

### Decision Point: TrustMerchantPrompt Location

**Option A (Recommended):** Move TrustMerchantPrompt rendering to CreditFeature.tsx
- Pros: True feature ownership, no context needed in AppOverlays
- Cons: Changes z-index layering (currently z-40 in AppOverlays)

**Option B:** Keep in AppOverlays, use CreditFeature context
- Pros: Preserves existing z-index layering
- Cons: Cross-component dependency, context prop drilling alternative

---

## Definition of Done

- [x] AC1: State added to CreditFeature (local useState, not useCreditState - see AC1 note)
- [x] AC2: Actions implemented
- [x] AC3: CreditFeature manages trust prompt
- [x] AC4: App.tsx migrated (~35 lines removed)
- [x] AC5: All tests pass (7012 tests)
- [x] AC6: AppOverlays integration complete (Atlas-suggested)
- [x] AC7: Handler callbacks updated (Atlas-suggested)
- [x] Code reviewed and approved (6 review items addressed 2026-01-30)

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No significant debug issues encountered.

### Completion Notes List

1. **Decision Made: Option A** - TrustMerchantPrompt rendering moved to CreditFeature.tsx
   - Trust prompt is now rendered directly by CreditFeature alongside CreditWarningDialog
   - Z-index layering preserved (uses same pattern as CreditWarningDialog)

2. **Ref-based Action Forwarding Pattern** - Used trustActionsRef in App.tsx to solve ordering problem
   - useScanHandlers is configured before CreditFeature context is available
   - CreditFeature exposes actions via onTrustActionsReady callback
   - App.tsx stores actions in ref, passes wrapper functions to useScanHandlers

3. **State Location** - Trust prompt state managed locally in CreditFeature (not in useCreditState)
   - State is UI-local (dialog visibility), not shared credit data
   - Actions exposed via context for external triggering

4. **Lines Reduced in App.tsx** - Approximately 35 lines removed:
   - Removed useState declarations for showTrustPrompt, trustPromptData, shouldTriggerCreditCheck
   - Removed handleAcceptTrust and handleDeclineTrust handler functions
   - Removed trust props from AppOverlays call
   - Replaced with trustActionsRef and wrapper callback pattern

5. **Test Updates**:
   - Removed TrustMerchantPrompt tests from AppOverlays.test.tsx (now in CreditFeature)
   - Added comprehensive trust prompt tests to CreditFeature.test.tsx (15+ new tests)
   - All 7012 tests pass

### File List

| File | Change |
|------|--------|
| `src/features/credit/CreditFeature.tsx` | Added trust prompt state, actions, TrustMerchantPrompt rendering, onCreditActionsReady callback, CreditTriggerActions interface |
| `src/App.tsx` | Removed trust useState (showTrustPrompt, trustPromptData, shouldTriggerCreditCheck), added trustActionsRef + creditActionsRef, added handleCreditActionsReady callback |
| `src/components/App/AppOverlays.tsx` | Removed trust props and TrustMerchantPrompt rendering |
| `src/features/batch-review/hooks/useBatchReviewHandlers.ts` | Uses setShouldTriggerCreditCheck callback (now ref-based wrapper) |
| `tests/unit/components/App/AppOverlays.test.tsx` | Removed TrustMerchantPrompt tests |
| `tests/unit/features/credit/CreditFeature.test.tsx` | Added trust prompt tests (53 tests) |

### Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-29 | Story created | Dev Agent |
| 2026-01-29 | Implementation complete | Dev Agent (Claude Opus 4.5) |
| 2026-01-30 | Code review #1: 6 action items added (2 HIGH, 3 MEDIUM, 1 LOW). Status ‚Üí in-progress | Code Review (Claude Opus 4.5) |
| 2026-01-30 | Addressed all 6 code review #1 findings: removed duplicate shouldTriggerCreditCheck, added creditActionsRef pattern, updated documentation | Dev Agent (Claude Opus 4.5) |
| 2026-01-30 | Code review #2: 4 action items (1 MEDIUM dead code, 1 MEDIUM flag not cleared, 2 LOW). Status ‚Üí in-progress | Code Review (Claude Opus 4.5) |
| 2026-01-30 | Addressed all 4 code review #2 findings: wired up triggerCreditCheckAction, added flag clearing on dialog close, added 2 tests | Dev Agent (Claude Opus 4.5) |
