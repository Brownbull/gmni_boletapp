# Story 14e-38: Expand useScanStore with UI Flags

## Story Info

| Field | Value |
|-------|-------|
| Epic | 14e - Feature Architecture |
| Story ID | 14e-38 |
| Story Name | Expand useScanStore with UI Flags |
| Priority | Medium |
| Points | 2 |
| Status | done |
| Created | 2026-01-29 |
| Updated | 2026-01-29 (Atlas workflow analysis) |
| Source | Pre-dev epic review - state consolidation |

---

## Background

### Problem Statement

Scan-related UI flags remain in App.tsx but belong logically with the scan store.

**Current state (App.tsx):**
```typescript
const [skipScanCompleteModal, setSkipScanCompleteModal] = useState(false);  // line 520
const [isRescanning, setIsRescanning] = useState(false);                     // line 544
```

### Impact

- State related to scan flow scattered outside scan store
- ~20 lines of App.tsx could be removed
- Cleaner scan state management

---

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis (2026-01-29)

### Affected Workflows

| Workflow | Impact | Risk |
|----------|--------|------|
| **Scan Receipt Flow (#1)** | `useScanStore` is central; adding flags consolidates scan state | LOW |
| **Quick Save Flow (#2)** | `skipScanCompleteModal` controls scan_complete dialog visibility | MEDIUM |
| **Batch Processing Flow (#3)** | `isRescanning` affects rescan button state during batch editing | LOW |

### Downstream Consumers

| File | Usages | Notes |
|------|--------|-------|
| `TransactionEditorViewInternal.tsx` | 14 | Primary consumer - controls modal visibility & rescan button |
| `EditView.tsx` | 8 | Secondary consumer - rescan button state |
| `TransactionEditorViewWrapper.tsx` | 4 | Props passthrough layer |
| `useTransactionEditorData.ts` | 6 | Hook layer - builds props object |
| `App.tsx` | 6 | Current source of truth - will migrate to store |

### Workflow Chain Visualization

```
App.tsx useState ‚Üí useTransactionEditorData ‚Üí TransactionEditorViewWrapper ‚Üí TransactionEditorViewInternal
                                                                           ‚Üò EditView (isRescanning only)
```

After migration:
```
useScanStore ‚Üê App.tsx (reads) ‚Üí passes props ‚Üí TransactionEditor consumers
             ‚Üê processScan (writes)
```

---

## Acceptance Criteria

### AC1: State Added to Store

**Given** useScanStore
**When** UI flags needed
**Then:**
- [x] `skipScanCompleteModal` added to state
- [x] `isRescanning` added to state
- [x] Initial values set correctly (both `false`)

### AC2: Actions Added

**Given** the expanded store
**When** managing UI flags
**Then:**
- [x] `setSkipScanCompleteModal(boolean)` action
- [x] `setIsRescanning(boolean)` action
- [x] Flags reset on `reset()` action

### AC3: App.tsx Migration

**Given** flags in store
**When** App.tsx uses them
**Then:**
- [x] useState calls removed from App.tsx
- [x] Uses store selectors to read values
- [x] processScan handler uses store actions to write values

### AC4: Tests Pass

**Given** the migration
**When** running tests
**Then:**
- [x] Store tests updated with new state/actions
- [x] All existing tests pass

### AC5: EditView Compatibility (Atlas)

**Given** `isRescanning` used in EditView.tsx (8 usages)
**When** the migration is complete
**Then:**
- [x] EditView receives `isRescanning` via props (unchanged consumer pattern)
- [x] Rescan button disabled state works correctly
- [x] Spinner animation works during rescan

### AC6: Consumer Access Pattern (Atlas)

**Given** multiple components need these flags
**When** implementing this story
**Then:**
- [x] Props passthrough pattern maintained (App.tsx reads store, passes to consumers)
- [x] `useTransactionEditorData` hook updated to receive values from caller
- [x] No direct store access in view components (keeps them testable)

### AC7: Test Coverage Verification (Atlas)

**Given** existing TransactionEditor tests
**When** migration is complete
**Then:**
- [x] All 79 useTransactionEditorStore tests still pass
- [x] TransactionEditorView tests work with mocked props
- [x] No test regressions in EditView tests

---

## Tasks

### Task 1: Extend Store State (AC: 1)

- [x] **1.1** Add `skipScanCompleteModal: boolean` to ScanState interface
- [x] **1.2** Add `isRescanning: boolean` to ScanState interface
- [x] **1.3** Update `initialScanState` with `false` defaults

### Task 2: Add Actions (AC: 2)

- [x] **2.1** Implement `setSkipScanCompleteModal(value: boolean)` action
- [x] **2.2** Implement `setIsRescanning(value: boolean)` action
- [x] **2.3** Update `reset()` to clear both flags to `false`

### Task 3: Add Selectors (AC: 3, 6)

- [x] **3.1** Add `useSkipScanCompleteModal()` selector hook
- [x] **3.2** Add `useIsRescanning()` selector hook
- [x] **3.3** Export new actions in `useScanActions` hook
- [x] **3.4** Update `src/features/scan/store/index.ts` barrel exports

### Task 4: Migrate App.tsx (AC: 3, 5, 6)

- [x] **4.1** Remove useState calls (lines ~520, ~544)
- [x] **4.2** Add store selector calls: `useSkipScanCompleteModal()`, `useIsRescanning()`
- [x] **4.3** Get store actions via `useScanActions()`
- [x] **4.4** Update processScan to use `scanActions.setSkipScanCompleteModal()` / `setIsRescanning()`
- [x] **4.5** Verify props still passed to `useTransactionEditorData` and view components

### Task 5: Update Store Tests (AC: 4, 7)

- [x] **5.1** Add unit tests for new state initialization
- [x] **5.2** Add unit tests for `setSkipScanCompleteModal` action
- [x] **5.3** Add unit tests for `setIsRescanning` action
- [x] **5.4** Add unit test verifying `reset()` clears both flags

### Task 6: Verify Consumer Tests (AC: 5, 7)

- [x] **6.1** Run TransactionEditorView tests - verify no regressions
- [x] **6.2** Run EditView tests - verify no regressions
- [x] **6.3** Run full test suite

### Review Follow-ups (Archie)

- [ ] [Archie-Review][LOW] Add renderHook tests for `useSkipScanCompleteModal` and `useIsRescanning` selectors [src/features/scan/store/__tests__/useScanStore.test.ts]
- [x] [Archie-Review][LOW] Update File List: test path should be `src/features/scan/store/__tests__/useScanStore.test.ts` not `tests/unit/...` (FIXED)
- [ ] [Archie-Review][LOW] Consider exporting `ScanUIState` type from index.ts for external type-checking

---

## Technical Notes

### Store Extension

```typescript
// Add to src/features/scan/store/useScanStore.ts

// State additions
interface ScanState {
  // ... existing state
  skipScanCompleteModal: boolean;  // Skip scan_complete dialog (QuickSaveCard flow)
  isRescanning: boolean;           // Rescan in progress (button disabled state)
}

// Initial state additions
const initialScanState: ScanState = {
  // ... existing
  skipScanCompleteModal: false,
  isRescanning: false,
};

// Actions
setSkipScanCompleteModal: (value: boolean) => set({ skipScanCompleteModal: value }, false, 'scan/setSkipScanCompleteModal'),
setIsRescanning: (value: boolean) => set({ isRescanning: value }, false, 'scan/setIsRescanning'),

// Update reset() to include:
reset: () => set({ ...initialScanState }, false, 'scan/reset'),
```

### Selector Hooks

```typescript
// Add to src/features/scan/store/selectors.ts

export const useSkipScanCompleteModal = () => useScanStore((state) => state.skipScanCompleteModal);
export const useIsRescanning = () => useScanStore((state) => state.isRescanning);
```

### Files to Modify

| File | Change |
|------|--------|
| `src/features/scan/store/useScanStore.ts` | Add state, initial values, and actions |
| `src/features/scan/store/selectors.ts` | Add selector hooks |
| `src/features/scan/store/index.ts` | Export new selectors and actions |
| `src/App.tsx` | Remove useState, use store selectors/actions |
| `src/features/scan/store/__tests__/useScanStore.test.ts` | Add tests for new state/actions |

### Consumer Pattern (Unchanged)

```typescript
// App.tsx pattern - reads from store, passes as props
const skipScanCompleteModal = useSkipScanCompleteModal();
const isRescanning = useIsRescanning();
const { setSkipScanCompleteModal, setIsRescanning } = useScanActions();

// Pass to useTransactionEditorData or views as props
// Consumer pattern unchanged - props still work for testing
```

---

## Definition of Done

- [x] AC1: State added to store
- [x] AC2: Actions implemented
- [x] AC3: App.tsx migrated
- [x] AC4: Store tests updated and passing
- [x] AC5: EditView compatibility verified
- [x] AC6: Consumer access pattern documented
- [x] AC7: All test suites pass (no regressions)
- [x] Code reviewed and approved (Archie review 2026-01-29, 3 LOW items logged)

---

## Story Sizing Verification

| Metric | Value | Guideline | Status |
|--------|-------|-----------|--------|
| Tasks | 6 | ‚â§4 | ‚ö†Ô∏è AT LIMIT |
| Subtasks | 19 | ‚â§15 | ‚ö†Ô∏è SLIGHTLY OVER |
| Files | 5 | ‚â§8 | ‚úÖ OK |

**Assessment:** MEDIUM (2 pts) - Story is at the upper limit but scope is well-defined and focused on a single concern (UI flags migration). No split recommended.

---

## Dev Agent Record

### Implementation Plan

- Created `ScanUIState` interface to extend scan store with UI-specific flags
- Extended `initialScanState` with `skipScanCompleteModal` and `isRescanning` (both `false`)
- Added actions `setSkipScanCompleteModal(boolean)` and `setIsRescanning(boolean)` to store
- Created selector hooks `useSkipScanCompleteModal()` and `useIsRescanning()`
- Added actions to `useScanActions` hook and `scanActions` direct access object
- Migrated App.tsx to use Zustand selectors instead of useState
- Added 12 comprehensive tests for new state/actions

### Debug Log

No issues encountered during implementation.

### Completion Notes

- ‚úÖ UI flags successfully migrated from App.tsx useState to useScanStore
- ‚úÖ Props passthrough pattern maintained (App.tsx reads store, passes to consumers)
- ‚úÖ All 90 scan store tests pass (12 new tests added)
- ‚úÖ All 6999 tests pass (no regressions)
- ‚úÖ TypeScript compilation successful

---

## File List

| Action | File |
|--------|------|
| Modified | `src/features/scan/store/useScanStore.ts` |
| Modified | `src/features/scan/store/selectors.ts` |
| Modified | `src/features/scan/store/index.ts` |
| Modified | `src/App.tsx` |
| Modified | `src/features/scan/store/__tests__/useScanStore.test.ts` |

---

## Change Log

| Date | Change |
|------|--------|
| 2026-01-29 | Story created with Atlas workflow analysis |
| 2026-01-29 | Implementation complete - 2 useState removed from App.tsx, migrated to Zustand |
| 2026-01-29 | Archie review complete - APPROVED with 3 LOW follow-up items |
