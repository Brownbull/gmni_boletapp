# Tech Debt Story TD-15-TD-22: Extract Print Helpers + i18n Migration

Status: done

> **Source:** ECC Code Review (2026-02-12) on story 15-TD-17
> **Priority:** LOW
> **Estimated Effort:** 2 points

## Story

As a **developer**,
I want **the print/PDF export logic extracted from ReportDetailOverlay into a dedicated `printUtils.ts` module with i18n-compliant strings**,
So that **ReportDetailOverlay stays under the 800-line limit and the print feature supports future localization**.

## Background

After 15-TD-17 (innerHTML sanitization), `ReportDetailOverlay.tsx` is at 835 lines — slightly over the 800-line project max. The `handlePrintReport` (115 lines) and `generatePdfFilename` (27 lines) functions are pure DOM/utility logic with no React dependencies, making them ideal extraction candidates. Additionally, the print function contains hardcoded `es-CL` locale and Spanish strings that should use the project's `translations.ts` i18n system.

## Acceptance Criteria

- [x] **AC1:** `handlePrintReport()` and `generatePdfFilename()` extracted to `src/features/reports/utils/printUtils.ts`
- [x] **AC2:** `ReportDetailOverlay.tsx` is under 800 lines after extraction (835 → 669 lines)
- [x] **AC3:** Hardcoded `es-CL` locale in `toLocaleDateString`/`toLocaleTimeString` replaced with locale constant or `translations.ts` mechanism
- [x] **AC4:** Hardcoded Spanish strings (`'Reporte generado automáticamente por Gastify'`, `'Este reporte es solo para uso personal.'`, `'transacción'`/`'transacciones'`, `'gastify.cl'`) replaced with `t()` calls
- [x] **AC5:** Existing print tests (`ReportDetailOverlay.print.test.ts`) updated to import from new module path
- [x] **AC6:** All tests pass (18 tests — 11 original + 7 new)

## Tasks

- [x] **Task 1:** Extract print utilities to `src/features/reports/utils/printUtils.ts`
  - [x] Move `handlePrintReport()` and `generatePdfFilename()` to new file
  - [x] Move `MONTH_ABBR` constant
  - [x] Update imports in `ReportDetailOverlay.tsx`
  - [x] Add re-export from feature barrel if needed
- [x] **Task 2:** Migrate hardcoded strings to i18n
  - [x] Add translation keys to `src/utils/translations.ts` for print-specific strings
  - [x] Replace hardcoded `es-CL` with locale from translations system
  - [x] Replace all hardcoded Spanish strings with `t()` calls
- [x] **Task 3:** Update tests
  - [x] Update test imports to new module path
  - [x] Verify all 11 print tests pass with new structure

## File Specification

| File | Action | Description |
|------|--------|-------------|
| `src/features/reports/utils/printUtils.ts` | CREATE | Extracted print helper functions |
| `src/features/reports/components/ReportDetailOverlay.tsx` | MODIFY | Remove print functions, import from printUtils |
| `src/utils/translations.ts` | MODIFY | Add print-specific translation keys |
| `tests/unit/features/reports/components/ReportDetailOverlay.print.test.ts` | MODIFY | Update imports |
| `src/features/reports/utils/index.ts` | MODIFY | Add printUtils barrel export |

## Dev Notes

- Source story: [15-TD-17](./15-TD-17-report-innerhtml-sanitization.md)
- Review findings: #1 (file size), #2 (hardcoded locale), #3 (hardcoded strings)
- All 3 findings are pre-existing, not introduced by 15-TD-17
- `handlePrintReport` has zero React dependencies — pure DOM API extraction is clean
- The `testHandlePrintReport` export pattern was eliminated — direct export from printUtils
- Added `lang: Language` parameter (default 'es') to `handlePrintReport` for i18n
- Locale derived via `lang === 'es' ? 'es-CL' : 'en-US'` (matches project pattern)
- 4 new translation keys: printAutoGenerated, printPersonalUseOnly, printBasedOn, printDomain
- MONTH_ABBR kept Spanish-only by design (brand consistency in PDF filenames)
- Print-only JSX fallback (Ctrl+P path) also i18n-migrated during review fixes
- ECC code review: APPROVE (2 MEDIUM pre-existing, 4 LOW polish — all addressed)
- ECC security review: APPROVE (0 blocking, defense-in-depth XSS pattern preserved)
- Week number approximation in printUtils.ts:25-28 is a known limitation (filename-only, not user-facing)

### Tech Debt Stories Created / Updated

| TD Story | Description | Priority | Action |
|----------|-------------|----------|--------|
| [15-TD-27](./15-TD-27-report-overlay-full-i18n.md) | ReportDetailOverlay full i18n migration (aria-labels + helper strings) | LOW | CREATED |

### Senior Developer Review (ECC)

- **Review date:** 2026-02-13
- **Classification:** SIMPLE
- **ECC agents used:** code-reviewer (9/10), tdd-guide (TEA 88/100)
- **Outcome:** APPROVE
- **Quick fixes applied:** 6 (inline t variable, 5 test coverage gaps)
- **TD stories created:** 1 (15-TD-27)
- **Total findings:** 9 (6 fixed, 3 deferred)
