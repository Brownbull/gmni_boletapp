# Story 14c.18: View Mode User Persistence

Status: ready-for-dev

## Story

As a shared group member,
I want my view mode preference (personal vs shared group) to be saved to my account,
so that when I log in from any device or after app restart, I automatically see the view I last selected.

## Problem Statement

The current view mode persistence has a **race condition bug** that causes data/UI mismatch:

1. **Current implementation** persists `viewMode` and `groupId` to **localStorage** only
2. **On app load**, the mode is restored from localStorage **before** group data loads from Firestore
3. **Race condition**: UI shows "group mode" header/styling but `activeTransactions` shows personal data
4. **User experience**: User sees shared group UI but personal transactions, causing confusion
5. **Multi-device issue**: Mode preference is device-local, doesn't sync across devices

Additionally:
- If a user is removed from a group, restoring that group ID causes errors
- localStorage can be cleared by the browser, losing preferences unexpectedly

## Acceptance Criteria

1. **AC1: Firestore Persistence** - Save view mode preference to Firestore at `users/{userId}/preferences/settings.viewModePreference`
2. **AC2: Preference Schema** - Store `{ mode: 'personal' | 'group', groupId?: string }` structure
3. **AC3: Load on Auth** - When user authenticates, load preference from Firestore before rendering views
4. **AC4: Validate Active Group** - Before restoring group mode, verify the user is still a member of that group
5. **AC5: Fallback to Personal** - If persisted group is invalid (deleted, user removed), fallback to personal mode
6. **AC6: Sync on Change** - When user changes mode, save to Firestore (debounced 1 second to avoid excessive writes)
7. **AC7: Offline Support** - Keep localStorage as fallback for offline scenarios; sync to Firestore when online
8. **AC8: Cross-Device Sync** - Mode changes on one device should be reflected on another after refresh

## Tasks / Subtasks

- [ ] Task 1: Extend user preferences schema (AC: #1, #2)
  - [ ] 1.1: Add `viewModePreference` field to `UserPreferences` type
  - [ ] 1.2: Update Firestore security rules to allow preference writes
  - [ ] 1.3: Create migration for existing users (default to personal)

- [ ] Task 2: Create preference persistence service (AC: #1, #6, #7)
  - [ ] 2.1: Add `saveViewModePreference()` function to `useUserPreferences` hook
  - [ ] 2.2: Implement debounced save (1 second delay)
  - [ ] 2.3: Handle offline scenarios with localStorage fallback

- [ ] Task 3: Update ViewModeContext (AC: #3, #4, #5)
  - [ ] 3.1: Accept initial preference from props (loaded from Firestore)
  - [ ] 3.2: Add `validateAndRestoreMode()` function
  - [ ] 3.3: Check group membership before restoring group mode
  - [ ] 3.4: Emit preference changes for persistence

- [ ] Task 4: Integrate with auth flow (AC: #3)
  - [ ] 4.1: Load `viewModePreference` in `useUserPreferences` hook
  - [ ] 4.2: Pass initial mode to `ViewModeProvider`
  - [ ] 4.3: Show loading state until preference is loaded

- [ ] Task 5: Add mode change listener (AC: #6, #8)
  - [ ] 5.1: Subscribe to Firestore preference changes
  - [ ] 5.2: Update local mode when remote changes detected
  - [ ] 5.3: Prevent loops when change originated locally

- [ ] Task 6: Testing (AC: All)
  - [ ] 6.1: Unit tests for preference save/load
  - [ ] 6.2: Unit tests for group validation on restore
  - [ ] 6.3: Unit tests for debounced save
  - [ ] 6.4: Integration test for cross-device sync scenario
  - [ ] 6.5: Test offline fallback behavior

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **View Mode Switching (Story 14c.4)**: Mode persistence doesn't work correctly across sessions
- **Data Source Switching**: `activeTransactions` switches before `sharedGroupTransactions` is populated
- **Multi-device usage**: Users can't sync mode preference across devices
- **User Authentication**: Auth flow must wait for preference load before rendering

### Downstream Effects to Consider

- User confusion when data doesn't match selected mode
- Lost productivity when users must re-select mode each session
- Potential data integrity issues if actions are performed in wrong mode
- Performance impact of additional Firestore read on auth

### Testing Implications

- **Existing tests to verify:** `tests/unit/contexts/ViewModeContext.test.tsx`, `tests/unit/hooks/useUserSharedGroups.test.tsx`
- **New scenarios to add:** Firestore persistence, group validation, race condition prevention

### Workflow Chain Visualization

```
User Login ‚Üí [THIS STORY: Load Preference] ‚Üí Validate Group ‚Üí Apply Mode ‚Üí Render Views
                                          ‚Ü≥ (if invalid) ‚Üí Fallback to Personal
Mode Change ‚Üí [THIS STORY: Save Preference] ‚Üí Debounce ‚Üí Firestore Write ‚Üí Cross-Device Sync
```

## Dev Notes

### Architecture Decision

**Selected Approach:** Firestore preference with localStorage fallback

Rationale:
- Firestore enables cross-device sync
- localStorage provides offline support
- Debounced writes minimize Firestore costs
- Group validation prevents invalid state

### Preference Document Structure

```typescript
// Firestore: users/{userId}/preferences/settings
interface UserSettings {
  // ... existing fields
  viewModePreference?: {
    mode: 'personal' | 'group';
    groupId?: string;  // Only present when mode === 'group'
    updatedAt: Timestamp;
  };
}
```

### Key Files to Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/types/user.ts` | Modify | Add viewModePreference to UserSettings type |
| `src/hooks/useUserPreferences.ts` | Modify | Add save/load for view mode preference |
| `src/contexts/ViewModeContext.tsx` | Modify | Accept initial preference, emit changes |
| `src/App.tsx` | Modify | Pass loaded preference to ViewModeProvider |
| `firestore.rules` | Modify | Allow viewModePreference writes |
| `tests/unit/contexts/ViewModeContext.test.tsx` | Modify | Add preference persistence tests |

### Race Condition Prevention

The key fix is to **delay view rendering** until the preference is loaded:

```typescript
// In App.tsx
const { viewModePreference, isLoading: prefsLoading } = useUserPreferences();

if (prefsLoading) {
  return <LoadingScreen />;
}

return (
  <ViewModeProvider initialPreference={viewModePreference}>
    {/* App content */}
  </ViewModeProvider>
);
```

### Debounce Strategy

```typescript
const savePreference = useMemo(
  () => debounce((pref: ViewModePreference) => {
    saveViewModePreference(db, userId, pref);
  }, 1000),
  [db, userId]
);
```

### Group Validation Logic

```typescript
function validateAndRestoreMode(
  preference: ViewModePreference,
  userGroups: SharedGroup[]
): ViewMode {
  if (preference.mode === 'personal') {
    return { mode: 'personal' };
  }

  // Verify user is still a member of the group
  const group = userGroups.find(g => g.id === preference.groupId);
  if (!group) {
    console.warn('Persisted group no longer accessible, falling back to personal');
    return { mode: 'personal' };
  }

  return { mode: 'group', groupId: preference.groupId, group };
}
```

### References

- [Source: src/contexts/ViewModeContext.tsx](src/contexts/ViewModeContext.tsx) - Current localStorage-only implementation
- [Source: src/hooks/useUserPreferences.ts](src/hooks/useUserPreferences.ts) - User preferences hook
- [Source: src/App.tsx](src/App.tsx) - ViewModeProvider integration point
- [Source: docs/sprint-artifacts/epic14/epic-14c-household-sharing.md](docs/sprint-artifacts/epic14/epic-14c-household-sharing.md) - Epic architecture

## Story Points

**Estimate:** 5 points

- Firestore schema and rules: 0.5 points
- Preference persistence service: 1.5 points
- ViewModeContext updates: 1 point
- Auth flow integration: 1 point
- Testing: 1 point
