# Story 14c.17: Share Link Deep Linking

Status: review

## Story

As a user receiving a shared group invite link,
I want to open the link on my device and be automatically guided to join the group,
so that I can join shared groups with minimal friction instead of manually entering share codes.

## Problem Statement

The current shared group invitation flow generates share links like `https://boletapp.web.app/join/{shareCode}`, but the app **does not handle these URLs**:

1. **Firebase Hosting** is correctly configured with SPA rewrites (`**` ‚Üí `/index.html`)
2. **Share links are generated** in `getShareLink()` at [sharedGroupService.ts:100](src/services/sharedGroupService.ts#L100)
3. **MISSING:** App doesn't parse `window.location.pathname` on startup to detect `/join/` URLs
4. **MISSING:** No join flow is triggered when a share link is opened
5. **Result:** Users clicking share links see the normal app (dashboard) with no indication of the pending invite

The `joinByShareCode()` function exists and is fully functional, but there's no entry point to call it from URL navigation.

## Acceptance Criteria

1. **AC1: URL Detection on Load** - On app initialization, detect if URL matches `/join/{shareCode}` pattern
2. **AC2: Authenticated User Flow** - If user is logged in, show join confirmation dialog with group preview
3. **AC3: Unauthenticated User Flow** - If user is not logged in:
   - Store `shareCode` in `sessionStorage`
   - Redirect to login screen
   - After successful auth, resume join flow with stored code
4. **AC4: Join Confirmation Dialog** - Display group name, color, member count, and owner name before joining
5. **AC5: Error Handling** - Handle and display errors for:
   - Invalid/not found share code
   - Expired share code
   - Group is full (10 members max)
   - User is already a member
6. **AC6: URL Cleanup** - After processing (success or error), clear the `/join/` path using `history.replaceState('/', '/')`
7. **AC7: Success Navigation** - After successfully joining, switch to group mode and navigate to dashboard

## Tasks / Subtasks

- [x] Task 1: Create URL parsing utility (AC: #1)
  - [x] 1.1: Create `parseShareCodeFromUrl()` in `src/utils/deepLinkHandler.ts`
  - [x] 1.2: Handle URL patterns: `/join/{code}`, `/join/{code}/`, `/join/{code}?...`
  - [x] 1.3: Validate share code format (16-char alphanumeric)

- [x] Task 2: Create Join Link Handler hook (AC: #1, #2, #3)
  - [x] 2.1: Create `useJoinLinkHandler` hook in `src/hooks/useJoinLinkHandler.ts`
  - [x] 2.2: Check URL on mount and when auth state changes
  - [x] 2.3: Store pending share code in `sessionStorage` when unauthenticated
  - [x] 2.4: Resume join flow after authentication

- [x] Task 3: Create Join Confirmation Dialog (AC: #4)
  - [x] 3.1: Create `JoinGroupDialog` component in `src/components/SharedGroups/JoinGroupDialog.tsx`
  - [x] 3.2: Display group preview (name, color, icon, member count)
  - [x] 3.3: Show "Join" and "Cancel" buttons
  - [x] 3.4: Handle loading state during join operation

- [x] Task 4: Integrate with App.tsx (AC: #1, #2, #3, #7)
  - [x] 4.1: Add `useJoinLinkHandler` hook to App component
  - [x] 4.2: Render `JoinGroupDialog` when pending join detected
  - [x] 4.3: On join success, call `setGroupMode()` and navigate to dashboard
  - [x] 4.4: Handle URL cleanup after processing

- [x] Task 5: Error handling (AC: #5, #6)
  - [x] 5.1: Display appropriate error messages for each error type
  - [x] 5.2: Offer "Request New Link" option for expired codes
  - [x] 5.3: Clear URL and close dialog on error acknowledgment

- [x] Task 6: Testing (AC: All)
  - [x] 6.1: Unit tests for `parseShareCodeFromUrl()`
  - [x] 6.2: Unit tests for `useJoinLinkHandler` hook
  - [x] 6.3: Component tests for `JoinGroupDialog`
  - [x] 6.4: Integration test for full join flow
  - [x] 6.5: Test unauthenticated flow with sessionStorage

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Household Sharing (Epic 14c)**: Core invite flow broken - users can create share codes but recipients cannot join via link
- **User Onboarding**: New users receiving invite links get confused/blocked from joining groups
- **View Mode Switching (14c.4)**: After successful join, should auto-switch to group mode

### Downstream Effects to Consider

- Group growth is blocked for external users
- Users revert to manual share code entry (worse UX)
- Share code expiry (7 days) creates urgency without working delivery mechanism
- Multi-device join flow (link opened on different device than link shared)

### Testing Implications

- **Existing tests to verify:** `tests/unit/services/sharedGroupService.leaveManage.test.ts`
- **New scenarios to add:** URL parsing, unauthenticated join flow, sessionStorage persistence

### Workflow Chain Visualization

```
Share Code Generated ‚Üí Link Shared ‚Üí [THIS STORY: URL Detection] ‚Üí Join Dialog ‚Üí Group Mode Active
                                   ‚Ü≥ (if unauth) ‚Üí Login ‚Üí Resume Join
```

## Dev Notes

### Architecture Decision

**Entry Point:** Add URL parsing to `src/main.tsx` or early in `App.tsx` before auth check.

The join link handler should:
1. Run on initial render
2. Check `window.location.pathname`
3. If `/join/{code}` detected, set pending join state
4. If authenticated ‚Üí show dialog immediately
5. If not authenticated ‚Üí store in sessionStorage, wait for auth

### Key Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/utils/deepLinkHandler.ts` | Create | URL parsing utility |
| `src/hooks/useJoinLinkHandler.ts` | Create | Hook for handling join links |
| `src/components/SharedGroups/JoinGroupDialog.tsx` | Create | Join confirmation UI |
| `src/App.tsx` | Modify | Integrate hook and dialog |
| `tests/unit/utils/deepLinkHandler.test.ts` | Create | Unit tests |
| `tests/unit/hooks/useJoinLinkHandler.test.ts` | Create | Hook tests |

### SessionStorage Key

```typescript
const PENDING_JOIN_CODE_KEY = 'boletapp_pending_join_code';
```

### Existing Functions to Reuse

- `getSharedGroupPreview()` - Get group info for confirmation dialog
- `joinByShareCode()` - Perform the actual join operation
- `setGroupMode()` - Switch to group mode after join

### Error Types (from sharedGroupService.ts)

```typescript
type JoinError = 'CODE_NOT_FOUND' | 'CODE_EXPIRED' | 'GROUP_FULL' | 'ALREADY_MEMBER';
```

### References

- [Source: src/services/sharedGroupService.ts](src/services/sharedGroupService.ts) - Share code utilities and join function
- [Source: src/contexts/ViewModeContext.tsx](src/contexts/ViewModeContext.tsx) - View mode switching
- [Source: firebase.json](firebase.json) - SPA rewrite configuration
- [Source: docs/sprint-artifacts/epic14/epic-14c-household-sharing.md](docs/sprint-artifacts/epic14/epic-14c-household-sharing.md) - Epic architecture

## Story Points

**Estimate:** 5 points

- URL parsing and validation: 1 point
- Join link handler hook: 1.5 points
- Join confirmation dialog: 1 point
- Integration and testing: 1.5 points

## File List

### New Files
- `src/utils/deepLinkHandler.ts` - URL parsing utility for share links
- `src/hooks/useJoinLinkHandler.ts` - Hook for managing join link flow
- `src/components/SharedGroups/JoinGroupDialog.tsx` - Join confirmation dialog
- `tests/unit/utils/deepLinkHandler.test.ts` - 18 unit tests
- `tests/unit/hooks/useJoinLinkHandler.test.ts` - 14 unit tests
- `tests/unit/components/SharedGroups/JoinGroupDialog.test.tsx` - 23 component tests

### Modified Files
- `src/App.tsx` - Added useJoinLinkHandler hook and JoinGroupDialog render

## Dev Agent Record

### Implementation Plan
1. Create URL parsing utility with TDD (RED-GREEN-REFACTOR)
2. Create join link handler hook with state machine
3. Create join group dialog component with accessibility
4. Integrate with App.tsx for root-level handling
5. Test all scenarios including error cases

### Debug Log
- No significant issues encountered
- Followed existing dialog patterns from LeaveGroupDialog
- Used existing sharedGroupService functions (joinByShareCode, getSharedGroupPreview)

### Completion Notes
- **55 new tests added** (18 URL parsing + 14 hook + 23 component)
- **Build passes** with no type errors
- **All acceptance criteria satisfied**:
  - AC1: URL Detection on Load ‚úÖ
  - AC2: Authenticated User Flow ‚úÖ
  - AC3: Unauthenticated User Flow ‚úÖ
  - AC4: Join Confirmation Dialog ‚úÖ
  - AC5: Error Handling ‚úÖ
  - AC6: URL Cleanup ‚úÖ
  - AC7: Success Navigation ‚úÖ

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2026-01-19 | Claude (Atlas Dev Story) | Initial implementation |
