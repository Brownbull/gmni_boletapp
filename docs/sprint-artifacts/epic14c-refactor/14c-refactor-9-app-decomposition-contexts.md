# Story 14c-refactor.9: App.tsx Decomposition - Contexts (Non-Scan)

Status: ready-for-dev

## Story

As a **developer**,
I want **non-scan App.tsx contexts extracted into separate files**,
So that **the main App component is smaller and concerns are separated**.

## Prerequisites

- **PRESERVE** existing `ScanContext` from Epic 14d-old (`src/contexts/ScanContext.tsx`)
- This story extracts **only non-scan** contexts
- Prior art: Epic 14d-old completed 31 scan state variable migration

## Acceptance Criteria

### Core Extractions

1. **AC1**: Create `AuthContext.tsx` in `src/contexts/` directory
   - Extract authentication state (`user`, `services`, `initError`)
   - Extract authentication methods (`signIn`, `signInWithTestCredentials`, `signOut`)
   - Refactor existing `useAuth()` hook to be context-based
   - Export `AuthProvider`, `useAuth`, and `AuthContext`

2. **AC2**: Create `NavigationContext.tsx` in `src/contexts/` directory
   - Extract view state (`view`, `previousView`, `settingsSubview`)
   - Extract navigation methods (`setView`, `setSettingsSubview`)
   - Export `NavigationProvider`, `useNavigation`, and `NavigationContext`

3. **AC3**: Create `ThemeContext.tsx` in `src/contexts/` directory
   - Extract theme preferences (`theme`, `colorTheme`, `fontColorMode`, `fontSize`, `fontFamily`)
   - Extract language/locale settings (`lang`, `dateFormat`)
   - Extract persistence logic (localStorage sync)
   - Export `ThemeProvider`, `useTheme`, and `ThemeContext`

4. **AC4**: Create `NotificationContext.tsx` in `src/contexts/` directory
   - Extract in-app notification state (`inAppNotifications`, `unreadCount`)
   - Extract notification methods (`markAsRead`, `markAllAsRead`, `deleteNotification`)
   - Export `NotificationProvider`, `useNotifications`, and `NotificationContext`

5. **AC5**: Create `AppStateContext.tsx` in `src/contexts/` directory
   - Extract app-wide state (`toastMessage`, `wiping`, `exporting`)
   - Extract toast management methods (`setToastMessage`)
   - Export `AppStateProvider`, `useAppState`, and `AppStateContext`

### Integration Requirements

6. **AC6**: **ScanContext remains unchanged** - do NOT modify or duplicate
   - Provider composition must maintain ScanContext at correct level
   - Auth state must be available before ScanContext children mount

7. **AC7**: App.tsx imports and composes these providers alongside ScanContext
   - Provider composition order maintained (see Tasks for order)

8. **AC8**: App.tsx reduced by ~500-700 lines (non-scan portions)

9. **AC9**: All existing functionality preserved
   - No regressions in auth, navigation, or theme behavior
   - Authâ†’Scanâ†’Save critical path works unchanged

### Testing Requirements

10. **AC10**: Each context file exports custom hook (e.g., `useAuth`, `useNavigation`)

11. **AC11**: No additional renders introduced by context extraction

## Atlas Workflow Analysis

> ðŸ—ºï¸ Generated by Atlas workflow chain analysis

### Affected Workflows

| Workflow | Impact |
|----------|--------|
| **#1 Scan Receipt Flow** | Auth timing affects user.uid availability for scan operations |
| **#9 Scan Request Lifecycle** | ScanContext preserved, but AuthProvider placement critical |
| **#4 Analytics Navigation Flow** | Navigation context affects view switching |
| **#8 Trust Merchant Flow** | Trust uses user.uid from auth context |

### Downstream Effects

- Authâ†’Scanâ†’Save Critical Path: Auth state must be available BEFORE ScanContext actions
- Push Notification Flow: NotificationContext must coordinate with FCM registration
- Theme Persistence: ThemeContext must preserve localStorage sync patterns

### Testing Implications

- **Existing tests to verify**: Auth flow tests, context integration tests, view navigation tests
- **New scenarios to add**: Context provider composition, auth timing, theme persistence

## Tasks / Subtasks

- [ ] **Task 1: AuthContext extraction** (AC: #1, #6)
  - [ ] 1.1: Create `src/contexts/AuthContext.tsx` with provider and hook
  - [ ] 1.2: Move `user`, `services`, `initError` state to context
  - [ ] 1.3: Move `signIn`, `signInWithTestCredentials`, `signOut` methods
  - [ ] 1.4: Update existing `useAuth()` hook signature for backwards compatibility
  - [ ] 1.5: Add AuthProvider to main.tsx (wrap before ScanProvider)

- [ ] **Task 2: NavigationContext extraction** (AC: #2)
  - [ ] 2.1: Create `src/contexts/NavigationContext.tsx` with provider and hook
  - [ ] 2.2: Move `view`, `previousView`, `settingsSubview` state
  - [ ] 2.3: Move `setView`, `setPreviousView`, `setSettingsSubview` methods
  - [ ] 2.4: Export `useNavigation()` hook
  - [ ] 2.5: Add NavigationProvider to App.tsx or AppProviders.tsx

- [ ] **Task 3: ThemeContext extraction** (AC: #3)
  - [ ] 3.1: Create `src/contexts/ThemeContext.tsx` with provider and hook
  - [ ] 3.2: Move `theme`, `colorTheme`, `fontColorMode`, `fontSize` state
  - [ ] 3.3: Move `lang`, `dateFormat` locale settings
  - [ ] 3.4: Move localStorage persistence effects
  - [ ] 3.5: Export `useTheme()` hook
  - [ ] 3.6: Integrate with existing `fontFamily` from userPreferences

- [ ] **Task 4: NotificationContext extraction** (AC: #4)
  - [ ] 4.1: Create `src/contexts/NotificationContext.tsx` with provider and hook
  - [ ] 4.2: Move `inAppNotifications`, `unreadCount` state
  - [ ] 4.3: Move `markAsRead`, `markAllAsRead`, `deleteNotification` methods
  - [ ] 4.4: Keep pending invitations with their own hook (not part of this context)
  - [ ] 4.5: Export `useNotifications()` hook

- [ ] **Task 5: AppStateContext extraction** (AC: #5)
  - [ ] 5.1: Create `src/contexts/AppStateContext.tsx` with provider and hook
  - [ ] 5.2: Move `toastMessage`, `wiping`, `exporting` state
  - [ ] 5.3: Move toast auto-dismiss effect
  - [ ] 5.4: Export `useAppState()` hook

- [ ] **Task 6: Provider composition** (AC: #7, #8)
  - [ ] 6.1: Update `main.tsx` provider composition order:
    ```
    QueryClientProvider (existing)
      â””â”€â”€ AuthProvider (NEW - needs to wrap for user.uid)
            â””â”€â”€ ViewModeProvider (existing)
                  â””â”€â”€ ScanProvider (existing - PRESERVE)
                        â””â”€â”€ ThemeProvider (NEW)
                              â””â”€â”€ NavigationProvider (NEW)
                                    â””â”€â”€ NotificationProvider (NEW)
                                          â””â”€â”€ AppStateProvider (NEW)
                                                â””â”€â”€ ErrorBoundary (existing)
                                                      â””â”€â”€ App
    ```
  - [ ] 6.2: Verify ScanContext receives auth state correctly
  - [ ] 6.3: Remove extracted state/methods from App.tsx
  - [ ] 6.4: Update App.tsx to use new context hooks

- [ ] **Task 7: Testing and validation** (AC: #9, #10, #11)
  - [ ] 7.1: Run existing test suite - all tests must pass
  - [ ] 7.2: Add basic context tests for each new context
  - [ ] 7.3: Verify auth flow works (login, logout)
  - [ ] 7.4: Verify theme persistence (refresh page, check localStorage)
  - [ ] 7.5: Verify navigation works (view switching, settings subviews)
  - [ ] 7.6: Verify toast notifications display correctly

## Dev Notes

### Current App.tsx State Variables to Extract

**Auth (Task 1):**
- `user` - Current authenticated Firebase user
- `services` - Firebase services (auth, db, appId)
- `initError` - Initialization error state
- Methods: `signIn()`, `signInWithTestCredentials()`, `signOut()`

**Navigation (Task 2):**
- `view` - Current view type ('dashboard', 'scan', 'trends', etc.)
- `previousView` - Previous view for back navigation
- `settingsSubview` - Settings sub-page state

**Theme (Task 3):**
- `lang` - Language setting ('en' | 'es')
- `currency` - Currency format (note: this might belong to preferences)
- `theme` - Light/dark mode
- `dateFormat` - Date format preference
- `colorTheme` - Color theme ('normal', 'professional', 'mono')
- `fontColorMode` - Font color mode ('colorful', 'plain')
- `fontSize` - Font size ('small', 'normal')

**Notifications (Task 4):**
- `inAppNotifications` - Array of in-app notifications
- `unreadCount` - Number of unread notifications
- Methods: `markAsRead()`, `markAllAsRead()`, `deleteNotification()`

**App State (Task 5):**
- `toastMessage` - Current toast notification
- `wiping` - Data wipe in progress flag
- `exporting` - Data export in progress flag

### State to KEEP in App.tsx (scan-related, already in ScanContext)

These are managed by ScanContext from Epic 14d-old - DO NOT extract:
- `scanState` (via `useScan()`)
- `scanImages`, `scanError`, `isAnalyzing` (via context wrappers)
- `scanStoreType`, `scanCurrency`, `scanButtonState`
- All batch processing state

### Architecture Patterns

**Context Pattern:**
```typescript
// Example: AuthContext.tsx
import { createContext, useContext, ReactNode } from 'react';

interface AuthContextValue {
  user: User | null;
  services: Services | null;
  initError: string | null;
  signIn: () => Promise<void>;
  signOut: () => Promise<void>;
}

const AuthContext = createContext<AuthContextValue | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  // ... state and methods from useAuth hook logic
  return (
    <AuthContext.Provider value={{ user, services, initError, signIn, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within AuthProvider');
  return context;
}
```

### Project Structure Notes

- Contexts directory: `src/contexts/`
- Existing contexts: `AnalyticsContext.tsx`, `ScanContext.tsx`, `HistoryFiltersContext.tsx`, `ViewModeContext.tsx`
- Provider composition in: `src/main.tsx`

### Exclusions (Already Done in Epic 14d-old)

These are PRESERVED and NOT modified:
- ScanContext
- Scan state machine
- Scan dialogs (currency, total, quicksave)
- Batch processing state
- FAB mode state

### References

- [Source: docs/sprint-artifacts/epic14c-refactor/tech-context-epic14c-refactor.md#Part 2: App Architecture Refactor]
- [Source: docs/sprint-artifacts/epic14c-refactor/epics.md#Story 14c.9]
- [Source: _bmad/agents/atlas/atlas-sidecar/knowledge/04-architecture.md#Provider Placement]
- [Source: _bmad/agents/atlas/atlas-sidecar/knowledge/08-workflow-chains.md#Critical Paths]

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

Files to create:
- `src/contexts/AuthContext.tsx`
- `src/contexts/NavigationContext.tsx`
- `src/contexts/ThemeContext.tsx`
- `src/contexts/NotificationContext.tsx`
- `src/contexts/AppStateContext.tsx`

Files to modify:
- `src/main.tsx` - Add AuthProvider
- `src/App.tsx` - Remove extracted state, use context hooks
- `src/hooks/useAuth.ts` - May be refactored or deprecated in favor of AuthContext

Files to preserve (DO NOT modify):
- `src/contexts/ScanContext.tsx`
- `src/contexts/ViewModeContext.tsx`
- `src/contexts/AnalyticsContext.tsx`
- `src/contexts/HistoryFiltersContext.tsx`

**Points:** 5
