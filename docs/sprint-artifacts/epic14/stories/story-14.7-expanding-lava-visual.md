# Story 14.7: Expanding Lava Visual

**Status:** done
**Points:** 3
**Epic:** 14 - Core Implementation
**Dependencies:** Story 14.5 (Dynamic Polygon Component), Story 14.6 (Polygon Dual Mode)

---

## Story

As a **user tracking my budget**,
I want **to see my spending polygon (lava) expand toward my budget polygon**,
so that **I can visually understand how close I am to my limits**.

## Acceptance Criteria

1. **Inner polygon** represents actual spending (warm colors: red/orange)
2. **Outer polygon** represents budget target (cool colors: green/blue)
3. **Visual tension** increases as spending approaches budget (color intensifies)
4. **Budget proximity indicators** show percentage at each vertex
5. **Over-budget state** - inner polygon exceeds outer with warning styling
6. **Animation on data change** - polygons animate when spending updates

## Tasks / Subtasks

- [x] Task 1: Create LavaOverlay component (AC: #1, #2)
  - [x] Create `src/components/polygon/LavaOverlay.tsx`
  - [x] Render two nested polygons in SVG
  - [x] Inner polygon = spending data
  - [x] Outer polygon = budget data

- [x] Task 2: Implement color system (AC: #1, #2)
  - [x] Define LAVA_COLORS constants
  - [x] Warm colors for spending (gradient red â†’ orange)
  - [x] Cool colors for budget (gradient green â†’ blue)
  - [x] Support dark mode variants

- [x] Task 3: Add visual tension effect (AC: #3)
  - [x] Calculate spending/budget ratio per vertex
  - [x] Intensify spending color as ratio increases
  - [x] Add glow effect when ratio > 80%

- [x] Task 4: Implement proximity indicators (AC: #4)
  - [x] Show percentage at each vertex (e.g., "75%")
  - [x] Position indicators between polygons
  - [x] Color code by threshold (green < 75%, yellow 75-90%, red > 90%)

- [x] Task 5: Handle over-budget state (AC: #5)
  - [x] Inner polygon exceeds outer visually
  - [x] Solid red color for over-budget vertices
  - [x] Pulsing warning animation
  - [x] Clear visual indicator

- [x] Task 6: Add data change animation (AC: #6)
  - [x] Animate polygon expansion on spending update
  - [x] Smooth transition between states
  - [x] Use spring easing for natural feel

- [x] Task 7: Write tests
  - [x] Test polygon layering
  - [x] Test proximity calculations
  - [x] Test over-budget state
  - [x] Test animations

## Dev Notes

### Color System

**From tech-context-epic14.md:**
```typescript
const LAVA_COLORS = {
  SPENDING: 'rgba(239, 68, 68, 0.7)',   // red-500 with opacity
  BUDGET: 'rgba(34, 197, 94, 0.3)',     // green-500 with opacity
  DANGER: 'rgba(239, 68, 68, 1)',       // solid red when over budget
  WARNING: 'rgba(245, 158, 11, 0.8)',   // amber-500 for approaching limit
};
```

### Visual Concept

```
       Budget (outer, green)
          /\
         /  \
        / ** \    ** = Spending (inner, red)
       /  **  \       Growing toward budget
      /   **   \
     /____**____\
```

### Proximity Calculation

```typescript
interface VertexProximity {
  category: string;
  spending: number;
  budget: number;
  ratio: number;  // 0-1+ (can exceed 1 if over budget)
  status: 'safe' | 'warning' | 'danger' | 'over';
}

function calculateProximity(spending: number, budget: number): VertexProximity['status'] {
  const ratio = spending / budget;
  if (ratio > 1) return 'over';
  if (ratio > 0.9) return 'danger';
  if (ratio > 0.75) return 'warning';
  return 'safe';
}
```

### SVG Layering

```svg
<svg>
  <!-- Outer budget polygon (background) -->
  <polygon class="budget-polygon" points="..." fill="var(--budget-fill)" />

  <!-- Inner spending polygon (foreground) -->
  <polygon class="spending-polygon" points="..." fill="var(--spending-fill)" />

  <!-- Proximity indicators at vertices -->
  <g class="proximity-indicators">
    <!-- Labels positioned between polygons -->
  </g>
</svg>
```

### References

- [Source: docs/sprint-artifacts/epic14/tech-context-epic14.md#Story 14.7]
- [Source: docs/uxui/mockups/01_views/home-dashboard.html]
- [Source: docs/uxui/motion-design-system.md#Breathing Effect Specification]

---

## Atlas Workflow Analysis

> ðŸ—ºï¸ This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Analytics Navigation Flow (#2)**: Lava visual is primary analytics entry point
- No direct workflow dependencies - this is a visualization enhancement

### Downstream Effects to Consider

- Budget data needs to be available (may need Story 15.1 for custom goals)
- For MVP, can use learned budget thresholds or default percentages
- Over-budget state may trigger insights (connects to Insight Generation)

### Testing Implications

- **Existing tests to verify:** DynamicPolygon tests from 14.5
- **New scenarios to add:** Dual polygon rendering, proximity calculations, over-budget state

### Workflow Chain Visualization

```
[14.5 Polygon] â†’ [14.6 Dual Mode] â†’ [THIS STORY: Lava Visual] â†’ [Analytics UX Complete]
```

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

1. **LavaOverlay Component Created** - Full dual-polygon SVG visualization with:
   - Inner spending polygon (warm red/orange gradient)
   - Outer budget polygon (cool green with transparency)
   - Vertex circles for each category
   - Proper SVG layering with budget behind spending

2. **LAVA_COLORS System Implemented** - Complete color palette:
   - SPENDING: rgba(239, 68, 68, 0.7) - red-500 with opacity
   - BUDGET: rgba(34, 197, 94, 0.3) - green-500 with opacity
   - DANGER: rgba(239, 68, 68, 1) - solid red for over-budget
   - WARNING: rgba(245, 158, 11, 0.8) - amber for approaching limit
   - SAFE: rgba(34, 197, 94, 1) - green for safe spending
   - Dark mode variants for all colors

3. **Visual Tension Effects** - Dynamic color intensification:
   - calculateProximity() function with status thresholds
   - Glow filter for vertices with >80% spending ratio
   - Radial gradient for spending polygon

4. **Proximity Indicators** - Percentage display at each vertex:
   - Positioned outside budget polygon
   - Color-coded: green (<75%), yellow (75-90%), red (>90%)
   - Smart text anchoring based on position

5. **Over-Budget Handling** - Clear warning states:
   - Inner polygon can exceed outer visually
   - Solid red color for over-budget vertices
   - CSS animate-pulse class for warning effect
   - Percentage shows >100% values

6. **Data Change Animation** - Smooth transitions:
   - CSS transitions with spring easing (EASING.SPRING)
   - 300ms duration for polygon and vertex changes
   - Respects prefers-reduced-motion

7. **Comprehensive Tests** - 31 tests covering:
   - Dual polygon rendering (AC #1, #2)
   - Proximity calculations (AC #3)
   - Indicator display (AC #4)
   - Over-budget state (AC #5)
   - Animation behavior (AC #6)
   - Edge cases and accessibility
   - Negative value edge cases (added during code review)

### File List

**New Files:**
- src/components/polygon/LavaOverlay.tsx (463 lines)
- tests/unit/components/polygon/LavaOverlay.test.tsx (310 lines)

**Modified Files:**
- src/components/polygon/index.ts (added LavaOverlay exports)
- docs/sprint-artifacts/sprint-status.yaml (status update)

### Code Review Fixes (Atlas-Enhanced Review 2026-01-01)

1. **MEDIUM: Fixed Hardcoded Glow Filter ID** - Changed `id="glow"` to unique `id={glowFilterId}` using `useMemo(() => \`lava-glow-${Math.random().toString(36).slice(2, 11)}\`, [])`. Prevents ID collision when multiple LavaOverlay components are rendered on same page. (Pattern #51)

2. **LOW: Added Negative Value Edge Case Tests** - Added 2 tests for `calculateProximity()` with negative spending/budget values. Function correctly returns negative ratios which evaluate as 'safe' status.

3. **LOW: Removed Unused Type Import** - Removed unused `LavaOverlayProps` type import from test file.

4. **LOW: Updated Glow Filter Test** - Updated test to check for dynamic `lava-glow-*` filter ID pattern instead of hardcoded `#glow`.
