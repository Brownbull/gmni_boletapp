# Story 14.8: Enhanced Existing Charts

**Status:** done
**Points:** 3
**Epic:** 14 - Core Implementation
**Dependencies:** Story 14.1 (Animation Framework)

---

## Story

As a **user viewing analytics charts**,
I want **animated transitions and count-up effects on charts**,
so that **data visualization feels dynamic and engaging**.

## Acceptance Criteria

1. **Animated count-up** for money values when charts load (300-500ms)
2. **Entry animations** - charts fade in and scale up on initial render
3. **Breathing effects** on hover/focus for interactive chart elements
4. **Consistent styling** with new design system variables
5. **Reduced motion support** - instant display without animations when preferred
6. **Touch feedback** on chart segments with subtle scale animation

## Tasks / Subtasks

- [x] Task 1: Add count-up animation for values (AC: #1)
  - [x] Create useCountUp hook for animating numbers
  - [x] Apply to total amounts in charts
  - [x] CLP formatting during animation
  - [x] Duration: 300-500ms per motion-design-system.md

- [x] Task 2: Implement entry animations (AC: #2)
  - [x] Add fade-in + scale animation to SimplePieChart
  - [x] Add fade-in + scale animation to GroupedBarChart
  - [x] Stagger bar animations in grouped charts
  - [x] Use animation constants from 14.1

- [x] Task 3: Add breathing on hover/focus (AC: #3)
  - [x] Apply subtle scale on hover (1.02x)
  - [x] Apply focus ring for keyboard navigation
  - [x] Use useBreathing hook for subtle pulse

- [x] Task 4: Update chart styling (AC: #4)
  - [x] Use CSS variables from design system
  - [x] Update colors to match mockup palette
  - [x] Ensure dark mode compatibility

- [x] Task 5: Add reduced motion support (AC: #5)
  - [x] Use useReducedMotion hook
  - [x] Instant count-up without animation
  - [x] Static charts without entry animation

- [x] Task 6: Implement touch feedback (AC: #6)
  - [x] Add touchstart/touchend handlers
  - [x] Scale segment on touch (0.95x press, 1.05x release)
  - [x] Brief haptic feedback on tap

- [x] Task 7: Write tests
  - [x] Test count-up animation with mock timers
  - [x] Test entry animation triggers
  - [x] Test reduced motion behavior

## Dev Notes

### Existing Chart Components

- `src/components/charts/SimplePieChart.tsx` - Recharts pie chart
- `src/components/charts/GroupedBarChart.tsx` - Recharts bar chart

### Count-Up Hook Pattern

```typescript
function useCountUp(
  end: number,
  duration: number = 400,
  options?: { prefix?: string; suffix?: string }
): string {
  const [current, setCurrent] = useState(0);
  const prefersReducedMotion = useReducedMotion();

  useEffect(() => {
    if (prefersReducedMotion) {
      setCurrent(end);
      return;
    }

    const startTime = Date.now();
    const animate = () => {
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = easeOut(progress);
      setCurrent(Math.round(end * eased));

      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    };
    requestAnimationFrame(animate);
  }, [end, duration, prefersReducedMotion]);

  return formatCLP(current);
}
```

### Animation Timing

**From motion-design-system.md:**
- Count-up: 300-500ms, ease-out
- Entry: 200ms, ease-out
- Hover breathing: 150ms transition

### Recharts Integration

Recharts supports `isAnimationActive` prop - can disable animations for reduced motion:

```tsx
<PieChart>
  <Pie
    isAnimationActive={!prefersReducedMotion}
    animationDuration={ANIMATION.DURATION.SLOW}
    animationEasing="ease-out"
  />
</PieChart>
```

### References

- [Source: docs/sprint-artifacts/epic14/tech-context-epic14.md#Story 14.8]
- [Source: docs/uxui/motion-design-system.md#Animation Categories]
- [Source: src/components/charts/SimplePieChart.tsx]
- [Source: src/components/charts/GroupedBarChart.tsx]

---

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Analytics Navigation Flow (#2)**: Charts are core analytics visualization
- No workflow changes - enhancement to existing components

### Downstream Effects to Consider

- Chart performance should not degrade with animations
- Recharts animations may conflict with custom animations
- Test on low-end devices for performance

### Testing Implications

- **Existing tests to verify:** SimplePieChart tests, GroupedBarChart tests
- **New scenarios to add:** Animation timing, count-up accuracy, reduced motion

### Workflow Chain Visualization

```
[14.1 Animation Framework] ‚Üí [THIS STORY: Enhanced Charts] ‚Üí [Analytics UX]
```

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

1. **useCountUp Hook Created**: New hook at `src/hooks/useCountUp.ts` providing animated count-up effect for money values with configurable duration (default 400ms), ease-out cubic curve, reduced motion support, and optional start value.

2. **SimplePieChart Enhanced**:
   - Entry animation: fade-in + scale-up (200ms) on initial render
   - Count-up animation: Animated total value displayed in center donut hole
   - Breathing effect: Subtle 1.02x scale on hover/focus
   - Touch feedback: 0.95x press-in effect with haptic vibration
   - Keyboard accessibility: Enter/Space triggers tooltip, focus states
   - Reduced motion: All animations disabled when prefers-reduced-motion

3. **StackedBarChart (GroupedBarChart) Enhanced**:
   - Staggered entry animation: Each bar animates with scaleY(0‚Üí1) from bottom with staggered delays (100ms/bar, 50ms for 10+ bars)
   - Breathing effect: Subtle 1.05x scaleX on segment hover/focus
   - Touch feedback: 0.95x press-in effect with haptic vibration
   - Keyboard accessibility: All segments have role="button", tabIndex, aria-labels
   - Reduced motion: All animations disabled when prefers-reduced-motion

4. **Animation Constants Used**: Leveraged DURATION, EASING, STAGGER from animation/constants.ts for consistency with motion-design-system.md

5. **Tests Added**: 60 new tests covering useCountUp hook, SimplePieChart, and StackedBarChart - all animations, accessibility, reduced motion, and theme support

### File List

**New Files:**
- `src/hooks/useCountUp.ts` - Animated count-up hook
- `tests/unit/hooks/useCountUp.test.ts` - 13 tests (moved from charts/ during code review)
- `tests/unit/components/charts/SimplePieChart.test.tsx` - 22 tests
- `tests/unit/components/charts/StackedBarChart.test.tsx` - 25 tests

**Modified Files:**
- `src/components/charts/SimplePieChart.tsx` - Entry animations, count-up, hover/touch feedback, reduced motion
- `src/components/charts/GroupedBarChart.tsx` - Staggered entry, hover/touch feedback, reduced motion
