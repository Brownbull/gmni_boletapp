# Story 14.16: Weekly Report Story Format

**Status:** done
**Points:** 5
**Epic:** 14 - Core Implementation
**Dependencies:** Story 14.1 (Animation Framework), Story 14.9 (Swipe Time Navigation)

---

## Story

As a **user reviewing my weekly spending**,
I want **Instagram-style swipeable report cards**,
so that **I can quickly browse through my spending summary in an engaging format**.

## Acceptance Criteria

1. **ReportCard component** with full-screen card styling
2. **Swipeable carousel** with horizontal navigation between cards
3. **Weekly summary card** showing total spent, vs last week, top categories
4. **Category breakdown cards** - one card per major spending category
5. **Trend arrows** (â†‘â†“â†’) with color coding for easy understanding
6. **Rosa-friendly format** - simple language, large numbers, clear indicators
7. **Progress dots** showing current position in card stack

## Tasks / Subtasks

- [x] Task 1: Create ReportCard component (AC: #1)
  - [x] Create `src/components/reports/ReportCard.tsx`
  - [x] Full-screen card with centered content
  - [x] Background color/gradient per card type
  - [x] Large typography for key numbers

- [x] Task 2: Create ReportCarousel component (AC: #2)
  - [x] Create `src/components/reports/ReportCarousel.tsx`
  - [x] Use useSwipeNavigation hook from 14.9
  - [x] Handle card transitions with slide animation
  - [x] Support keyboard navigation (left/right arrows)

- [x] Task 3: Implement weekly summary card (AC: #3)
  - [x] Total spent this week (large, prominent)
  - [x] Comparison vs last week (arrow + percentage)
  - [x] Top 3 categories with mini bars
  - [x] Date range display

- [x] Task 4: Create category breakdown cards (AC: #4)
  - [x] One card per category with significant spending
  - [x] Category icon and color
  - [x] Amount and percentage of total
  - [x] Trend vs previous week

- [x] Task 5: Implement TrendArrow component (AC: #5)
  - [x] TrendIndicator embedded in ReportCard.tsx
  - [x] â†‘ (up, red) = spending increased
  - [x] â†“ (down, green) = spending decreased
  - [x] â†’ (neutral, gray) = no significant change
  - [x] Include percentage change text

- [x] Task 6: Ensure Rosa-friendly format (AC: #6)
  - [x] Large, readable numbers (text-4xl font)
  - [x] Simple labels in Spanish
  - [x] Colloquial language ("SubiÃ³ harto" not "IncrementÃ³ 27%")
  - [x] Clear color coding

- [x] Task 7: Add progress dots (AC: #7)
  - [x] Dot indicator showing current card
  - [x] Positioned at bottom of carousel
  - [x] Animate active dot

- [x] Task 8: Write tests
  - [x] Test card rendering (ReportCard.test.tsx - 15 tests)
  - [x] Test swipe navigation (ReportCarousel.test.tsx - 18 tests)
  - [x] Test data calculations (reportUtils.test.ts - 38 tests)
  - [x] Test Rosa-friendly text

## Dev Notes

### Mockup Reference

**From reports.html:**
- Full-screen cards with gradient backgrounds
- Large numbers centered
- Swipe indicators at bottom
- Trend arrows with color coding

### Card Types

```typescript
type ReportCardType = 'summary' | 'category' | 'trend' | 'milestone';

interface ReportCard {
  type: ReportCardType;
  title: string;
  primaryValue: string;
  secondaryValue?: string;
  trend?: 'up' | 'down' | 'neutral';
  trendPercent?: number;
  color?: string;
}
```

### Weekly Summary Generation

```typescript
interface WeeklySummary {
  totalSpent: number;
  previousWeekSpent: number;
  trendPercent: number;
  topCategories: { name: string; amount: number; percent: number }[];
  dateRange: { start: Date; end: Date };
}

function generateWeeklySummary(transactions: Transaction[]): WeeklySummary {
  // Filter to current week
  // Calculate totals
  // Compare with previous week
  // Extract top categories
}
```

### Rosa-Friendly Language

**From voice-tone-guidelines.md:**

| Technical | Rosa-Friendly |
|-----------|---------------|
| "IncrementÃ³ 27%" | "SubiÃ³ harto" |
| "DecreciÃ³ 15%" | "BajÃ³ un poco" |
| "Sin cambios significativos" | "Igual que antes" |
| "Total gastado: $X" | "Esta semana: $X" |

### Trend Arrow Colors

```typescript
const TREND_COLORS = {
  up: '#ef4444',    // Red - spending increased (bad)
  down: '#22c55e',  // Green - spending decreased (good)
  neutral: '#6b7280', // Gray - no change
};
```

### Carousel Implementation

```tsx
<ReportCarousel
  cards={generateReportCards(weeklyData)}
  onCardChange={(index) => setCurrentCard(index)}
/>
```

### References

- [Source: docs/sprint-artifacts/epic14/tech-context-epic14.md#Story 14.10]
- [Source: docs/uxui/mockups/01_views/reports.html]
- [Source: docs/uxui/voice-tone-guidelines.md#Rosa-friendly alternatives]
- [Source: src/hooks/useSwipeNavigation.ts - From 14.9]

---

## Atlas Workflow Analysis

> ğŸ—ºï¸ This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Insight History Flow (#8)**: Reports extend insight browsing concept
- **Analytics Navigation Flow (#2)**: Reports are alternative analytics view

### Downstream Effects to Consider

- Reports view needs to be added to navigation
- May need new route and tab bar update
- Data needs to be pre-calculated for performance

### Testing Implications

- **Existing tests to verify:** Transaction aggregation tests
- **New scenarios to add:** Report generation, swipe navigation, Rosa-friendly text

### Workflow Chain Visualization

```
[14.9 Swipe Navigation] â†’ [THIS STORY: Weekly Reports] â†’ [Reports View in Nav]
```

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

1. **ReportCard component** (Task 1): Full-screen card with gradient backgrounds for different card types (summary, category, trend, milestone). Uses TrendIndicator for trend visualization with arrows and color coding.

2. **ReportCarousel component** (Task 2): Instagram-style swipeable carousel using useSwipeNavigation hook from Story 14.9. Supports keyboard navigation (arrow keys, Home, End) and touch gestures.

3. **Weekly summary generation** (Task 3): Created `generateWeeklySummary()` in reportUtils.ts that calculates total spent, compares vs previous week, and extracts top 3 categories.

4. **Category breakdown cards** (Task 4): `generateReportCards()` creates category cards with icon, amount, percentage, and trend indicators for each major spending category.

5. **TrendIndicator** (Task 5): Embedded in ReportCard.tsx with arrows (â†‘â†“â†’), color coding (red=up/bad, green=down/good, gray=neutral), and percentage display.

6. **Rosa-friendly format** (Task 6): Uses Chilean Spanish colloquial language ("SubiÃ³ harto", "BajÃ³ un poco", "Igual que antes"), large typography (text-4xl), and simple labels.

7. **Progress dots** (Task 7): ProgressDots component positioned at bottom with animated active dot and keyboard accessibility.

8. **Tests** (Task 8): 71 total tests across 3 test files - ReportCard (15), ReportCarousel (18), reportUtils (38).

### File List

**New Files:**
- `src/utils/reportUtils.ts` - Weekly summary generation, category breakdown, report card generation
- `src/components/reports/index.ts` - Export file for report components
- `src/views/ReportsView.tsx` - View component that renders the ReportCarousel
- `tests/unit/utils/reportUtils.test.ts` - 38 tests for data utilities

**Existing Files (already implemented):**
- `src/components/reports/ReportCard.tsx` - Card component with TrendIndicator
- `src/components/reports/ReportCarousel.tsx` - Swipeable carousel component
- `src/types/report.ts` - Type definitions and helper functions
- `tests/unit/components/reports/ReportCard.test.tsx` - 15 component tests
- `tests/unit/components/reports/ReportCarousel.test.tsx` - 18 component tests

**Modified Files (integration):**
- `src/App.tsx` - Added 'reports' to View type, imported ReportsView, added rendering logic with back button header
- `src/components/TopHeader.tsx` - Enabled Reports menu item (removed disabled: true)
- `tests/unit/components/TopHeader.test.tsx` - Updated test for "PrÃ³ximamente" badge count (now 1 instead of 2)

---

## Enhancement: Reports View Improvements (2026-01)

### New Features Implemented

#### 1. Transaction Count Badges on Report Rows
- **Component:** `ReportRow.tsx` updated to accept `transactionCount` prop
- **UI:** Receipt icon + number displayed in a pill badge next to report title
- **Purpose:** Users can quickly see how many transactions are in each report

#### 2. Category Groups with Semantic Colors
- **CSS Classes:** `.category-group`, `.category-group-header`, `.category-group-items`
- **Color themes:** food-dining (yellow), transport-auto (blue), health-wellness (pink), home-living (green), entertainment-leisure (purple), shopping-retail (red)
- **Purpose:** Visual grouping of related categories in report detail overlay

#### 3. ISO Week Handling for Cross-Month Boundaries
- **Problem:** ISO Week 1 of 2026 starts Dec 29, 2025 - week spans year/month boundary
- **Solution:** Updated `generateWeeklyReportsForYear()` to group transactions by ISO week, not calendar year
- **Navigation Fix:** Date range filtering added to `TemporalFilterState` to ensure exact ISO week matching

### Files Modified (Enhancement)

- `src/components/reports/ReportRow.tsx` - Added `transactionCount` prop and Receipt icon badge
- `src/views/ReportsView.tsx` - Pass `transactionCount` to ReportRow, fixed week navigation with date range
- `src/utils/reportUtils.ts` - Fixed `generateWeeklyReportsForYear()` to handle cross-year ISO weeks correctly
- `src/contexts/HistoryFiltersContext.tsx` - Added `dateRange` to `TemporalFilterState`
- `src/utils/historyFilterUtils.ts` - Added date range filtering priority in `matchesTemporalFilter()`
- `src/hooks/useHistoryFilters.ts` - Updated `getTemporalFilterLabel()` to show date range for ISO weeks

### Mockup Updates

- **File:** `docs/uxui/mockups/01_views/reports.html`
- **Changes:**
  - Added `.tx-count-badge` styles for transaction count pill
  - Added `.category-group` styles with semantic color themes
  - Updated report data to include `transactionCount` and `categoryGroups`
  - Updated `openReport()` function to render grouped categories

### Testing Notes

- Transaction counts now match between Reports view and History view
- Navigation from Reports to History uses exact date range for ISO weeks
- Filter chips display date range (e.g., "29 dic - 4 ene") for cross-month weeks

---

## Enhancement: Full Category & Group Hierarchy Support (2026-01-07)

### Overview

Updated reports.html mockup to support the complete category hierarchy:

1. **Transaction Categories** (StoreCategory) - 32 individual store types
2. **Transaction Groups** (StoreCategoryGroup) - 8 semantic groups for store types
3. **Item Categories** (ItemCategory) - 37 individual item categories
4. **Item Groups** (ItemCategoryGroup) - 7 semantic groups for item categories
5. **User-Defined Groups** - Custom groups with user-specified colors

### Data Model Updates

#### Store Category Groups (8 groups)
| Group Key | Name (es) | Emoji | Categories |
|-----------|-----------|-------|------------|
| food-dining | AlimentaciÃ³n | ğŸ½ï¸ | Supermarket, Restaurant, Bakery, Butcher, StreetVendor |
| health-wellness | Salud y Bienestar | ğŸ’Š | Pharmacy, Medical, Veterinary, HealthBeauty |
| retail-general | Tiendas General | ğŸ›’ | Bazaar, Clothing, Electronics, HomeGoods, Furniture, Hardware, GardenCenter |
| retail-specialty | Tiendas Especializadas | ğŸ | PetShop, BooksMedia, OfficeSupplies, SportsOutdoors, ToysGames, Jewelry, Optical |
| automotive | Automotriz | â›½ | Automotive, GasStation, Transport |
| services | Servicios | ğŸ¢ | Services, BankingFinance, Education, TravelAgency, Subscription, Government |
| hospitality | Hospitalidad | ğŸ¨ | HotelLodging, Entertainment, Gambling |
| other | Otros | ğŸ“¦ | CharityDonation, Other |

#### Item Category Groups (7 groups)
| Group Key | Name (es) | Emoji | Categories |
|-----------|-----------|-------|------------|
| food-fresh | Alimentos Frescos | ğŸ¥¬ | Produce, Meat & Seafood, Bakery, Dairy & Eggs |
| food-packaged | Alimentos Envasados | ğŸ¥« | Pantry, Frozen Foods, Snacks, Beverages, Alcohol, Prepared Food |
| health-personal | Salud y Personal | ğŸ’„ | Health & Beauty, Personal Care, Pharmacy, Supplements, Baby Products |
| household | Hogar | ğŸ  | Cleaning Supplies, Household, Pet Supplies |
| nonfood-retail | Retail No Alimentario | ğŸ›ï¸ | Clothing, Electronics, Hardware, Garden, Automotive, Sports & Outdoors, etc. |
| services-fees | Servicios y Cargos | ğŸ“‹ | Service, Tax & Fees, Subscription, Insurance, Loan Payment, Tickets & Events |
| other-item | Otros | ğŸ“¦ | Other |

### CSS Updates

Added semantic color themes for all groups:

```css
/* Store Category Groups */
.category-group.food-dining { background: #fef3c7; } /* Warm yellow */
.category-group.health-wellness { background: #fce7f3; } /* Pink */
.category-group.retail-general { background: #ccfbf1; } /* Teal */
.category-group.retail-specialty { background: #ede9fe; } /* Purple */
.category-group.automotive { background: #f3f4f6; } /* Gray */
.category-group.services { background: #dbeafe; } /* Blue */
.category-group.hospitality { background: #f5f3ff; } /* Light purple */
.category-group.other-store { background: #d1fae5; } /* Green */

/* Item Category Groups */
.item-group.food-fresh { background: #dcfce7; } /* Light green */
.item-group.food-packaged { background: #fef3c7; } /* Yellow/amber */
.item-group.health-personal { background: #fae8ff; } /* Light magenta */
.item-group.household { background: #ccfbf1; } /* Teal */
.item-group.nonfood-retail { background: #dbeafe; } /* Blue */
.item-group.services-fees { background: #f1f5f9; } /* Slate */
.item-group.other-item { background: #f1f5f9; } /* Slate */

/* User-Defined Groups */
.user-group {
  border-left: 4px solid var(--group-color);
  background: color-mix(in srgb, var(--group-color) 15%, var(--bg-secondary) 85%);
}
```

### JavaScript Updates

1. **View Mode Toggle**: Added segmented control to switch between 5 view modes
2. **Collapsible Groups**: Groups can be expanded/collapsed by clicking
3. **Emoji Mapping**: Added `CATEGORY_EMOJIS` object with 60+ emoji mappings
4. **Data Structure**: Each report now supports:
   - `transactionCategories[]` - Flat list of store categories
   - `transactionGroups[]` - Grouped store categories
   - `itemCategories[]` - Flat list of item categories
   - `itemGroups[]` - Grouped item categories
   - `userGroups[]` - User-defined custom groups

### UI/UX Features

- **View Mode Toggle**: Buttons to switch between "Grupos de Tiendas", "CategorÃ­as de Tiendas", "Grupos de Items", "CategorÃ­as de Items", and "Mis Grupos"
- **Collapsible Groups**: Click group header to expand/collapse
- **Semantic Colors**: Each group type has a distinct background color for visual hierarchy
- **User Groups**: Custom groups with user-specified colors and transaction list

### Files Modified

- `docs/uxui/mockups/01_views/reports.html`:
  - CSS: Added 200+ lines for group styling, item-group classes, user-group support, view-mode-toggle
  - JavaScript: Added `STORE_CATEGORY_GROUPS`, `ITEM_CATEGORY_GROUPS`, `CATEGORY_EMOJIS` constants
  - JavaScript: Updated `reportContent` with all 5 data structures
  - JavaScript: Added `switchViewMode()` and `toggleGroup()` functions
  - JavaScript: Updated `openReport()` to render all view modes with toggle

### Atlas Analysis

**Workflow Impact:**
- Reports now align with the category system used in TrendsView (Story 14.15c)
- Item-level breakdown enables drill-down from transaction to individual items
- User groups support upcoming Epic 17 (Tags & Grouping)

**Downstream Effects:**
- ReportsView.tsx will need to implement these 5 view modes
- reportUtils.ts needs functions for grouping transactions by all 4 category levels
- User group management will require new UI in Settings or dedicated GroupsView

---

## Enhancement: Print-Friendly Non-Interactive Reports (2026-01-07)

### Design Changes

**Problem:** Original mockup was interactive with toggles and collapsible groups, which doesn't work for PDF export or printing.

**Solution:** Redesigned reports to be static, print-friendly documents with progressive information density based on report type.

### Font Consistency Fix

Added explicit `font-family: var(--font-family)` to all category group elements:
- `.category-group-header`
- `.category-group-name`
- `.category-group-amount`
- `.category-group-item`
- `.category-group-item-name`
- `.category-group-item-count`
- `.category-group-item-amount`

This ensures the entire report uses the Outfit font consistently.

### Removed Interactive Elements

Removed the following interactive features:
- View mode toggle buttons
- `switchViewMode()` function
- `toggleGroup()` function
- Chevron icons on group headers
- `.collapsed` state CSS classes
- `cursor: pointer` on group headers

### Progressive Information by Report Type

| Report Type | Sections Shown | Purpose |
|-------------|----------------|---------|
| **Weekly** | Transaction groups only | Quick summary of where you shopped |
| **Monthly** | Transaction groups + Item groups | More detail on both store types and product types |
| **Quarterly** | Transaction groups + Item groups | Same as monthly, with quarterly trends in highlights |
| **Yearly** | Transaction groups + Item groups + User groups | Full breakdown including custom user-defined groups |

### Implementation

```javascript
// Progressive information logic in openReport()
if (type === 'weekly') {
  // Transaction Groups only
}
if (type === 'monthly') {
  // Transaction Groups + Item Groups
}
if (type === 'quarterly') {
  // Transaction Groups + Item Groups (+ trends in highlights)
}
if (type === 'yearly') {
  // Transaction Groups + Item Groups + User Groups
}
```

### Print/PDF Export Ready

Reports are now designed to be:
- Fully expanded (no collapsed sections)
- Non-interactive (no toggles or buttons)
- Font-consistent (Outfit font throughout)
- Progressive (appropriate detail for each time period)
- Shareable as static documents

---

## Implementation Plan: Apply Mockup to Application (2026-01-07)

### Status: IN PROGRESS - Phase 1.5 Complete

The HTML mockup at `docs/uxui/mockups/01_views/reports.html` is complete. Transaction groups and item groups are now implemented for all report types.

### Implementation Order

#### Phase 1: Weekly Report Implementation âœ… COMPLETE (2026-01-07)
- [x] Update `src/utils/reportUtils.ts` to generate `transactionGroups[]` data structure
- [x] Create `groupCategoriesByStoreGroup()` function
- [x] Create `CategoryGroupCard.tsx` component to render transaction groups with semantic colors
- [x] Update `ReportDetailOverlay.tsx` to use grouped view for weekly reports
- [x] Test weekly report rendering

#### Phase 1.5: Item Groups for All Reports âœ… COMPLETE (2026-01-07)
- [x] Add `itemGroups[]` data structure generation to `reportUtils.ts`
- [x] Create `groupItemsByItemCategory()` function
- [x] Create `ItemGroupCard.tsx` component to render item groups
- [x] Update all report generators (weekly, monthly, quarterly, yearly) to include both groups
- [x] Weekly: Top 3 transaction groups + Top 3 item groups (by amount)
- [x] Monthly/Quarterly/Yearly: All groups sorted alphabetically

#### Phase 2: Monthly Report Implementation âœ… COMPLETE (2026-01-07)
- [x] Monthly reports now show all transaction groups + item groups (alphabetically sorted)
- [x] Apply theme-aware colors from `getItemGroupColors()`
- [x] Test monthly report rendering

#### Phase 3: Quarterly Report Implementation âœ… COMPLETE (2026-01-07)
- [x] Quarterly reports include transaction groups + item groups (alphabetically sorted)
- [x] Highlights section already shows quarterly trends
- [x] Test quarterly report rendering

#### Phase 4: Yearly Report Implementation - PARTIAL
- [x] Yearly reports show transaction groups + item groups (alphabetically sorted)
- [ ] Add `userGroups[]` data structure (requires user group feature - Story 14.15)
- [ ] When transactions have `groupId`, show user-defined groups section
- [ ] Test yearly report rendering

### Files to Modify

| File | Changes |
|------|---------|
| `src/utils/reportUtils.ts` | Add grouping functions, update data structures |
| `src/components/reports/ReportCard.tsx` | Update to render grouped categories |
| `src/views/ReportsView.tsx` | Pass grouped data to cards |
| `src/styles/reports.css` (or inline) | Add semantic color CSS from mockup |
| `src/config/categoryColors.ts` | May need group color exports |

### Key Data Structures

```typescript
// Transaction Group (Store Category Group)
interface TransactionGroup {
  key: StoreCategoryGroup;
  name: string;
  emoji: string;
  cssClass: string;
  totalAmount: number;
  categories: {
    key: StoreCategory;
    name: string;
    count: number;
    amount: number;
  }[];
}

// Item Group (Item Category Group)
interface ItemGroup {
  key: ItemCategoryGroup;
  name: string;
  emoji: string;
  cssClass: string;
  totalAmount: number;
  categories: {
    key: ItemCategory;
    name: string;
    count: number;
    amount: number;
  }[];
}
```

### Reference Files

- **Mockup:** `docs/uxui/mockups/01_views/reports.html`
- **Category Colors:** `src/config/categoryColors.ts`
- **Category Translations:** `src/utils/categoryTranslations.ts`
- **Existing Report Utils:** `src/utils/reportUtils.ts`

### Session Continuation Prompt

Use this prompt to continue implementation in a new session:

```
Continue implementing Story 14.16 - Weekly Report enhancements.

Context:
- Mockup is complete at docs/uxui/mockups/01_views/reports.html
- Need to implement transaction groups and item groups in the React app
- Progressive information: Weekly (transaction groups only), Monthly (+item groups), Quarterly (+trends), Yearly (+user groups)

Current task: Phase 1 - Weekly Report Implementation
- Read the mockup for CSS styles and data structures
- Update src/utils/reportUtils.ts to generate transactionGroups[]
- Update ReportCard.tsx to render grouped categories
- Reference src/config/categoryColors.ts for group definitions

Start by reading:
1. docs/sprint-artifacts/epic14/stories/story-14.16-weekly-report-story-format.md (this story)
2. docs/uxui/mockups/01_views/reports.html (the mockup)
3. src/utils/reportUtils.ts (existing code)
4. src/config/categoryColors.ts (group definitions)
```

---

## Phase 1 Completion: Weekly Transaction Groups (2026-01-07)

### Summary

Implemented transaction groups for weekly reports, showing categories grouped by store type (e.g., "AlimentaciÃ³n" groups Supermarket + Restaurant + Bakery).

### Changes Made

#### New Types (`src/types/report.ts`)
- `GroupedCategory` - Single category within a group with name, count, amount
- `TransactionGroup` - Group container with key, name, emoji, cssClass, totalAmount, categories[]

#### New Metadata (`src/config/categoryColors.ts`)
- `GroupDisplayInfo` interface - Display name, emoji, cssClass for groups
- `STORE_GROUP_INFO` - Metadata for 8 store category groups
- `ITEM_GROUP_INFO` - Metadata for 7 item category groups (for Phase 2)

#### New Function (`src/utils/reportUtils.ts`)
- `groupCategoriesByStoreGroup(categories)` - Converts flat CategoryBreakdown[] to TransactionGroup[]
- Updated `ReportRowData` interface to include `transactionGroups?: TransactionGroup[]`
- Updated `generateWeeklyReportRow()` to populate `transactionGroups`
- Updated `generateWeeklyReportsForYear()` to populate `transactionGroups`

#### New Component (`src/components/reports/CategoryGroupCard.tsx`)
- Theme-aware colors using `getStoreGroupColors()`
- Renders group header with emoji, name, total amount
- Renders category items with icon, name, count, amount
- Exported from `src/components/reports/index.ts`

#### Updated Component (`src/components/reports/ReportDetailOverlay.tsx`)
- Added `TransactionGroupsCard` internal component
- Conditional rendering: weekly reports use `TransactionGroupsCard`, others use flat `CategoryBreakdownCard`
- Updated `ReportDetailData` interface to include `transactionGroups`

### Testing

- TypeScript: Passes (no new errors)
- Build: Passes
- Unit tests: All report tests pass (38 reportUtils + 33 component tests)

### Visual Result

Weekly reports now show:
```
ğŸ“Š Desglose por tipo de tienda

ğŸ½ï¸ AlimentaciÃ³n              $35.300
  ğŸ›’ Supermercado   5 compras   $22.500
  ğŸ½ï¸ Restaurantes  3 compras   $12.800

ğŸ’Š Salud y Bienestar         $12.450
  ğŸ’Š Farmacia      2 compras   $12.450

â›½ Automotriz                 $45.000
  â›½ Bencina       1 compra    $45.000
```

### Next Steps

- **Phase 2:** Add `itemGroups[]` for monthly reports âœ… COMPLETE
- **Phase 3:** Add quarterly trends in highlights
- **Phase 4:** Add user groups for yearly reports

---

## Phase 1.5 Completion: Item Groups Added to All Reports (2026-01-07)

### Summary

Extended the grouped category display to include **item groups** (product-level breakdown) in addition to transaction groups (store-level). Implemented progressive information model:

- **Weekly**: Top 3 Transaction Groups + Top 3 Item Groups (sorted by amount descending)
- **Monthly/Quarterly/Yearly**: All Transaction Groups + All Item Groups (sorted alphabetically by name)

### Changes Made

#### New Types (`src/types/report.ts`)
- `GroupedItem` - Single item category within a group with name, count, amount
- `ItemGroup` - Group container for item categories with key, name, emoji, cssClass, totalAmount, items[]

#### New Function (`src/utils/reportUtils.ts`)
- `getItemBreakdown(transactions)` - Aggregates items by category across transactions
- `groupItemsByItemCategory(transactions)` - Groups items into ItemGroup objects
- `sortGroupsAlphabetically()` - Sorts groups alphabetically for monthly+ reports
- Updated `ReportRowData` interface to include `itemGroups?: ItemGroup[]`
- Updated all report generators (weekly, monthly, quarterly, yearly) to include itemGroups

#### New Component (`src/components/reports/ItemGroupCard.tsx`)
- Theme-aware colors using `getItemGroupColors()`
- Renders group header with emoji, name, total amount
- Renders item rows with name, count, amount
- Exported from `src/components/reports/index.ts`

#### Updated Components
- `ReportDetailOverlay.tsx` - Added `ItemGroupsCard` component, renders both transaction and item groups
- `ReportsView.tsx` - Passes `itemGroups` to overlay

### Progressive Information Model

| Report Type | Transaction Groups | Item Groups | Sorting |
|-------------|-------------------|-------------|---------|
| **Weekly** | Top 3 | Top 3 | By amount (desc) |
| **Monthly** | All | All | Alphabetical |
| **Quarterly** | All | All | Alphabetical |
| **Yearly** | All | All | Alphabetical |

### Visual Result

Weekly reports now show:
```
ğŸª Desglose por tipo de tienda

ğŸ½ï¸ AlimentaciÃ³n              $35.300
  ğŸ›’ Supermercado   5 compras   $22.500
  ğŸ½ï¸ Restaurantes  3 compras   $12.800

ğŸ’Š Salud y Bienestar         $12.450
  ğŸ’Š Farmacia      2 compras   $12.450

â›½ Automotriz                 $45.000
  â›½ Bencina       1 compra    $45.000

ğŸ›’ Desglose por tipo de producto

ğŸ¥¬ Alimentos Frescos         $18.200
  Frutas y Verduras   12 items   $8.500
  Carnes y Mariscos   4 items    $9.700

ğŸ¥« Alimentos Envasados       $15.100
  Bebidas            8 items    $6.200
  Snacks             5 items    $4.900
  LÃ¡cteos            6 items    $4.000
```

### Testing

- TypeScript: Passes (no new errors)
- Build: Passes

### Next Steps

- **Phase 3:** Add user groups (custom user-defined groups) when transactions have groupId

---

## Enhancement: PDF Download Feature (2026-01-07)

### Overview

Replaced the X (close) button in the ReportDetailOverlay header with a Download icon that allows users to export reports as PDF using the browser's native print-to-PDF functionality.

### Implementation Details

#### UI Changes
- **Icon Change:** Replaced `X` icon with `Download` icon from lucide-react
- **Button Function:** Clicking the download button triggers `window.print()` which opens the browser's print dialog
- **User Flow:** Users can select "Save as PDF" in the print dialog to download the report

#### Print CSS Styles (index.html)
Added `@media print` styles to ensure clean PDF output:
- Hide app chrome (header, nav, bottom nav, buttons)
- Show only the report content area
- Reset positioning for proper print layout
- Preserve colors for hero card (`print-color-adjust: exact`)
- Prevent page breaks inside category group cards
- A4 page size with 15mm margins
- Light theme overrides for printing

#### Closing the Overlay
Users can still close the overlay via:
1. Clicking the back arrow (ChevronLeft) or title area
2. Clicking the semi-transparent backdrop
3. Pressing the Escape key

### Files Modified

| File | Changes |
|------|---------|
| `src/components/reports/ReportDetailOverlay.tsx` | Replaced X with Download icon, updated button handler to call `window.print()` |
| `index.html` | Added `@media print` CSS block with print-specific styles |

### Testing Notes

- Print preview shows only the report content
- "Save as PDF" produces clean document with category groups
- Hero card colors are preserved in PDF
- Back button, backdrop click, and Escape key still close the overlay

---

## Enhancement: Category/Item Trend Bars (2026-01-07)

### Overview

Added mini trend bars to CategoryGroupCard and ItemGroupCard showing spending change vs previous period. Bars use semantic colors where red indicates increased spending (bad) and green indicates decreased spending (good).

### Implementation Details

#### Type Updates (src/types/report.ts)
Added trend fields to:
- `GroupedCategory`: `trend?: TrendDirection`, `trendPercent?: number`
- `TransactionGroup`: `trend?: TrendDirection`, `trendPercent?: number`
- `GroupedItem`: `trend?: TrendDirection`, `trendPercent?: number`
- `ItemGroup`: `trend?: TrendDirection`, `trendPercent?: number`

#### Utility Updates (src/utils/reportUtils.ts)
- `groupCategoriesByStoreGroup()`: Now passes through category trend data and calculates group-level trends
- `getItemBreakdown()`: Now accepts previous transactions and calculates item-level trends
- `groupItemsByItemCategory()`: Now accepts previous transactions and calculates group-level trends
- All report generation functions updated to pass previous period transactions

#### Component Updates
- `CategoryGroupCard.tsx`: Added TrendBar component, displays trends on group header and individual categories
- `ItemGroupCard.tsx`: Added TrendBar component, displays trends on group header and individual items

#### TrendBar Component
- Small horizontal bar (40px wide) with percentage label
- Bar width scales relative to percentage (max 50%)
- Colors use semantic CSS variables:
  - `var(--negative-primary)` for increased spending (up trend)
  - `var(--positive-primary)` for decreased spending (down trend)
- Hidden when trend is neutral or 0%

### Files Modified

| File | Changes |
|------|---------|
| `src/types/report.ts` | Added trend fields to GroupedCategory, TransactionGroup, GroupedItem, ItemGroup |
| `src/utils/reportUtils.ts` | Updated grouping functions to calculate and pass trend data |
| `src/components/reports/CategoryGroupCard.tsx` | Added TrendBar component with semantic colors |
| `src/components/reports/ItemGroupCard.tsx` | Added TrendBar component with semantic colors |

### Testing Notes

- Trend bars appear on groups and items with previous period data
- Red bars indicate spending increase (bad for budget)
- Green bars indicate spending decrease (good for budget)
- Bars scale proportionally up to 50% maximum width
- TypeScript passes with no errors

---

## Enhancement: PDF Export Improvements (2026-01-07)

### Session Summary

Fixed multi-page PDF export and added various enhancements for better PDF reports.

### Issues Fixed

#### 1. Multi-Page PDF Export (FIXED)
**Problem:** CSS-only print styles couldn't properly render multi-page PDFs due to:
- Report overlay being deeply nested in React tree with fixed positioning
- `visibility: hidden` approach left blank space
- `:has()` CSS selector couldn't traverse React's complex DOM

**Solution:** JavaScript-based print preparation that creates a dedicated print container outside React tree:
```typescript
const handlePrintReport = (reportContentRef, reportData) => {
  // 1. Create #print-container at body level
  // 2. Clone report content
  // 3. Add branding header + footer
  // 4. Set document.title for filename
  // 5. Add .printing-report class to body
  // 6. Call window.print()
  // 7. Cleanup after print
};
```

#### 2. Gastify Branding Header
- "G" logo circle matching TopHeader AppLogo component
- "Gastify" wordmark using Baloo 2 font (same as app)
- Border separator below header

#### 3. Report Footer
Added professional footer with:
- "Reporte generado automÃ¡ticamente por Gastify"
- Generation date/time + transaction count
- "Este reporte es solo para uso personal." (disclaimer)
- "gastify.cl" URL

#### 4. Dynamic PDF Filename
PDF filename generated based on report period:
| Period Type | Example Filename |
|-------------|------------------|
| Weekly | `Gastify_report_2025_Q4_Dic_S52` |
| Monthly | `Gastify_report_2025_Q4_Dic` |
| Quarterly | `Gastify_report_2025_Q4` |
| Yearly | `Gastify_report_2025` |

#### 5. Increased Font Sizes
All print fonts increased for better readability:
- Hero card "Total del mes" label: 13pt
- Hero card amount: 26pt
- Insight card text: 14pt
- Category/Item group names: 13pt
- Category/Item secondary text: 11pt
- Highlights card: 11-13pt

#### 6. Spanish Translations for Item Categories
Added missing Spanish translations for legacy item categories:
- Fresh Food â†’ Alimentos Frescos
- Drinks â†’ Bebidas
- Car â†’ Auto
- SportsOutdoors â†’ Deportes y Exterior
- HomeGoods â†’ Articulos del Hogar
- OfficeSupplies â†’ Articulos de Oficina
- HealthBeauty â†’ Salud y Belleza
- Butcher â†’ CarnicerÃ­a
- Jewelry â†’ JoyerÃ­a
- Services â†’ Servicios

#### 7. Week Date Ranges in Highlights
Monthly report highlights now show week date ranges:
- Before: `S51 Â· $831.878`
- After: `S51 (16-22 Dic) Â· $831.878`

### Files Modified

| File | Changes |
|------|---------|
| `src/components/reports/ReportDetailOverlay.tsx` | Added `handlePrintReport()` with branding, footer, filename generation |
| `index.html` | Comprehensive print CSS styles (~200 lines) |
| `src/utils/categoryTranslations.ts` | Added 15+ Spanish translations for legacy categories |
| `src/utils/reportUtils.ts` | Added `formatWeekDateRange()`, updated `generateMonthlyHighlights()` |
| `docs/development/pdf-export-pattern.md` | New documentation for PDF export pattern |

### Documentation Created

Created comprehensive technical documentation at `docs/development/pdf-export-pattern.md` covering:
- Problem statement and failed approaches
- Architecture diagram
- Complete JavaScript implementation
- CSS print styles with explanations
- Best practices and customization points
- Troubleshooting guide

### Atlas Memory Updated

- Added PDF export pattern to `04-architecture.md`
- Added sync entry to `09-sync-history.md`

---

## Enhancement: Category Percentage Visualization - COMPLETE (2026-01-07)

### Overview

Implemented category percentage participation showing both current period distribution and trend data. Uses a combined approach:

1. **Donut Charts (Option B)** - Dual donut charts for groups only (stable number of segments)
2. **Percentage Columns (Option A)** - Added to all levels (groups and individual categories/items)

### Design Decision: Donut Charts for Groups Only

Donut charts are limited to **group-level** visualization because:
- Groups have a fixed, small number of segments (8 store groups, 7 item groups)
- Individual categories can be many (32+ store categories, 37+ item categories)
- Stable donut charts are easier to compare across periods

### Implementation Details

#### Type Updates (`src/types/report.ts`)
Added `percent: number` field to:
- `GroupedCategory` - Individual store category percentage
- `TransactionGroup` - Store group percentage
- `GroupedItem` - Individual item category percentage
- `ItemGroup` - Item group percentage

#### Utility Updates (`src/utils/reportUtils.ts`)
- `groupCategoriesByStoreGroup()`: Now calculates percentage for each category and group
- `groupItemsByItemCategory()`: Now calculates percentage for each item and group
- Percentages are calculated against total period spending (rounded to integers)

#### New Component (`src/components/reports/SpendingDonutChart.tsx`)
Pure SVG-based donut chart with:
- Theme-aware colors from `getStoreGroupColors()` / `getItemGroupColors()`
- Segments proportional to spending percentages
- Center emoji showing largest segment
- Compact legend with top 3 segments
- Accessible with ARIA labels
- PDF/print compatible (pure SVG)

#### Updated Components
- `CategoryGroupCard.tsx`: Added percentage badge to group header + category rows
- `ItemGroupCard.tsx`: Added percentage badge to group header + item rows
- `ReportDetailOverlay.tsx`: Added "DistribuciÃ³n del gasto" section with dual donut charts

#### Print Styles (`index.html`)
Added print CSS for donut charts:
- `[data-testid="spending-distribution-card"]` styles
- `-webkit-print-color-adjust: exact` for SVG segments
- `break-inside: avoid` to prevent page breaks

### Visual Result

Reports now show:

```
ğŸ“Š DistribuciÃ³n del gasto

[Donut Chart]     [Donut Chart]
  Por tienda       Por producto
  ğŸ½ï¸ 45%           ğŸ¥¬ 38%
  ğŸ’Š 25%           ğŸ¥« 32%
  â›½ 20%           ğŸ’„ 18%

ğŸª Desglose por tipo de tienda

ğŸ½ï¸ AlimentaciÃ³n        45%    $35.300  â†‘+12%
  ğŸ›’ Supermercado   28%   5 compras   $22.500  â†‘+8%
  ğŸ½ï¸ Restaurantes  17%   3 compras   $12.800  â†‘+18%

ğŸ’Š Salud y Bienestar   25%    $19.700  â†“-5%
  ğŸ’Š Farmacia      25%   2 compras   $19.700  â†“-5%
```

### Files Created

| File | Description |
|------|-------------|
| `src/components/reports/SpendingDonutChart.tsx` | SVG donut chart component |

### Files Modified

| File | Changes |
|------|---------|
| `src/types/report.ts` | Added `percent` field to all group/category types |
| `src/utils/reportUtils.ts` | Calculate percentages in grouping functions |
| `src/components/reports/CategoryGroupCard.tsx` | Added percentage badges |
| `src/components/reports/ItemGroupCard.tsx` | Added percentage badges |
| `src/components/reports/ReportDetailOverlay.tsx` | Added donut charts section |
| `src/components/reports/index.ts` | Export SpendingDonutChart |
| `index.html` | Print styles for donut charts |

### Testing

- TypeScript: Passes (no errors)
- Build: Passes
- Visual: Donut charts render correctly with theme-aware colors
- PDF: Charts render in print preview with preserved colors

---

## Enhancement: Donut Chart Refinements (2026-01-07)

### Changes Made

Based on user feedback, refined the donut chart implementation:

#### 1. Theme-Aware Segment Colors
- Changed from using `bg` (background) colors to `fg` (foreground) colors for segments
- More visible and matches the category group header colors
- Colors adapt automatically to user's theme (Normal, Professional, Mono)

#### 2. Removed Center Icon
- Removed the emoji from the center of the donut
- Makes the chart cleaner and easier to read

#### 3. Thicker Donut Ring
- Increased `RING_THICKNESS` from 0.35 to 0.45 (fraction of radius)
- Better visual clarity and easier to distinguish segments

#### 4. Separated Charts into Respective Sections
- Removed the combined "DistribuciÃ³n del gasto" card
- Store groups donut now appears in the TransactionGroupsCard header
- Item groups donut now appears in the ItemGroupsCard header
- Each section has its own donut with legend to the right

#### 5. Horizontal Layout with Full Legend
- Chart on the left, legend on the right
- Legend shows all groups (not just top 3)
- Each legend item: color indicator + emoji + percentage
- More compact and informative

### Visual Result

Each section now shows:
```
ğŸª Desglose por tipo de tienda          [ğŸ©] ğŸŸ¤ ğŸ½ï¸ 66%
                                             ğŸŸ¢ ğŸ’Š 16%
                                             âš« â›½ 11%
                                             ...

ğŸ½ï¸ AlimentaciÃ³n  66%   $1.160.628  â†‘+299%
  ğŸ›’ Supermercado  43%   14 compras   $761.648  â†‘+201%
  ...
```

### Files Modified

| File | Changes |
|------|---------|
| `src/components/reports/SpendingDonutChart.tsx` | Use fg colors, remove center icon, thicker ring, horizontal layout |
| `src/components/reports/ReportDetailOverlay.tsx` | Move donuts to section headers, remove combined card |

---

## Enhancement: Donut Chart Layout Improvements (2026-01-07)

### Changes Made

Based on user feedback, improved the donut chart layout for better space utilization:

#### 1. Title on Separate Row
- Section title ("ğŸª Desglose por tipo de tienda") now on its own row
- Gives full width for the donut chart and legend

#### 2. Chart-Legend Side-by-Side Layout
- Donut chart on left half (~90px)
- Legend items on right half, filling available space
- Clear visual separation

#### 3. Legend Styled Like Category Cards
- Each legend item has a colored background matching its group
- Circle color indicator (fg color)
- Category name
- Percentage on the right
- Styled similarly to the category breakdown cards below

### Visual Layout

```
ğŸª Desglose por tipo de tienda

[Donut]    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ â— AlimentaciÃ³n       66% â”‚
           â”‚ â— Salud y Bienestar  16% â”‚
           â”‚ â— Automotriz         11% â”‚
           â”‚ â— Tiendas General     4% â”‚
           â”‚ â— Servicios           2% â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ½ï¸ AlimentaciÃ³n  66%   $1.160.628
  ğŸ›’ Supermercado   43%   14 compras
  ...
```

### Files Modified

| File | Changes |
|------|---------|
| `src/components/reports/SpendingDonutChart.tsx` | Chart-legend side-by-side, styled legend items |
| `src/components/reports/ReportDetailOverlay.tsx` | Title on own row, donut chart in separate div |
