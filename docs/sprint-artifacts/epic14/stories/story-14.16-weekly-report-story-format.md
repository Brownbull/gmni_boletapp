# Story 14.16: Weekly Report Story Format

**Status:** done
**Points:** 5
**Epic:** 14 - Core Implementation
**Dependencies:** Story 14.1 (Animation Framework), Story 14.9 (Swipe Time Navigation)

---

## Story

As a **user reviewing my weekly spending**,
I want **Instagram-style swipeable report cards**,
so that **I can quickly browse through my spending summary in an engaging format**.

## Acceptance Criteria

1. **ReportCard component** with full-screen card styling
2. **Swipeable carousel** with horizontal navigation between cards
3. **Weekly summary card** showing total spent, vs last week, top categories
4. **Category breakdown cards** - one card per major spending category
5. **Trend arrows** (‚Üë‚Üì‚Üí) with color coding for easy understanding
6. **Rosa-friendly format** - simple language, large numbers, clear indicators
7. **Progress dots** showing current position in card stack

## Tasks / Subtasks

- [x] Task 1: Create ReportCard component (AC: #1)
  - [x] Create `src/components/reports/ReportCard.tsx`
  - [x] Full-screen card with centered content
  - [x] Background color/gradient per card type
  - [x] Large typography for key numbers

- [x] Task 2: Create ReportCarousel component (AC: #2)
  - [x] Create `src/components/reports/ReportCarousel.tsx`
  - [x] Use useSwipeNavigation hook from 14.9
  - [x] Handle card transitions with slide animation
  - [x] Support keyboard navigation (left/right arrows)

- [x] Task 3: Implement weekly summary card (AC: #3)
  - [x] Total spent this week (large, prominent)
  - [x] Comparison vs last week (arrow + percentage)
  - [x] Top 3 categories with mini bars
  - [x] Date range display

- [x] Task 4: Create category breakdown cards (AC: #4)
  - [x] One card per category with significant spending
  - [x] Category icon and color
  - [x] Amount and percentage of total
  - [x] Trend vs previous week

- [x] Task 5: Implement TrendArrow component (AC: #5)
  - [x] TrendIndicator embedded in ReportCard.tsx
  - [x] ‚Üë (up, red) = spending increased
  - [x] ‚Üì (down, green) = spending decreased
  - [x] ‚Üí (neutral, gray) = no significant change
  - [x] Include percentage change text

- [x] Task 6: Ensure Rosa-friendly format (AC: #6)
  - [x] Large, readable numbers (text-4xl font)
  - [x] Simple labels in Spanish
  - [x] Colloquial language ("Subi√≥ harto" not "Increment√≥ 27%")
  - [x] Clear color coding

- [x] Task 7: Add progress dots (AC: #7)
  - [x] Dot indicator showing current card
  - [x] Positioned at bottom of carousel
  - [x] Animate active dot

- [x] Task 8: Write tests
  - [x] Test card rendering (ReportCard.test.tsx - 15 tests)
  - [x] Test swipe navigation (ReportCarousel.test.tsx - 18 tests)
  - [x] Test data calculations (reportUtils.test.ts - 38 tests)
  - [x] Test Rosa-friendly text

## Dev Notes

### Mockup Reference

**From reports.html:**
- Full-screen cards with gradient backgrounds
- Large numbers centered
- Swipe indicators at bottom
- Trend arrows with color coding

### Card Types

```typescript
type ReportCardType = 'summary' | 'category' | 'trend' | 'milestone';

interface ReportCard {
  type: ReportCardType;
  title: string;
  primaryValue: string;
  secondaryValue?: string;
  trend?: 'up' | 'down' | 'neutral';
  trendPercent?: number;
  color?: string;
}
```

### Weekly Summary Generation

```typescript
interface WeeklySummary {
  totalSpent: number;
  previousWeekSpent: number;
  trendPercent: number;
  topCategories: { name: string; amount: number; percent: number }[];
  dateRange: { start: Date; end: Date };
}

function generateWeeklySummary(transactions: Transaction[]): WeeklySummary {
  // Filter to current week
  // Calculate totals
  // Compare with previous week
  // Extract top categories
}
```

### Rosa-Friendly Language

**From voice-tone-guidelines.md:**

| Technical | Rosa-Friendly |
|-----------|---------------|
| "Increment√≥ 27%" | "Subi√≥ harto" |
| "Decreci√≥ 15%" | "Baj√≥ un poco" |
| "Sin cambios significativos" | "Igual que antes" |
| "Total gastado: $X" | "Esta semana: $X" |

### Trend Arrow Colors

```typescript
const TREND_COLORS = {
  up: '#ef4444',    // Red - spending increased (bad)
  down: '#22c55e',  // Green - spending decreased (good)
  neutral: '#6b7280', // Gray - no change
};
```

### Carousel Implementation

```tsx
<ReportCarousel
  cards={generateReportCards(weeklyData)}
  onCardChange={(index) => setCurrentCard(index)}
/>
```

### References

- [Source: docs/sprint-artifacts/epic14/tech-context-epic14.md#Story 14.10]
- [Source: docs/uxui/mockups/01_views/reports.html]
- [Source: docs/uxui/voice-tone-guidelines.md#Rosa-friendly alternatives]
- [Source: src/hooks/useSwipeNavigation.ts - From 14.9]

---

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Insight History Flow (#8)**: Reports extend insight browsing concept
- **Analytics Navigation Flow (#2)**: Reports are alternative analytics view

### Downstream Effects to Consider

- Reports view needs to be added to navigation
- May need new route and tab bar update
- Data needs to be pre-calculated for performance

### Testing Implications

- **Existing tests to verify:** Transaction aggregation tests
- **New scenarios to add:** Report generation, swipe navigation, Rosa-friendly text

### Workflow Chain Visualization

```
[14.9 Swipe Navigation] ‚Üí [THIS STORY: Weekly Reports] ‚Üí [Reports View in Nav]
```

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

1. **ReportCard component** (Task 1): Full-screen card with gradient backgrounds for different card types (summary, category, trend, milestone). Uses TrendIndicator for trend visualization with arrows and color coding.

2. **ReportCarousel component** (Task 2): Instagram-style swipeable carousel using useSwipeNavigation hook from Story 14.9. Supports keyboard navigation (arrow keys, Home, End) and touch gestures.

3. **Weekly summary generation** (Task 3): Created `generateWeeklySummary()` in reportUtils.ts that calculates total spent, compares vs previous week, and extracts top 3 categories.

4. **Category breakdown cards** (Task 4): `generateReportCards()` creates category cards with icon, amount, percentage, and trend indicators for each major spending category.

5. **TrendIndicator** (Task 5): Embedded in ReportCard.tsx with arrows (‚Üë‚Üì‚Üí), color coding (red=up/bad, green=down/good, gray=neutral), and percentage display.

6. **Rosa-friendly format** (Task 6): Uses Chilean Spanish colloquial language ("Subi√≥ harto", "Baj√≥ un poco", "Igual que antes"), large typography (text-4xl), and simple labels.

7. **Progress dots** (Task 7): ProgressDots component positioned at bottom with animated active dot and keyboard accessibility.

8. **Tests** (Task 8): 71 total tests across 3 test files - ReportCard (15), ReportCarousel (18), reportUtils (38).

### File List

**New Files:**
- `src/utils/reportUtils.ts` - Weekly summary generation, category breakdown, report card generation
- `src/components/reports/index.ts` - Export file for report components
- `src/views/ReportsView.tsx` - View component that renders the ReportCarousel
- `tests/unit/utils/reportUtils.test.ts` - 38 tests for data utilities

**Existing Files (already implemented):**
- `src/components/reports/ReportCard.tsx` - Card component with TrendIndicator
- `src/components/reports/ReportCarousel.tsx` - Swipeable carousel component
- `src/types/report.ts` - Type definitions and helper functions
- `tests/unit/components/reports/ReportCard.test.tsx` - 15 component tests
- `tests/unit/components/reports/ReportCarousel.test.tsx` - 18 component tests

**Modified Files (integration):**
- `src/App.tsx` - Added 'reports' to View type, imported ReportsView, added rendering logic with back button header
- `src/components/TopHeader.tsx` - Enabled Reports menu item (removed disabled: true)
- `tests/unit/components/TopHeader.test.tsx` - Updated test for "Pr√≥ximamente" badge count (now 1 instead of 2)

---

## Enhancement: Reports View Improvements (2026-01)

### New Features Implemented

#### 1. Transaction Count Badges on Report Rows
- **Component:** `ReportRow.tsx` updated to accept `transactionCount` prop
- **UI:** Receipt icon + number displayed in a pill badge next to report title
- **Purpose:** Users can quickly see how many transactions are in each report

#### 2. Category Groups with Semantic Colors
- **CSS Classes:** `.category-group`, `.category-group-header`, `.category-group-items`
- **Color themes:** food-dining (yellow), transport-auto (blue), health-wellness (pink), home-living (green), entertainment-leisure (purple), shopping-retail (red)
- **Purpose:** Visual grouping of related categories in report detail overlay

#### 3. ISO Week Handling for Cross-Month Boundaries
- **Problem:** ISO Week 1 of 2026 starts Dec 29, 2025 - week spans year/month boundary
- **Solution:** Updated `generateWeeklyReportsForYear()` to group transactions by ISO week, not calendar year
- **Navigation Fix:** Date range filtering added to `TemporalFilterState` to ensure exact ISO week matching

### Files Modified (Enhancement)

- `src/components/reports/ReportRow.tsx` - Added `transactionCount` prop and Receipt icon badge
- `src/views/ReportsView.tsx` - Pass `transactionCount` to ReportRow, fixed week navigation with date range
- `src/utils/reportUtils.ts` - Fixed `generateWeeklyReportsForYear()` to handle cross-year ISO weeks correctly
- `src/contexts/HistoryFiltersContext.tsx` - Added `dateRange` to `TemporalFilterState`
- `src/utils/historyFilterUtils.ts` - Added date range filtering priority in `matchesTemporalFilter()`
- `src/hooks/useHistoryFilters.ts` - Updated `getTemporalFilterLabel()` to show date range for ISO weeks

### Mockup Updates

- **File:** `docs/uxui/mockups/01_views/reports.html`
- **Changes:**
  - Added `.tx-count-badge` styles for transaction count pill
  - Added `.category-group` styles with semantic color themes
  - Updated report data to include `transactionCount` and `categoryGroups`
  - Updated `openReport()` function to render grouped categories

### Testing Notes

- Transaction counts now match between Reports view and History view
- Navigation from Reports to History uses exact date range for ISO weeks
- Filter chips display date range (e.g., "29 dic - 4 ene") for cross-month weeks
