# Story 14.2: Screen Transition System

**Status:** complete
**Points:** 3
**Epic:** 14 - Core Implementation
**Dependencies:** Story 14.1 (Animation Framework)

---

## Story

As a **user**,
I want **smooth transitions between screens with staggered content entry**,
so that **navigation feels fluid and content appears naturally**.

## Acceptance Criteria

1. **PageTransition wrapper component** created for screen-level transitions
2. **Staggered child entry** animations using useStaggeredReveal hook
3. **Settings exception** - Settings screen loads instantly (no animation) per motion-design-system.md
4. **Navigation integration** with existing router (react-router)
5. **Slide direction** respects navigation direction (left for forward, right for back)
6. **Reduced motion support** - instant transitions when user prefers reduced motion

## Tasks / Subtasks

- [x] Task 1: Create PageTransition component (AC: #1, #4)
  - [x] Create `src/components/animation/PageTransition.tsx`
  - [x] CSS-based animation with pageTransition keyframes
  - [x] Detect view changes for animation triggers
  - [x] Export from animation index

- [x] Task 2: Implement staggered child entry (AC: #2)
  - [x] Create TransitionChild component wrapper
  - [x] Apply transitionChildReveal CSS animation per item
  - [x] Automatic delay compression for long lists (max 2500ms)

- [x] Task 3: Implement Settings exception (AC: #3)
  - [x] Auto-detect 'settings' viewKey
  - [x] Skip animation for Settings route
  - [x] Support explicit skipAnimation prop

- [x] Task 4: Handle navigation direction (AC: #5)
  - [x] Create useNavigationDirection hook
  - [x] Track navigation history stack
  - [x] Slide from right for forward, left for back

- [x] Task 5: Ensure reduced motion support (AC: #6)
  - [x] Use useReducedMotion hook
  - [x] Instant transitions when reduced motion enabled
  - [x] CSS @media (prefers-reduced-motion) fallback

- [x] Task 6: Add CSS keyframes to global styles
  - [x] pageTransition keyframe (slide + fade)
  - [x] transitionChildReveal keyframe (slide-up + fade)
  - [x] will-change optimizations for GPU acceleration

- [x] Task 7: Write unit tests
  - [x] Test PageTransition rendering (18 tests)
  - [x] Test TransitionChild stagger (19 tests)
  - [x] Test useNavigationDirection (17 tests)
  - [x] All 54 tests passing

## Dev Notes

### Screen Transition Patterns

**From motion-design-system.md:**

| From | To | Animation |
|------|-----|-----------|
| Any | Settings | Instant (no animation) |
| Home | Analytics | Slide left with stagger |
| Analytics | Drill-down | Slide left |
| Drill-down | Back | Slide right |
| Any | Scan | Modal slide up |
| Scan | Result | Crossfade with reveal |

### Implementation Pattern

```typescript
interface PageTransitionProps {
  children: React.ReactNode;
  routeKey: string;
  skipAnimation?: boolean;
}

const PageTransition: React.FC<PageTransitionProps> = ({
  children,
  routeKey,
  skipAnimation = false
}) => {
  const prefersReducedMotion = useReducedMotion();
  const isSettings = routeKey.includes('settings');

  // Skip animation for Settings or reduced motion
  if (prefersReducedMotion || isSettings || skipAnimation) {
    return <>{children}</>;
  }

  // Apply transition animation
  return (
    <motion.div
      key={routeKey}
      initial={{ opacity: 0, x: 20 }}
      animate={{ opacity: 1, x: 0 }}
      exit={{ opacity: 0, x: -20 }}
      transition={{ duration: ANIMATION.DURATION.SLOW / 1000 }}
    >
      {children}
    </motion.div>
  );
};
```

### Project Structure

```
src/components/animation/
‚îú‚îÄ‚îÄ AnimationContext.tsx    # From 14.1
‚îú‚îÄ‚îÄ PageTransition.tsx      # NEW - Screen transitions
‚îú‚îÄ‚îÄ TransitionChild.tsx     # NEW - Staggered child wrapper
‚îú‚îÄ‚îÄ useBreathing.ts         # From 14.1
‚îú‚îÄ‚îÄ constants.ts            # From 14.1
‚îî‚îÄ‚îÄ index.ts
```

### Animation Library Decision

Consider using CSS-only animations first (existing pattern from Epic 11). If more complex orchestration needed, consider framer-motion as it's already in the ecosystem.

### References

- [Source: docs/sprint-artifacts/epic14/tech-context-epic14.md#Story 14.2]
- [Source: docs/uxui/motion-design-system.md#Screen Transitions]
- [Source: src/hooks/useStaggeredReveal.ts - Existing stagger pattern]

---

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Analytics Navigation Flow (#2)**: Drill-down transitions need smooth animations
- **History Filter Flow (#4)**: Filter changes may trigger content re-entry
- **Insight History Flow (#8)**: InsightsView navigation

### Downstream Effects to Consider

- All view components will be wrapped with PageTransition
- May affect perceived load time (animations add duration)
- Settings instant load is critical for user experience

### Testing Implications

- **Existing tests to verify:** Route navigation tests
- **New scenarios to add:** Transition animation timing, Settings exception, reduced motion

### Workflow Chain Visualization

```
[14.1 Animation Framework] ‚Üí [THIS STORY: Screen Transitions] ‚Üí [All Views, Navigation UX]
```

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

1. **CSS-based implementation**: Chose CSS animations over framer-motion to maintain consistency with existing Epic 11 animation patterns and reduce bundle size
2. **Simple view state integration**: App uses view state instead of react-router, so PageTransition works with viewKey string changes
3. **useNavigationDirection hook**: Provides stack-based history tracking for forward/back direction detection
4. **TransitionChild component**: Standalone wrapper for staggered animations, works independently of PageTransition
5. **Settings exception**: Auto-detects 'settings' in viewKey (case-insensitive) per motion-design-system.md Section 7
6. **GPU optimization**: Added will-change hints for smooth 60fps animations
7. **Accessibility**: Full prefers-reduced-motion support with CSS media query fallback

### File List

**New files created:**
- `src/components/animation/PageTransition.tsx` - Screen transition wrapper component
- `src/components/animation/TransitionChild.tsx` - Staggered child animation wrapper
- `src/components/animation/useNavigationDirection.ts` - Navigation direction tracking hook
- `tests/unit/components/animation/PageTransition.test.tsx` - 18 unit tests
- `tests/unit/components/animation/TransitionChild.test.tsx` - 19 unit tests
- `tests/unit/components/animation/useNavigationDirection.test.ts` - 17 unit tests

**Modified files:**
- `src/components/animation/index.ts` - Added exports for new components
- `index.html` - Added pageTransition and transitionChildReveal CSS keyframes

### Test Coverage

- 54 new tests passing
- Type checking passes
- No breaking changes to existing tests

### Code Review Fixes (2025-12-31)

**Issue #1 (HIGH):** `direction="none"` incorrectly applied slide animation instead of fade-only
- Added `pageTransitionFade` keyframe for fade-only transitions (tab switches)
- Fixed `getAnimationStyle()` to detect `direction === 'none'` and use fade animation
- Added test: "should handle none direction with fade only (no slide)"

**Issue #2 (MEDIUM):** Duplicate `NavigationDirection` type definition
- Removed duplicate type from PageTransition.tsx
- Now imports and re-exports from canonical location (useNavigationDirection.ts)

**Issue #3 (MEDIUM):** Dead code - `isVisible` state never set to false
- Removed unused `isVisible` state and related dead code
- Simplified component logic
