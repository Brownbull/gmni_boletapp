# Story 14.3: Scan Overlay Flow

**Status:** ready-for-dev
**Points:** 5
**Epic:** 14 - Core Implementation
**Dependencies:** Story 14.1 (Animation Framework), Story 14.2 (Screen Transitions)

---

## Story

As a **user**,
I want **a non-blocking overlay during receipt processing with progress feedback**,
so that **I can see the scan progress and results appear progressively**.

## Acceptance Criteria

1. **Grayed-out edit view** during processing with overlay on top
2. **Overlay component** with processing progress indicator
3. **ETA calculation** based on average processing time displayed to user
4. **Non-blocking navigation** - user can navigate away if needed
5. **Progressive item reveal** - items appear one-by-one using staggered animation on completion
6. **State transitions** - uploading ‚Üí processing ‚Üí ready states clearly shown

## Tasks / Subtasks

- [ ] Task 1: Create ScanOverlay component (AC: #1, #2)
  - [ ] Create `src/components/scan/ScanOverlay.tsx`
  - [ ] Semi-transparent backdrop with blur effect
  - [ ] Centered progress card with status
  - [ ] Integrate with existing ScanProgress component

- [ ] Task 2: Implement state machine for overlay (AC: #6)
  - [ ] Define states: idle, uploading, processing, ready, error
  - [ ] Create useScanOverlayState hook
  - [ ] Handle state transitions with animations

- [ ] Task 3: Add ETA calculation (AC: #3)
  - [ ] Track average processing time from history
  - [ ] Display estimated time remaining
  - [ ] Update ETA as processing progresses

- [ ] Task 4: Implement non-blocking behavior (AC: #4)
  - [ ] Allow back navigation during processing
  - [ ] Continue processing in background
  - [ ] Return to results when complete

- [ ] Task 5: Add progressive item reveal (AC: #5)
  - [ ] Use existing useStaggeredReveal hook
  - [ ] Animate items appearing in EditView
  - [ ] Apply fade-in + slide-up per item

- [ ] Task 6: Style overlay per mockup (AC: #1, #2)
  - [ ] Match scan-overlay.html mockup styles
  - [ ] Use design system CSS variables
  - [ ] Support dark mode

- [ ] Task 7: Write tests
  - [ ] Unit tests for state machine
  - [ ] Integration tests for overlay behavior
  - [ ] Test progressive reveal timing

## Dev Notes

### Mockup Reference

**From scan-overlay.html:**
- Semi-transparent backdrop
- Centered card with Gastify logo
- Progress indicator (spinner or progress bar)
- Status text: "Procesando...", "Analizando boleta..."
- Cancel button available

### State Machine Pattern

**From tech-context-epic14.md:**
```typescript
type ScanOverlayState = 'idle' | 'uploading' | 'processing' | 'ready' | 'error';

interface ScanOverlayContext {
  state: ScanOverlayState;
  progress: number;  // 0-100
  eta: number | null;  // seconds remaining
  items: ParsedItem[];
  error: string | null;
}
```

### Existing Components to Enhance

- `src/components/scan/ScanProgress.tsx` - Current progress component
- `src/components/scan/ScanError.tsx` - Error state handling
- `src/views/EditView.tsx` - Will receive progressive item reveal

### Design System Variables

```css
/* From scan-overlay.html */
--shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
--transition-spring: 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
```

### References

- [Source: docs/sprint-artifacts/epic14/tech-context-epic14.md#Story 14.3]
- [Source: docs/uxui/mockups/01_views/scan-overlay.html]
- [Source: src/components/scan/ScanProgress.tsx - Existing component]
- [Source: src/hooks/useStaggeredReveal.ts - Item reveal pattern]

---

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Scan Receipt Flow (#1)**: Core flow - overlay appears during OCR processing
- **Quick Save Flow (#6)**: Progressive reveal leads to QuickSaveCard or EditView
- **Batch Processing Flow (#9)**: May need to adapt for batch overlay

### Downstream Effects to Consider

- EditView will receive items progressively (not all at once)
- QuickSaveCard decision happens after reveal completes
- Must not block user if they want to cancel/navigate away
- Processing continues even if user navigates (background completion)

### Testing Implications

- **Existing tests to verify:** ScanProgress tests, EditView render tests
- **New scenarios to add:** State transitions, ETA accuracy, non-blocking navigation, progressive reveal timing

### Workflow Chain Visualization

```
[Camera Capture] ‚Üí [Gemini OCR] ‚Üí [THIS STORY: Scan Overlay] ‚Üí [EditView / QuickSaveCard]
```

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Completion Notes List

_To be filled during implementation_

### File List

_To be filled during implementation_
