# Story 14.3: Scan Overlay Flow

**Status:** done
**Points:** 5
**Epic:** 14 - Core Implementation
**Dependencies:** Story 14.1 (Animation Framework), Story 14.2 (Screen Transitions)

---

## Story

As a **user**,
I want **a non-blocking overlay during receipt processing with progress feedback**,
so that **I can see the scan progress and results appear progressively**.

## Acceptance Criteria

1. **Grayed-out edit view** during processing with overlay on top
2. **Overlay component** with processing progress indicator
3. **ETA calculation** based on average processing time displayed to user
4. **Non-blocking navigation** - user can navigate away if needed
5. **Progressive item reveal** - items appear one-by-one using staggered animation on completion
6. **State transitions** - uploading ‚Üí processing ‚Üí ready states clearly shown

## Tasks / Subtasks

- [x] Task 1: Create ScanOverlay component (AC: #1, #2)
  - [x] Create `src/components/scan/ScanOverlay.tsx`
  - [x] Semi-transparent backdrop with blur effect
  - [x] Centered progress card with status
  - [x] Export from `src/components/scan/index.ts` (App.tsx integration deferred to scan flow consumer)

- [x] Task 2: Implement state machine for overlay (AC: #6)
  - [x] Define states: idle, uploading, processing, ready, error
  - [x] Create useScanOverlayState hook
  - [x] Handle state transitions with animations

- [x] Task 3: Add ETA calculation (AC: #3)
  - [x] Track average processing time from history
  - [x] Display estimated time remaining
  - [x] Update ETA as processing progresses

- [x] Task 4: Implement non-blocking behavior (AC: #4)
  - [x] Allow back navigation during processing
  - [x] Navigation tip displayed: "Puedes navegar mientras procesamos"
  - [x] Overlay designed as non-modal (no forced focus trap)

- [x] Task 5: Add progressive item reveal (AC: #5)
  - [x] Use existing useStaggeredReveal hook (Story 11.3)
  - [x] EditView already has `animateItems` prop
  - [x] Apply fade-in + slide-up per item via AnimatedItem

- [x] Task 6: Style overlay per mockup (AC: #1, #2)
  - [x] Match scan-overlay.html mockup styles
  - [x] Use design system CSS variables
  - [x] Support dark mode with theme prop

- [x] Task 7: Write tests
  - [x] Unit tests for ScanOverlay component (26 tests)
  - [x] Unit tests for useScanOverlayState hook (20 tests)
  - [x] All 46 tests passing

## Dev Notes

### Mockup Reference

**From scan-overlay.html:**
- Semi-transparent backdrop
- Centered card with Gastify logo
- Progress indicator (spinner or progress bar)
- Status text: "Procesando...", "Analizando boleta..."
- Cancel button available

### State Machine Pattern

**From tech-context-epic14.md:**
```typescript
type ScanOverlayState = 'idle' | 'uploading' | 'processing' | 'ready' | 'error';

interface ScanOverlayContext {
  state: ScanOverlayState;
  progress: number;  // 0-100
  eta: number | null;  // seconds remaining
  items: ParsedItem[];
  error: string | null;
}
```

### Existing Components to Enhance

- `src/components/scan/ScanProgress.tsx` - Current progress component
- `src/components/scan/ScanError.tsx` - Error state handling
- `src/views/EditView.tsx` - Will receive progressive item reveal

### Design System Variables

```css
/* From scan-overlay.html */
--shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
--transition-spring: 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
```

### References

- [Source: docs/sprint-artifacts/epic14/tech-context-epic14.md#Story 14.3]
- [Source: docs/uxui/mockups/01_views/scan-overlay.html]
- [Source: src/components/scan/ScanProgress.tsx - Existing component]
- [Source: src/hooks/useStaggeredReveal.ts - Item reveal pattern]

---

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Scan Receipt Flow (#1)**: Core flow - overlay appears during OCR processing
- **Quick Save Flow (#6)**: Progressive reveal leads to QuickSaveCard or EditView
- **Batch Processing Flow (#9)**: May need to adapt for batch overlay

### Downstream Effects to Consider

- EditView will receive items progressively (not all at once)
- QuickSaveCard decision happens after reveal completes
- Must not block user if they want to cancel/navigate away
- Processing continues even if user navigates (background completion)

### Testing Implications

- **Existing tests to verify:** ScanProgress tests, EditView render tests
- **New scenarios to add:** State transitions, ETA accuracy, non-blocking navigation, progressive reveal timing

### Workflow Chain Visualization

```
[Camera Capture] ‚Üí [Gemini OCR] ‚Üí [THIS STORY: Scan Overlay] ‚Üí [EditView / QuickSaveCard]
```

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

1. Created `ScanOverlay.tsx` component with full state machine support (idle ‚Üí uploading ‚Üí processing ‚Üí ready ‚Üí error)
2. Created `useScanOverlayState.ts` hook extending existing `useScanState` with ETA calculation
3. ETA calculation uses rolling average of last 5 processing times, defaults to 4 seconds
4. Progressive item reveal leverages existing `useStaggeredReveal` hook from Story 11.3
5. Styling matches scan-overlay.html mockup with design system variables
6. Non-blocking behavior via tip message and no forced modal focus trap
7. Full test coverage: 26 component tests + 20 hook tests = 46 tests passing
8. Accessibility: aria-modal, aria-label per state, aria-live status announcements

### Atlas Code Review Fixes (2025-12-31)

1. **Fixed duplicate type definition** - `ScanOverlayState` now defined once in hook, re-exported from component
2. **Fixed hardcoded durations** - Now imports `DURATION` constants from `../animation/constants.ts` (Pattern #35)
3. **Clarified integration scope** - Task 1 updated to note App.tsx integration deferred to consumer story
4. **Updated comment** - Progressive reveal comment clarified to note delegation to EditView

### File List

**New Files:**
- `src/components/scan/ScanOverlay.tsx` - Main overlay component
- `src/hooks/useScanOverlayState.ts` - State machine hook with ETA
- `tests/unit/components/scan/ScanOverlay.test.tsx` - Component tests
- `tests/unit/hooks/useScanOverlayState.test.ts` - Hook tests

**Modified Files:**
- `src/components/scan/index.ts` - Added ScanOverlay exports
- `docs/sprint-artifacts/sprint-status.yaml` - Status update
