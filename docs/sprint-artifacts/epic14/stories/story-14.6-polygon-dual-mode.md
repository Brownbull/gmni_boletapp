# Story 14.6: Polygon Dual Mode

**Status:** ready-for-dev
**Points:** 3
**Epic:** 14 - Core Implementation
**Dependencies:** Story 14.5 (Dynamic Polygon Component)

---

## Story

As a **user analyzing my spending**,
I want **to toggle between merchant category and item group views on the polygon**,
so that **I can see my spending organized in different ways**.

## Acceptance Criteria

1. **Mode toggle component** - segmented control with "Categor√≠as" and "Grupos" options
2. **Merchant categories polygon** shows spending by store category (Supermercado, Restaurante, etc.)
3. **Item groups polygon** shows spending by item group (Alimentos, Transporte, etc.)
4. **Smooth transition** between polygon shapes when mode changes
5. **Mode state persistence** - remember user's last selected mode
6. **Labels update** with mode change to show correct category/group names

## Tasks / Subtasks

- [ ] Task 1: Create PolygonModeToggle component (AC: #1)
  - [ ] Create `src/components/polygon/PolygonModeToggle.tsx`
  - [ ] Segmented control with two options
  - [ ] Active state styling per design system
  - [ ] Touch-friendly sizing

- [ ] Task 2: Implement merchant categories mode (AC: #2)
  - [ ] Aggregate transactions by merchant category
  - [ ] Pass category data to DynamicPolygon
  - [ ] Use merchant category colors

- [ ] Task 3: Implement item groups mode (AC: #3)
  - [ ] Aggregate transactions by item group
  - [ ] Pass group data to DynamicPolygon
  - [ ] Use item group colors

- [ ] Task 4: Add smooth transition (AC: #4)
  - [ ] Animate polygon shape morphing between modes
  - [ ] Use CSS transition on polygon points
  - [ ] Labels crossfade during transition

- [ ] Task 5: Add mode persistence (AC: #5)
  - [ ] Store selected mode in localStorage
  - [ ] Load previous mode on mount
  - [ ] Default to merchant categories

- [ ] Task 6: Update labels on mode change (AC: #6)
  - [ ] Update vertex labels based on mode
  - [ ] Animate label text changes
  - [ ] Update amounts correctly

- [ ] Task 7: Write tests
  - [ ] Test mode toggle behavior
  - [ ] Test data aggregation for each mode
  - [ ] Test persistence

## Dev Notes

### Mode Toggle Design

**From mockups:**
```html
<div class="mode-toggle">
  <button class="toggle-option active">Categor√≠as</button>
  <button class="toggle-option">Grupos</button>
</div>
```

### Data Transformation

```typescript
type PolygonMode = 'categories' | 'groups';

// For merchant categories mode
function aggregateByMerchantCategory(transactions: Transaction[]): CategorySpending[] {
  // Group by merchant category (Supermercado, Restaurante, Farmacia, etc.)
}

// For item groups mode
function aggregateByItemGroup(transactions: Transaction[]): CategorySpending[] {
  // Group by item group (Alimentos, Transporte, Hogar, etc.)
}
```

### Animation Pattern

```css
.polygon-shape {
  transition: d 300ms ease-out; /* SVG path transition */
}

.polygon-label {
  transition: opacity 150ms ease;
}
```

### Existing Category System

**From architecture (Epic 9):**
- Merchant categories: Store Category level (Supermercado, etc.)
- Item groups: Item Group level (Alimentos, Transporte, etc.)
- Subcategories: Most granular level

### References

- [Source: docs/sprint-artifacts/epic14/tech-context-epic14.md#Story 14.6]
- [Source: docs/uxui/mockups/01_views/analytics-polygon.html]
- [Source: docs/architecture/architecture.md#Category System]

---

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Analytics Navigation Flow (#2)**: Mode toggle affects drill-down behavior
- **History Filter Flow (#4)**: Different modes lead to different filter paths

### Downstream Effects to Consider

- Vertex click behavior differs based on mode
- Story 14.7 (Lava Visual) will need to support both modes
- Analytics context may need mode state

### Testing Implications

- **Existing tests to verify:** Transaction aggregation tests
- **New scenarios to add:** Mode toggle, data transformation, persistence

### Workflow Chain Visualization

```
[14.5 Dynamic Polygon] ‚Üí [THIS STORY: Dual Mode] ‚Üí [14.7 Lava Visual]
```

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Completion Notes List

_To be filled during implementation_

### File List

_To be filled during implementation_
