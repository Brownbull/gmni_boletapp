# Story 14.17: "Intentional or Accidental?" Pattern

**Status:** done
**Points:** 2
**Epic:** 14 - Core Implementation
**Dependencies:** Story 14.1 (Animation Framework)

---

## Story

As a **user who made an unusual purchase**,
I want **a non-judgmental prompt asking if it was intentional**,
so that **I can reflect on my spending without feeling guilty**.

## Acceptance Criteria

1. **IntentionalPrompt dialog** component with two-button response
2. **Non-judgmental language** - "Fue intencional" / "No me hab√≠a dado cuenta"
3. **Response storage** in transaction metadata or separate collection
4. **Pattern detection trigger** - shows for unusual spending patterns
5. **Dismissible** - user can close without responding
6. **Entry animation** - dialog slides up smoothly

## Tasks / Subtasks

- [x] Task 1: Create IntentionalPrompt component (AC: #1, #6)
  - [x] Create `src/components/insights/IntentionalPrompt.tsx`
  - [x] Modal dialog with backdrop
  - [x] Slide-up entry animation (using animate-slide-up CSS class)
  - [x] Two primary buttons

- [x] Task 2: Implement non-judgmental copy (AC: #2)
  - [x] Title: "¬øFue intencional?" (Was this intentional?)
  - [x] Button 1: "S√≠, fue intencional" (Yes, it was intentional)
  - [x] Button 2: "No me hab√≠a dado cuenta" (I hadn't realized)
  - [x] Optional context message about the pattern

- [x] Task 3: Implement response storage (AC: #3)
  - [x] Add 'intentionalResponse' field to InsightRecord
  - [x] Add 'intentionalResponseAt' timestamp field
  - [x] Allow null for dismissed prompts
  - [x] recordIntentionalResponse() function in insightProfileService

- [x] Task 4: Integrate with pattern detection (AC: #4)
  - [x] shouldShowIntentionalPrompt() function exported from component
  - [x] Trigger for category_trend, spending_velocity insights
  - [x] Only for >30% increases (direction === 'up')

- [x] Task 5: Add dismissible behavior (AC: #5)
  - [x] Backdrop click dismisses
  - [x] X button in corner
  - [x] Escape key dismisses
  - [x] No response stored on dismiss (null value)

- [x] Task 6: Write tests
  - [x] Test dialog rendering (16 tests)
  - [x] Test response storage (4 tests)
  - [x] Test dismiss behavior (3 tests)
  - [x] Test shouldShowIntentionalPrompt trigger logic (6 tests)

## Dev Notes

### Non-Judgmental Voice

**From voice-tone-guidelines.md - Principle #1: Observes without judging:**

| Judgmental | Non-Judgmental |
|------------|----------------|
| "You overspent on restaurants" | "Restaurants up 23%" |
| "You should save more" | "This is different for you" |
| "Bad spending habit" | "¬øFue intencional?" |

### Component Interface

```typescript
interface IntentionalPromptProps {
  insight: InsightRecord;
  context: string;  // e.g., "Restaurantes subi√≥ 45% esta semana"
  onResponse: (intentional: boolean) => void;
  onDismiss: () => void;
}
```

### Trigger Conditions

Show IntentionalPrompt when:
1. `category_trend` insight shows >30% increase
2. `spending_velocity` insight shows unusual spike
3. `out_of_character` detection (future Epic 15)

```typescript
function shouldShowIntentionalPrompt(insight: InsightRecord): boolean {
  const triggerTypes = ['category_trend', 'spending_velocity'];
  if (!triggerTypes.includes(insight.type)) return false;

  // Only for increases, not decreases
  if (insight.metadata?.direction !== 'up') return false;

  // Only for significant changes (>30%)
  if ((insight.metadata?.percentChange || 0) < 30) return false;

  return true;
}
```

### Response Storage

```typescript
interface IntentionalResponse {
  insightId: string;
  transactionId?: string;
  response: 'intentional' | 'unintentional' | null;
  timestamp: Date;
}

// Store in user's insight profile
await saveIntentionalResponse(userId, response);
```

### Animation

```css
.intentional-prompt {
  animation: slideUp 300ms ease-out;
}

@keyframes slideUp {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}
```

### References

- [Source: docs/sprint-artifacts/epic14/tech-context-epic14.md#Story 14.11]
- [Source: docs/uxui/voice-tone-guidelines.md#Non-judgmental prompts]
- [Source: docs/uxui/mockups/01_views/insights.html]

---

## Atlas Workflow Analysis

> üó∫Ô∏è This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Insight Generation Flow (#5)**: IntentionalPrompt triggered by insights
- **Quick Save Flow (#6)**: May show after unusual saves

### Downstream Effects to Consider

- Response data can inform future insight generation
- Story 15.7 (Out-of-Character Detection) builds on this pattern
- Don't overwhelm user - limit prompt frequency

### Testing Implications

- **Existing tests to verify:** InsightEngine tests
- **New scenarios to add:** Prompt triggers, response storage, cooldown

### Workflow Chain Visualization

```
[Insight Generation] ‚Üí [Pattern Detection] ‚Üí [THIS STORY: Intentional Prompt] ‚Üí [User Response] ‚Üí [Profile Learning]
```

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

1. Created IntentionalPrompt component with full WCAG 2.1 Level AA compliance
2. Implemented non-judgmental Spanish/English translations following voice-tone-guidelines.md
3. Added intentionalResponse and intentionalResponseAt fields to InsightRecord type
4. Created recordIntentionalResponse() service function in insightProfileService.ts
5. Implemented shouldShowIntentionalPrompt() trigger logic for category_trend/spending_velocity insights
6. Full dismissible behavior: X button, backdrop click, Escape key
7. Animation: Uses existing animate-slide-up class, respects prefers-reduced-motion
8. Comprehensive test coverage: 20 new tests (16 component + 4 service)
9. Created barrel export file for insights components

### File List

**New Files:**
- `src/components/insights/IntentionalPrompt.tsx` - Main dialog component
- `src/components/insights/index.ts` - Barrel export for insights components
- `tests/unit/components/insights/IntentionalPrompt.test.tsx` - Component tests (16 tests)

**Modified Files:**
- `src/types/insight.ts` - Added intentionalResponse and intentionalResponseAt to InsightRecord
- `src/services/insightProfileService.ts` - Added recordIntentionalResponse() function
- `src/utils/translations.ts` - Added intentionalPromptTitle, intentionalYes, intentionalNo translations
- `tests/unit/services/insightProfileService.test.ts` - Added 4 tests for recordIntentionalResponse

### Change Log

| Date | Change | Files |
|------|--------|-------|
| 2026-01-12 | Story implementation complete | All files listed above |
| 2026-01-12 | Code review: Added barrel export, clarified shouldShowIntentionalPrompt comments | IntentionalPrompt.tsx, index.ts, story file |
