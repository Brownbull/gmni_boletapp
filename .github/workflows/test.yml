name: Test Suite

on:
  push:
    branches: [ main, staging, develop ]
  pull_request:
    branches: [ main, staging, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for gitleaks

      # Step 2: Scan for secrets (Story 4.1)
      # Runs early to fail fast if secrets are detected
      # Uses gitleaks GitHub Action for comprehensive scanning
      - name: Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Setup Node.js 20 (LTS)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 4: Cache node_modules for faster builds
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Step 5: Install dependencies (npm ci for deterministic builds)
      - name: Install dependencies
        run: npm ci

      # Step 6: Install Firebase CLI
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Step 7: Install Playwright browsers
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      # Step 7.5: Install functions dependencies and build
      # Epic 4.5: Integration tests verify compiled Cloud Functions output
      - name: Install and build Cloud Functions
        run: |
          cd functions
          npm ci
          npm run build
          cd ..

      # Step 8: Start Firebase emulators in background
      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          # Wait for emulators to be ready (max 30s)
          echo "Waiting for Firebase emulators to start..."
          for i in {1..30}; do
            if curl -s http://localhost:4000 > /dev/null; then
              echo "Firebase emulators ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 1
          done

      # Step 9: Run unit tests
      - name: Run unit tests
        run: npm run test:unit
        continue-on-error: false
        env:
          # Required for config/gemini.ts initialization
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      # Step 10: Run integration tests
      - name: Run integration tests
        run: npm run test:integration
        continue-on-error: false
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          # Firebase config (using Firebase emulator, so placeholder values are OK)
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          # Gemini API config
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      # Step 11: Create test user for E2E accessibility tests
      # Story 3.5: Test user needed for authenticated view accessibility testing
      - name: Create test user in Firebase Auth emulator
        run: npx tsx scripts/create-test-user.ts
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080

      # Step 12: Run E2E tests (Playwright manages dev server via webServer config)
      - name: Run E2E tests
        run: npm run test:e2e
        continue-on-error: false
        env:
          CI: true
          # Firebase config (using Firebase emulator, so placeholder values are OK)
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          # Gemini API config (not needed for smoke tests, using placeholder)
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      # Step 13: Generate coverage report with threshold enforcement
      # Story 3.7: Coverage thresholds configured in vite.config.ts
      # Thresholds: lines 45%, branches 30%, functions 25%, statements 40%
      # Vitest exits with non-zero code if coverage below thresholds
      - name: Generate coverage report with threshold enforcement
        run: npm run test:coverage
        continue-on-error: false
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          # Firebase config (using Firebase emulator, so placeholder values are OK)
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          # Gemini API config
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      # Step 14: Upload HTML coverage report as artifact
      - name: Upload coverage report (HTML)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-html
          path: coverage/
          retention-days: 30

      # Step 15: Upload lcov coverage for potential badge integration
      - name: Upload coverage report (lcov)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-lcov
          path: coverage/coverage-final.json
          retention-days: 30

      # Step 16: Display coverage summary in logs
      - name: Display coverage summary
        if: always()
        run: |
          echo "Coverage report generated. Download artifacts to view detailed HTML report."
          if [ -f coverage/coverage-final.json ]; then
            echo "‚úÖ Coverage data available"
          else
            echo "‚ö†Ô∏è Coverage data not found"
          fi

      # Step 17: Post coverage report to PR comments
      # Story 3.7: Uses vitest-coverage-report-action for PR coverage visibility
      # Shows coverage breakdown and comparison to base branch
      - name: Post coverage report to PR
        uses: davelosert/vitest-coverage-report-action@v2
        if: github.event_name == 'pull_request'
        with:
          json-summary-path: './coverage/coverage-summary.json'
          json-final-path: './coverage/coverage-final.json'
          vite-config-path: './vite.config.ts'
          file-coverage-mode: 'all'
          name: 'Coverage Report'

      # Step 18: Run Lighthouse CI Performance Audits
      # Story 3.6: Runs Lighthouse audits on all major views (Login + 5 authenticated)
      - name: Run Lighthouse performance audits
        run: npm run test:lighthouse
        continue-on-error: true  # Warn mode - don't fail CI on score drops
        env:
          CI: true
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      # Step 19: Upload Lighthouse reports as artifacts
      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: lighthouse-reports/
          retention-days: 90

      # Step 20: Check bundle size
      # Story 3.6: Warn if bundle size increases >10% from baseline (~637KB)
      - name: Check bundle size
        run: |
          npm run build
          BUNDLE_SIZE=$(du -sk dist/assets/*.js | awk '{total += $1} END {print total}')
          echo "üì¶ Bundle size: ${BUNDLE_SIZE}KB"
          # Baseline: 637KB, Threshold: 700KB (10% increase)
          if [ "$BUNDLE_SIZE" -gt 700 ]; then
            echo "‚ö†Ô∏è WARNING: Bundle size exceeds threshold (${BUNDLE_SIZE}KB > 700KB)"
            echo "Consider code splitting or removing unused dependencies"
          else
            echo "‚úÖ Bundle size within acceptable range"
          fi
        env:
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      # Step 21: Run npm audit for dependency vulnerabilities
      # Story 4.3: Scans package dependencies for HIGH/CRITICAL vulnerabilities
      # Fails CI if any HIGH or CRITICAL severity vulnerabilities are found
      - name: Run npm audit
        run: |
          echo "üîç Scanning dependencies for vulnerabilities..."
          npm audit --audit-level=high
          echo "‚úÖ No HIGH or CRITICAL vulnerabilities found"
        continue-on-error: false

      # Step 22: Run ESLint security rules
      # Story 4.3: Static code analysis for security anti-patterns
      # Detects: eval(), unsafe regex, object injection, timing attacks
      - name: Run security lint
        run: |
          echo "üîç Running security-focused static analysis..."
          npx eslint -c eslint.config.security.mjs src/
          echo "‚úÖ Security lint passed"
        continue-on-error: false

  # ============================================================================
  # DEPLOYMENT JOB - Story 6.0: CI/CD Auto-Deploy to Firebase
  # ============================================================================
  # Only runs on push to main branch after all tests pass
  # Uses Firebase service account for authentication (no interactive login)
  # ============================================================================
  deploy:
    name: Deploy to Firebase Hosting
    needs: test
    runs-on: ubuntu-latest
    # Only deploy on push to main (not PRs, not other branches)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      # Step D1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step D2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step D3: Cache dependencies
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Step D4: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step D5: Build for production
      - name: Build for production
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
          VITE_GEMINI_MODEL: ${{ secrets.VITE_GEMINI_MODEL }}

      # Step D6: Deploy to Firebase Hosting
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: boletapp-d609f

      # Step D7: Deployment success notification
      - name: Deployment complete
        run: |
          echo "üöÄ Deployment successful!"
          echo "üì¶ Production URL: https://boletapp-d609f.web.app"
          echo "‚è∞ Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
