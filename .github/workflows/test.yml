name: Test Suite

on:
  push:
    branches: [ main, staging, develop ]
  pull_request:
    branches: [ main, staging, develop ]
  # Story 8.9 AC4: Manual workflow dispatch for redeployments without empty commits
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests and deploy directly (use with caution)'
        type: boolean
        default: false
      reason:
        description: 'Reason for manual trigger (e.g., secret rotation)'
        type: string
        required: false

# ============================================================================
# Story 8.9: CI/CD Pipeline Optimization
# Restructured from sequential (~11 min) to parallel (~6-7 min)
#
# Job dependency graph:
#   setup ─┬─► test-unit ─────────┬─► deploy (main only)
#          ├─► test-integration ──┤
#          ├─► test-e2e ──────────┤
#          ├─► security ──────────┘
#          └─► lighthouse (main push only, runs in parallel)
#
# Key optimizations:
# - AC1: Parallel test jobs (unit, integration, e2e run concurrently)
# - AC2: Playwright browser and Firebase CLI caching (~50s saved)
# - AC3: Lighthouse only on main branch pushes (~4.5 min saved on PRs)
# - AC4: workflow_dispatch for manual deployments
# - AC5: Combined unit tests with coverage (eliminates duplicate run)
# ============================================================================

jobs:
  # ============================================================================
  # SETUP JOB - Shared setup and caching for all test jobs
  # ============================================================================
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      playwright-cache-hit: ${{ steps.playwright-cache.outputs.cache-hit }}
      firebase-cache-hit: ${{ steps.firebase-cache.outputs.cache-hit }}

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for gitleaks

      # Step 2: Scan for secrets (Story 4.1)
      # Runs early to fail fast if secrets are detected
      - name: Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Setup Node.js 20 (LTS)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 4: Cache node_modules for faster builds
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Step 5: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 6: Cache Playwright browsers (Story 8.9 AC2)
      # Saves ~29s on subsequent runs
      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # Step 7: Install Playwright browsers (skip if cached)
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      # Step 8: Install Playwright system deps (always needed even with cached browsers)
      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      # Step 9: Cache Firebase CLI (Story 8.9 AC2)
      # Saves ~19s on subsequent runs
      - name: Cache Firebase CLI
        id: firebase-cache
        uses: actions/cache@v4
        with:
          path: ~/.npm/_npx
          key: ${{ runner.os }}-firebase-cli-13
          restore-keys: |
            ${{ runner.os }}-firebase-cli-

      # Step 10: Install Firebase CLI
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Step 11: Build Cloud Functions (needed by multiple jobs)
      - name: Install and build Cloud Functions
        run: |
          cd functions
          npm ci
          npm run build
          cd ..

      # Step 12: Cache node_modules for parallel jobs
      - name: Cache workspace for parallel jobs
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

  # ============================================================================
  # TEST-UNIT JOB - Unit tests with coverage (Story 8.9 AC1, AC5)
  # Combines unit tests + coverage to eliminate duplicate test runs
  # ============================================================================
  test-unit:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Skip tests if workflow_dispatch with skip_tests=true
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Restore cached workspace
      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Setup Java for Firebase emulators (needed for categoryMappingService tests)
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Install Firebase CLI
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Start emulators for unit tests that need them
      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators to start..."
          for i in {1..60}; do
            HUB_READY=$(curl -s http://localhost:4000 > /dev/null && echo "yes" || echo "no")
            FIRESTORE_READY=$(curl -s http://localhost:8080 > /dev/null && echo "yes" || echo "no")
            if [ "$HUB_READY" = "yes" ] && [ "$FIRESTORE_READY" = "yes" ]; then
              echo "Firebase emulators ready!"
              sleep 3
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 1
          done

      # Run unit tests with coverage (Story 8.9 AC5 - combined, not separate)
      - name: Run unit tests with coverage
        run: npm run test:coverage
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

      # Upload coverage reports
      - name: Upload coverage report (HTML)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-html
          path: coverage/
          retention-days: 30

      - name: Upload coverage report (lcov)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-lcov
          path: coverage/coverage-final.json
          retention-days: 30

      # Post coverage to PR
      - name: Post coverage report to PR
        uses: davelosert/vitest-coverage-report-action@v2
        if: github.event_name == 'pull_request'
        with:
          json-summary-path: './coverage/coverage-summary.json'
          json-final-path: './coverage/coverage-final.json'
          vite-config-path: './vite.config.ts'
          file-coverage-mode: 'all'
          name: 'Coverage Report'

  # ============================================================================
  # TEST-INTEGRATION JOB - Integration tests (Story 8.9 AC1)
  # ============================================================================
  test-integration:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators to start..."
          for i in {1..60}; do
            HUB_READY=$(curl -s http://localhost:4000 > /dev/null && echo "yes" || echo "no")
            FIRESTORE_READY=$(curl -s http://localhost:8080 > /dev/null && echo "yes" || echo "no")
            if [ "$HUB_READY" = "yes" ] && [ "$FIRESTORE_READY" = "yes" ]; then
              echo "Firebase emulators ready!"
              sleep 3
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 1
          done

      - name: Run integration tests
        run: npm run test:integration
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

  # ============================================================================
  # TEST-E2E JOB - End-to-end tests (Story 8.9 AC1)
  # ============================================================================
  test-e2e:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Restore cached Playwright browsers
      - name: Restore Playwright cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # Install Playwright system dependencies (always needed)
      - name: Install Playwright dependencies
        run: npx playwright install-deps chromium

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators to start..."
          for i in {1..60}; do
            HUB_READY=$(curl -s http://localhost:4000 > /dev/null && echo "yes" || echo "no")
            FIRESTORE_READY=$(curl -s http://localhost:8080 > /dev/null && echo "yes" || echo "no")
            if [ "$HUB_READY" = "yes" ] && [ "$FIRESTORE_READY" = "yes" ]; then
              echo "Firebase emulators ready!"
              sleep 3
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 1
          done

      - name: Create test user in Firebase Auth emulator
        run: npx tsx scripts/create-test-user.ts
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

  # ============================================================================
  # SECURITY JOB - Security checks (bundle size, audit, lint)
  # ============================================================================
  security:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Bundle size check
      - name: Check bundle size
        run: |
          npm run build
          BUNDLE_SIZE=$(du -sk dist/assets/*.js | awk '{total += $1} END {print total}')
          echo "Bundle size: ${BUNDLE_SIZE}KB"
          if [ "$BUNDLE_SIZE" -gt 700 ]; then
            echo "WARNING: Bundle size exceeds threshold (${BUNDLE_SIZE}KB > 700KB)"
            echo "Consider code splitting or removing unused dependencies"
          else
            echo "Bundle size within acceptable range"
          fi
        env:
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      # npm audit
      - name: Run npm audit
        run: |
          echo "Scanning dependencies for vulnerabilities..."
          npm audit --audit-level=high
          echo "No HIGH or CRITICAL vulnerabilities found"

      # Security lint
      - name: Run security lint
        run: |
          echo "Running security-focused static analysis..."
          npx eslint -c eslint.config.security.mjs src/
          echo "Security lint passed"

  # ============================================================================
  # LIGHTHOUSE JOB - Performance audits (Story 8.9 AC3)
  # Only runs on push to main branch to save ~4.5 min on PRs
  # ============================================================================
  lighthouse:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Story 8.9 AC3: Only run Lighthouse on main branch pushes
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Restore Playwright cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright dependencies
        run: npx playwright install-deps chromium

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators to start..."
          for i in {1..60}; do
            HUB_READY=$(curl -s http://localhost:4000 > /dev/null && echo "yes" || echo "no")
            FIRESTORE_READY=$(curl -s http://localhost:8080 > /dev/null && echo "yes" || echo "no")
            if [ "$HUB_READY" = "yes" ] && [ "$FIRESTORE_READY" = "yes" ]; then
              echo "Firebase emulators ready!"
              sleep 3
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 1
          done

      - name: Create test user for Lighthouse
        run: npx tsx scripts/create-test-user.ts
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080

      - name: Run Lighthouse performance audits
        run: npm run test:lighthouse
        continue-on-error: true  # Warn mode - don't fail CI on score drops
        env:
          CI: true
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: lighthouse-reports/
          retention-days: 90

  # ============================================================================
  # DEPLOYMENT JOB - Story 6.0: CI/CD Auto-Deploy to Firebase
  # ============================================================================
  deploy:
    name: Deploy to Firebase Hosting
    needs: [test-unit, test-integration, test-e2e, security]
    runs-on: ubuntu-latest
    # Deploy on push to main OR manual workflow_dispatch
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
          VITE_GEMINI_MODEL: ${{ secrets.VITE_GEMINI_MODEL }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: boletapp-d609f

      - name: Deployment complete
        run: |
          echo "Deployment successful!"
          echo "Production URL: https://boletapp-d609f.web.app"
          echo "Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Trigger: Manual workflow dispatch"
            echo "Reason: ${{ inputs.reason || 'Not specified' }}"
          fi
