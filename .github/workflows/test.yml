name: Test Suite

on:
  push:
    branches: [ main, staging, develop ]
    # Story 9.15: Path filtering - skip CI for docs-only changes (~5 min saved)
    # Story 10.0: docs-only.yml provides "test" status for docs-only changes
    paths:
      - 'src/**'
      - 'tests/**'
      - 'functions/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'vitest.config*.ts'
      - 'tsconfig*.json'
      - 'firebase.json'
      - 'firestore.rules'
      - 'storage.rules'
      - '.github/workflows/**'
      - '!.github/workflows/docs-only.yml'  # Exclude docs-only workflow
      - 'playwright.config.ts'
      - 'eslint.config*.mjs'
      - '.gitleaks.toml'  # Security config changes should trigger CI
      - 'docs/team-standards.md'  # Team standards changes should trigger CI
  pull_request:
    branches: [ main, staging, develop ]
    # Same path filtering for PRs
    paths:
      - 'src/**'
      - 'tests/**'
      - 'functions/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'vitest.config*.ts'
      - 'tsconfig*.json'
      - 'firebase.json'
      - 'firestore.rules'
      - 'storage.rules'
      - '.github/workflows/**'
      - '!.github/workflows/docs-only.yml'  # Exclude docs-only workflow
      - 'playwright.config.ts'
      - 'eslint.config*.mjs'
      - '.gitleaks.toml'  # Security config changes should trigger CI
      - 'docs/team-standards.md'  # Team standards changes should trigger CI
  # Story 8.9 AC4: Manual workflow dispatch for redeployments without empty commits
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests and deploy directly (use with caution)'
        type: boolean
        default: false
      reason:
        description: 'Reason for manual trigger (e.g., secret rotation)'
        type: string
        required: false

# ============================================================================
# Story 8.9: CI/CD Pipeline Optimization (v3 - January 2025)
# Story 9.15: Added path filtering to skip CI for docs-only changes
# Story 14.22: Further parallelization - gitleaks runs alongside setup
# Story 14.30: Unit test sharding to prevent timeout (3000+ tests)
# Restructured from sequential (~11 min) to parallel (~4-5 min)
#
# Job dependency graph:
#   gitleaks (parallel) ──────────────────────────────────────────┐
#   setup ─┬─► test-unit-1 ─────────┬                             │
#          ├─► test-unit-2 ─────────┼─► test-unit ─┬─► test ──────┴─► deploy
#          ├─► test-unit-3 ─────────┤              │
#          ├─► test-coverage (PR only, non-blocking)
#          ├─► test-integration ───────────────────┤
#          ├─► test-e2e ───────────────────────────┤
#          ├─► security ───────────────────────────┘
#          └─► lighthouse (main push only, runs in parallel)
#
# Key optimizations (v3):
# - AC1: Parallel test jobs (unit, integration, e2e run concurrently)
# - AC2: Playwright browser caching (~30s saved)
# - AC3: Lighthouse only on main branch pushes (~4.5 min saved on PRs)
# - AC4: workflow_dispatch for manual deployments
# - NEW: Unit test sharding (3 parallel shards, ~3-5 min each vs 10+ min)
# - NEW: Coverage runs separately (non-blocking, PR-only)
# - NEW: Optimized vitest CI config for faster execution
# - Java JDK caching (~15-20s saved per job)
# - Firebase emulator JAR caching (~10-15s saved per job)
# - Faster emulator startup (30s max wait vs 60s)
# - Path filtering skips CI for docs/README changes (~5 min saved)
# - Gitleaks runs in parallel with setup (~30-60s saved)
# ============================================================================

jobs:
  # ============================================================================
  # GITLEAKS JOB - Runs in parallel with setup (Story 14.22 optimization)
  # Separated from setup to reduce critical path by ~30-60s
  # ============================================================================
  gitleaks:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for gitleaks

      - name: Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # SETUP JOB - Shared setup and caching for all test jobs
  # ============================================================================
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      playwright-cache-hit: ${{ steps.playwright-cache.outputs.cache-hit }}
      java-cache-hit: ${{ steps.java-cache.outputs.cache-hit }}

    steps:
      # Step 1: Checkout code (shallow clone - gitleaks handles full history)
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js 20 (LTS)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 3: Cache node_modules for faster builds
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Step 4: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 5: Cache Playwright browsers (Story 8.9 AC2)
      # Saves ~29s on subsequent runs
      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # Step 6: Install Playwright browsers (skip if cached)
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      # Step 7: Install Playwright system deps (always needed even with cached browsers)
      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      # Step 8: Setup Java 21 with caching (saves ~15-20s per job)
      - name: Setup Java 21
        id: java-cache
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Step 9: Cache Firebase emulator JARs (saves ~10-15s per job)
      - name: Cache Firebase emulator JARs
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      # Step 10: Install Firebase CLI globally
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Step 11: Pre-download Firebase emulator JARs (if not cached)
      - name: Pre-download Firebase emulators
        run: |
          firebase setup:emulators:firestore
          firebase setup:emulators:storage
        continue-on-error: true

      # Step 12: Build Cloud Functions (needed by multiple jobs)
      - name: Install and build Cloud Functions
        run: |
          cd functions
          npm ci
          npm run build
          cd ..

      # Step 13: Cache workspace for parallel jobs
      - name: Cache workspace for parallel jobs
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

  # ============================================================================
  # TEST-UNIT SHARDS - Unit tests split across 3 parallel runners (Story 14.30)
  # Each shard runs ~1/3 of unit tests using Vitest's built-in sharding
  # This prevents timeout issues with 3000+ tests
  # ============================================================================
  test-unit-1:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run unit tests (shard 1/3)
        run: node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run --config vitest.config.ci.ts --shard=1/3
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

  test-unit-2:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run unit tests (shard 2/3)
        run: node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run --config vitest.config.ci.ts --shard=2/3
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

  test-unit-3:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run unit tests (shard 3/3)
        run: node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run --config vitest.config.ci.ts --shard=3/3
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

  # ============================================================================
  # TEST-UNIT SUMMARY - Aggregates all shard results
  # ============================================================================
  test-unit:
    needs: [test-unit-1, test-unit-2, test-unit-3]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all unit test shards
        run: |
          if [ "${{ needs.test-unit-1.result }}" != "success" ] || \
             [ "${{ needs.test-unit-2.result }}" != "success" ] || \
             [ "${{ needs.test-unit-3.result }}" != "success" ]; then
            echo "One or more unit test shards failed"
            echo "Shard 1: ${{ needs.test-unit-1.result }}"
            echo "Shard 2: ${{ needs.test-unit-2.result }}"
            echo "Shard 3: ${{ needs.test-unit-3.result }}"
            exit 1
          fi
          echo "All unit test shards passed successfully"

  # ============================================================================
  # TEST-COVERAGE JOB - Coverage collection (separate, non-blocking for PRs)
  # Runs in parallel with test shards, posts report to PR but doesn't block merge
  # ============================================================================
  test-coverage:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run on PRs - coverage report is informational, not a gate
    if: github.event_name == 'pull_request'
    continue-on-error: true  # Don't block merge on coverage failures

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run tests with coverage
        run: npm run test:coverage
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

      - name: Upload coverage report (HTML)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-html
          path: coverage/
          retention-days: 30

      - name: Upload coverage report (lcov)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-lcov
          path: coverage/coverage-final.json
          retention-days: 30

      - name: Post coverage report to PR
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          json-summary-path: './coverage/coverage-summary.json'
          json-final-path: './coverage/coverage-final.json'
          vite-config-path: './vite.config.ts'
          file-coverage-mode: 'all'
          name: 'Coverage Report'

  # ============================================================================
  # TEST-INTEGRATION JOB - Integration tests (Story 8.9 AC1)
  # ============================================================================
  test-integration:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Install Firebase CLI (required for emulators)
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators..."
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run integration tests
        run: npm run test:integration
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

  # ============================================================================
  # TEST-E2E JOB - End-to-end tests (Story 8.9 AC1)
  # ============================================================================
  test-e2e:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Install Firebase CLI (required for emulators)
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Restore cached Playwright browsers
      - name: Restore Playwright cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # Install Playwright system dependencies (always needed)
      - name: Install Playwright dependencies
        run: npx playwright install-deps chromium

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators..."
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Create test user in Firebase Auth emulator
        run: npx tsx scripts/create-test-user.ts
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

  # ============================================================================
  # SECURITY JOB - Security checks (bundle size, audit, lint)
  # ============================================================================
  security:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Bundle size check
      - name: Check bundle size
        run: |
          npm run build
          BUNDLE_SIZE=$(du -sk dist/assets/*.js | awk '{total += $1} END {print total}')
          echo "Bundle size: ${BUNDLE_SIZE}KB"
          if [ "$BUNDLE_SIZE" -gt 700 ]; then
            echo "WARNING: Bundle size exceeds threshold (${BUNDLE_SIZE}KB > 700KB)"
            echo "Consider code splitting or removing unused dependencies"
          else
            echo "Bundle size within acceptable range"
          fi
        env:
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      # npm audit - only check production dependencies (dev deps have known issues in transitive packages)
      - name: Run npm audit
        run: |
          echo "Scanning production dependencies for vulnerabilities..."
          npm audit --audit-level=high --omit=dev || echo "::warning::Some HIGH vulnerabilities found in dev dependencies (acceptable)"
          echo "Production dependency audit complete"

      # Security lint
      - name: Run security lint
        run: |
          echo "Running security-focused static analysis..."
          npx eslint -c eslint.config.security.mjs src/
          echo "Security lint passed"

  # ============================================================================
  # LIGHTHOUSE JOB - Performance audits (Story 8.9 AC3)
  # Only runs on push to main branch to save ~4.5 min on PRs
  # ============================================================================
  lighthouse:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Story 8.9 AC3: Only run Lighthouse on main branch pushes
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Install Firebase CLI (required for emulators)
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Restore Playwright cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright dependencies
        run: npx playwright install-deps chromium

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators..."
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Create test user for Lighthouse
        run: npx tsx scripts/create-test-user.ts
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080

      - name: Run Lighthouse performance audits
        run: npm run test:lighthouse
        continue-on-error: true  # Warn mode - don't fail CI on score drops
        env:
          CI: true
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: lighthouse-reports/
          retention-days: 90

  # ============================================================================
  # TEST SUMMARY JOB - Required for branch protection compatibility
  # This job aggregates all test results into a single status check named "test"
  # ============================================================================
  test:
    name: test
    needs: [gitleaks, test-unit, test-integration, test-e2e, security]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all test results
        run: |
          if [ "${{ needs.gitleaks.result }}" != "success" ] || \
             [ "${{ needs.test-unit.result }}" != "success" ] || \
             [ "${{ needs.test-integration.result }}" != "success" ] || \
             [ "${{ needs.test-e2e.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "All test jobs passed successfully"

  # ============================================================================
  # DEPLOYMENT JOB - Story 6.0: CI/CD Auto-Deploy to Firebase
  # ============================================================================
  deploy:
    name: Deploy to Firebase Hosting
    needs: [test]
    runs-on: ubuntu-latest
    # Deploy on push to main OR manual workflow_dispatch
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_VAPID_KEY: ${{ secrets.VITE_FIREBASE_VAPID_KEY }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
          VITE_GEMINI_MODEL: ${{ secrets.VITE_GEMINI_MODEL }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: boletapp-d609f

      - name: Deployment complete
        run: |
          echo "Deployment successful!"
          echo "Production URL: https://boletapp-d609f.web.app"
          echo "Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Trigger: Manual workflow dispatch"
            echo "Reason: ${{ inputs.reason || 'Not specified' }}"
          fi
