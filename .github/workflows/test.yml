name: Test Suite

on:
  push:
    branches: [ main, staging, develop ]
    # Story 9.15: Path filtering - skip CI for docs-only changes (~5 min saved)
    # Story 10.0: docs-only.yml provides "test" status for docs-only changes
    paths:
      - 'src/**'
      - 'tests/**'
      - 'functions/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'vitest.config*.ts'
      - 'tsconfig*.json'
      - 'firebase.json'
      - 'firestore.rules'
      - 'storage.rules'
      - '.github/workflows/**'
      - '!.github/workflows/docs-only.yml'  # Exclude docs-only workflow
      - 'playwright.config.ts'
      - 'eslint.config*.mjs'
      - '.gitleaks.toml'  # Security config changes should trigger CI
      - 'docs/team-standards.md'  # Team standards changes should trigger CI
  pull_request:
    branches: [ main, staging, develop ]
    # Same path filtering for PRs
    paths:
      - 'src/**'
      - 'tests/**'
      - 'functions/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'vitest.config*.ts'
      - 'tsconfig*.json'
      - 'firebase.json'
      - 'firestore.rules'
      - 'storage.rules'
      - '.github/workflows/**'
      - '!.github/workflows/docs-only.yml'  # Exclude docs-only workflow
      - 'playwright.config.ts'
      - 'eslint.config*.mjs'
      - '.gitleaks.toml'  # Security config changes should trigger CI
      - 'docs/team-standards.md'  # Team standards changes should trigger CI
  # Story 8.9 AC4: Manual workflow dispatch for redeployments without empty commits
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests and deploy directly (use with caution)'
        type: boolean
        default: false
      reason:
        description: 'Reason for manual trigger (e.g., secret rotation)'
        type: string
        required: false

# ============================================================================
# Story 8.9: CI/CD Pipeline Optimization (v3 - January 2025)
# Story 9.15: Added path filtering to skip CI for docs-only changes
# Story 14.22: Further parallelization - gitleaks runs alongside setup
# Story 14.30: Unit test sharding to prevent timeout (3000+ tests)
# Story 14.30.1: Coverage merged from shards (removed duplicate test run)
# Story 14.30.2: Expanded to 5 shards for better balance (~3 min each)
# Story 14.30.3: Bun package installation (10-20x faster than npm ci)
# Story 14.30.6: Heavy test isolation (4 large files in dedicated jobs)
#
# Job dependency graph:
#   gitleaks (parallel) ────────────────────────────────────────────────────┐
#   setup ─┬─► test-unit-1 ─────────┬                                       │
#          ├─► test-unit-2 ─────────┤                                       │
#          ├─► test-unit-3 ─────────┼─► merge-coverage ─► test-unit ─┬─► test ─┴─► deploy
#          ├─► test-unit-4 ─────────┤       (PR only)                │
#          ├─► test-unit-5 ─────────┤                                │
#          ├─► test-unit-heavy-1 ───┤  (useScanStateMachine, Nav)    │
#          ├─► test-unit-heavy-2 ───┤  (insightEngine, generators)   │
#          ├─► test-integration ─────────────────────────────────────┤
#          ├─► test-e2e ─────────────────────────────────────────────┤
#          ├─► security ─────────────────────────────────────────────┘
#          └─► lighthouse (main push only, runs in parallel)
#
# Key optimizations (v4 - Story 14.30):
# - AC1: Parallel test jobs (unit, integration, e2e run concurrently)
# - AC2: Playwright browser caching (~30s saved)
# - AC3: Lighthouse only on main branch pushes (~4.5 min saved on PRs)
# - AC4: workflow_dispatch for manual deployments
# - 14.30.1: Coverage collected from shards, merged in single job (saves 14 min)
# - 14.30.2: 5 balanced shards (~3 min each vs 9/15/1.3 min imbalance)
# - 14.30.3: Bun install instead of npm ci (~30-60s saved)
# - 14.30.6: Heavy test isolation (4 large files in dedicated jobs for predictable timing)
# - Java JDK caching (~15-20s saved per job)
# - Firebase emulator JAR caching (~10-15s saved per job)
# - Faster emulator startup (30s max wait vs 60s)
# - Path filtering skips CI for docs/README changes (~5 min saved)
# - Gitleaks runs in parallel with setup (~30-60s saved)
#
# Target: ~6-8 min total (down from ~15-20 min)
# ============================================================================

jobs:
  # ============================================================================
  # GITLEAKS JOB - Runs in parallel with setup (Story 14.22 optimization)
  # Separated from setup to reduce critical path by ~30-60s
  # ============================================================================
  gitleaks:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for gitleaks

      - name: Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # SETUP JOB - Shared setup and caching for all test jobs
  # ============================================================================
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      playwright-cache-hit: ${{ steps.playwright-cache.outputs.cache-hit }}
      java-cache-hit: ${{ steps.java-cache.outputs.cache-hit }}

    steps:
      # Step 1: Checkout code (shallow clone - gitleaks handles full history)
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js 20 (LTS)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 3: Setup Bun (Story 14.30.3 - 10-20x faster package installation)
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Step 4: Cache bun dependencies for faster builds
      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # Step 5: Install dependencies with Bun (10-20x faster than npm ci)
      # Note: Use bun install (not --frozen-lockfile) since bun.lock may not exist
      # Bun will still respect package-lock.json for version resolution
      - name: Install dependencies
        run: bun install

      # Step 6: Cache Playwright browsers (Story 8.9 AC2)
      # Saves ~29s on subsequent runs
      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # Step 7: Install Playwright browsers (skip if cached)
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      # Step 8: Install Playwright system deps (always needed even with cached browsers)
      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      # Step 9: Setup Java 21 with caching (saves ~15-20s per job)
      - name: Setup Java 21
        id: java-cache
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Step 10: Cache Firebase emulator JARs (saves ~10-15s per job)
      - name: Cache Firebase emulator JARs
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      # Step 11: Install Firebase CLI globally
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Step 12: Pre-download Firebase emulator JARs (if not cached)
      - name: Pre-download Firebase emulators
        run: |
          firebase setup:emulators:firestore
          firebase setup:emulators:storage
        continue-on-error: true

      # Step 13: Build Cloud Functions (needed by multiple jobs)
      # Uses Bun for install, npm for build scripts (compatibility)
      - name: Install and build Cloud Functions
        run: |
          cd functions
          bun install
          npm run build
          cd ..

      # Step 14: Cache workspace for parallel jobs
      - name: Cache workspace for parallel jobs
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

  # ============================================================================
  # TEST-UNIT SHARDS - Unit tests split across 5 parallel runners (Story 14.30.2)
  # Each shard runs ~1/5 of unit tests using Vitest's built-in sharding
  # 5 shards provide better balance than 3 (was: 9/15/1.3 min -> now: ~3 min each)
  # Each shard also collects coverage data for merging (Story 14.30.1)
  # ============================================================================
  test-unit-1:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run unit tests (shard 1/5)
        run: node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run --config vitest.config.ci.ts --shard=1/5 --coverage
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

      - name: Upload coverage artifact (shard 1)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-shard-1
          path: coverage/coverage-final.json
          retention-days: 1

  test-unit-2:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run unit tests (shard 2/5)
        run: node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run --config vitest.config.ci.ts --shard=2/5 --coverage
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

      - name: Upload coverage artifact (shard 2)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-shard-2
          path: coverage/coverage-final.json
          retention-days: 1

  test-unit-3:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run unit tests (shard 3/5)
        run: node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run --config vitest.config.ci.ts --shard=3/5 --coverage
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

      - name: Upload coverage artifact (shard 3)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-shard-3
          path: coverage/coverage-final.json
          retention-days: 1

  test-unit-4:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run unit tests (shard 4/5)
        run: node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run --config vitest.config.ci.ts --shard=4/5 --coverage
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

      - name: Upload coverage artifact (shard 4)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-shard-4
          path: coverage/coverage-final.json
          retention-days: 1

  test-unit-5:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run unit tests (shard 5/5)
        run: node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run --config vitest.config.ci.ts --shard=5/5 --coverage
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

      - name: Upload coverage artifact (shard 5)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-shard-5
          path: coverage/coverage-final.json
          retention-days: 1

  # ============================================================================
  # HEAVY TEST JOBS - Dedicated jobs for large test files (Story 14.30.6)
  # These 4 files are 1400-1700 lines each and cause shard imbalance
  # Running them in dedicated jobs ensures predictable ~3-5 min timing
  # ============================================================================
  test-unit-heavy-1:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run heavy unit tests (useScanStateMachine + Nav)
        run: |
          node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run \
            --config vitest.config.heavy.ts \
            --shard=1/2 \
            --coverage
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

      - name: Upload coverage artifact (heavy-1)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-heavy-1
          path: coverage/coverage-final.json
          retention-days: 1

  test-unit-heavy-2:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run heavy unit tests (insightEngineService + insightGenerators)
        run: |
          node --max-old-space-size=4096 node_modules/vitest/vitest.mjs run \
            --config vitest.config.heavy.ts \
            --shard=2/2 \
            --coverage
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id

      - name: Upload coverage artifact (heavy-2)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-heavy-2
          path: coverage/coverage-final.json
          retention-days: 1

  # ============================================================================
  # TEST-UNIT SUMMARY - Aggregates all shard and heavy test results
  # ============================================================================
  test-unit:
    needs: [test-unit-1, test-unit-2, test-unit-3, test-unit-4, test-unit-5, test-unit-heavy-1, test-unit-heavy-2]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all unit test shards
        run: |
          if [ "${{ needs.test-unit-1.result }}" != "success" ] || \
             [ "${{ needs.test-unit-2.result }}" != "success" ] || \
             [ "${{ needs.test-unit-3.result }}" != "success" ] || \
             [ "${{ needs.test-unit-4.result }}" != "success" ] || \
             [ "${{ needs.test-unit-5.result }}" != "success" ] || \
             [ "${{ needs.test-unit-heavy-1.result }}" != "success" ] || \
             [ "${{ needs.test-unit-heavy-2.result }}" != "success" ]; then
            echo "One or more unit test shards failed"
            echo "Shard 1: ${{ needs.test-unit-1.result }}"
            echo "Shard 2: ${{ needs.test-unit-2.result }}"
            echo "Shard 3: ${{ needs.test-unit-3.result }}"
            echo "Shard 4: ${{ needs.test-unit-4.result }}"
            echo "Shard 5: ${{ needs.test-unit-5.result }}"
            echo "Heavy 1: ${{ needs.test-unit-heavy-1.result }}"
            echo "Heavy 2: ${{ needs.test-unit-heavy-2.result }}"
            exit 1
          fi
          echo "All 7 unit test jobs passed successfully (5 shards + 2 heavy)"

  # ============================================================================
  # MERGE-COVERAGE JOB - Merges coverage from all shards (Story 14.30.1)
  # Replaces the old test-coverage job that ran all tests again (+14 min waste)
  # Now merges coverage-final.json from each shard + heavy jobs - no duplicate test run
  # ============================================================================
  merge-coverage:
    needs: [test-unit-1, test-unit-2, test-unit-3, test-unit-4, test-unit-5, test-unit-heavy-1, test-unit-heavy-2]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Only run on PRs - coverage report is informational, not a gate
    if: github.event_name == 'pull_request'
    continue-on-error: true  # Don't block merge on coverage failures

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-shards/

      - name: Merge coverage reports
        run: |
          mkdir -p coverage
          # Install nyc for coverage merging
          npm install -g nyc
          # List downloaded coverage files
          echo "Downloaded coverage files:"
          find coverage-shards -name "*.json" -type f
          # Merge all coverage-final.json files into one
          npx nyc merge coverage-shards coverage/coverage-final.json
          # Generate summary from merged coverage
          npx nyc report --reporter=json-summary --temp-dir=coverage -o coverage
          echo "Merged coverage report generated"

      - name: Upload merged coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-merged
          path: coverage/
          retention-days: 30

      - name: Post coverage report to PR
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          json-summary-path: './coverage/coverage-summary.json'
          json-final-path: './coverage/coverage-final.json'
          vite-config-path: './vite.config.ts'
          file-coverage-mode: 'all'
          name: 'Coverage Report (Merged from 5 shards)'

  # ============================================================================
  # TEST-INTEGRATION JOB - Integration tests (Story 8.9 AC1)
  # ============================================================================
  test-integration:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Install Firebase CLI (required for emulators)
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators..."
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Run integration tests
        run: npm run test:integration
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

  # ============================================================================
  # TEST-E2E JOB - End-to-end tests (Story 8.9 AC1)
  # ============================================================================
  test-e2e:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Install Firebase CLI (required for emulators)
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Restore cached Playwright browsers
      - name: Restore Playwright cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # Install Playwright system dependencies (always needed)
      - name: Install Playwright dependencies
        run: npx playwright install-deps chromium

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators..."
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Create test user in Firebase Auth emulator
        run: npx tsx scripts/create-test-user.ts
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

  # ============================================================================
  # SECURITY JOB - Security checks (bundle size, audit, lint)
  # ============================================================================
  security:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_tests) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Bundle size check
      - name: Check bundle size
        run: |
          npm run build
          BUNDLE_SIZE=$(du -sk dist/assets/*.js | awk '{total += $1} END {print total}')
          echo "Bundle size: ${BUNDLE_SIZE}KB"
          if [ "$BUNDLE_SIZE" -gt 700 ]; then
            echo "WARNING: Bundle size exceeds threshold (${BUNDLE_SIZE}KB > 700KB)"
            echo "Consider code splitting or removing unused dependencies"
          else
            echo "Bundle size within acceptable range"
          fi
        env:
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      # npm audit - only check production dependencies (dev deps have known issues in transitive packages)
      - name: Run npm audit
        run: |
          echo "Scanning production dependencies for vulnerabilities..."
          npm audit --audit-level=high --omit=dev || echo "::warning::Some HIGH vulnerabilities found in dev dependencies (acceptable)"
          echo "Production dependency audit complete"

      # Security lint
      - name: Run security lint
        run: |
          echo "Running security-focused static analysis..."
          npx eslint -c eslint.config.security.mjs src/
          echo "Security lint passed"

  # ============================================================================
  # LIGHTHOUSE JOB - Performance audits (Story 8.9 AC3)
  # Only runs on push to main branch to save ~4.5 min on PRs
  # ============================================================================
  lighthouse:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Story 8.9 AC3: Only run Lighthouse on main branch pushes
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore workspace cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            functions/node_modules
            functions/lib
          key: ${{ runner.os }}-workspace-${{ github.sha }}

      # Install Firebase CLI (required for emulators)
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Restore Playwright cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright dependencies
        run: npx playwright install-deps chromium

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase emulator cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-v1
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project boletapp-d609f &
          echo "Waiting for Firebase emulators..."
          for i in {1..30}; do
            if curl -sf http://localhost:4000 > /dev/null && curl -sf http://localhost:8080 > /dev/null; then
              echo "Firebase emulators ready in ${i}s!"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Create test user for Lighthouse
        run: npx tsx scripts/create-test-user.ts
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080

      - name: Run Lighthouse performance audits
        run: npm run test:lighthouse
        continue-on-error: true  # Warn mode - don't fail CI on score drops
        env:
          CI: true
          VITE_FIREBASE_API_KEY: test-api-key
          VITE_FIREBASE_AUTH_DOMAIN: test-project.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: boletapp-d609f
          VITE_FIREBASE_STORAGE_BUCKET: test-project.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: "123456789"
          VITE_FIREBASE_APP_ID: 1:123456789:web:test-app-id
          VITE_GEMINI_API_KEY: test-gemini-key
          VITE_GEMINI_MODEL: gemini-2.5-flash-preview-09-2025

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: lighthouse-reports/
          retention-days: 90

  # ============================================================================
  # TEST SUMMARY JOB - Required for branch protection compatibility
  # This job aggregates all test results into a single status check named "test"
  # ============================================================================
  test:
    name: test
    needs: [gitleaks, test-unit, test-integration, test-e2e, security]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all test results
        run: |
          if [ "${{ needs.gitleaks.result }}" != "success" ] || \
             [ "${{ needs.test-unit.result }}" != "success" ] || \
             [ "${{ needs.test-integration.result }}" != "success" ] || \
             [ "${{ needs.test-e2e.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "All test jobs passed successfully"

  # ============================================================================
  # DEPLOYMENT JOB - Story 6.0: CI/CD Auto-Deploy to Firebase
  # ============================================================================
  deploy:
    name: Deploy to Firebase Hosting
    needs: [test]
    runs-on: ubuntu-latest
    # Deploy on push to main OR manual workflow_dispatch
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Build for production
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_VAPID_KEY: ${{ secrets.VITE_FIREBASE_VAPID_KEY }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
          VITE_GEMINI_MODEL: ${{ secrets.VITE_GEMINI_MODEL }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: boletapp-d609f

      - name: Deployment complete
        run: |
          echo "Deployment successful!"
          echo "Production URL: https://boletapp-d609f.web.app"
          echo "Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Trigger: Manual workflow dispatch"
            echo "Reason: ${{ inputs.reason || 'Not specified' }}"
          fi
