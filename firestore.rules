rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================================================
    // Transaction Access - Owner Only
    // Simplified after Epic 14c-refactor: Cross-user shared group access removed
    // ============================================================================
    match /artifacts/{appId}/users/{userId}/transactions/{transactionId} {
      // Owner can read and write their own transactions
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ============================================================================
    // Collection Group Query - Denied
    // Client-side collection group queries disabled for security (2026-01-17)
    // ============================================================================
    match /{path=**}/transactions/{transactionId} {
      allow read: if false;
    }

    // ============================================================================
    // User Data Isolation
    // Each user can only access their own data (all subcollections)
    // ============================================================================
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }


    // ============================================================================
    // Default Deny - All other paths
    // ============================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
